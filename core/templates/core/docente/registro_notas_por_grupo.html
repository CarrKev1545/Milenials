{% extends "core/base_dashboard_docente.html" %}
{% load static %}

{% block title %}Registro de notas — Tabla{% endblock %}

{% block extra_css %}
<style>
  /* ===== Escala base rem + ajustes fluidos ===== */
  :root { font-size: 16px; } /* 1rem = 16px */
  @media (max-width: 75em) { :root { font-size: 15px; } }
  @media (max-width: 62em) { :root { font-size: 14px; } }
  @media (max-width: 48em) { :root { font-size: 13px; } }
  @media (max-width: 36em) { :root { font-size: 12px; } }

  .page-title{
    position:sticky; top:var(--navbar-height); z-index:40;
    background:var(--accent); color:#fff; font-weight:800; letter-spacing:.0125em;
    text-align:center; padding:.625rem .75rem; box-shadow:0 .25rem .75rem rgba(0,0,0,.35)
  }

  .rg{width:100%;max-width:73.75rem;margin:0 auto;padding:0 1.25rem}
  .rg-wrap{position:relative;margin-top:.875rem}
  .rg-wrap::before{
    content:""; position:absolute; inset:-1.125rem -1.375rem; border-radius:1.125rem;
    background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10); backdrop-filter: blur(.375rem) saturate(115%);
    box-shadow:0 1.375rem 2.75rem rgba(0,0,0,.50); z-index:0
  }
  .rg-inner{position:relative;z-index:1;padding:1.75rem 1.5rem 1.5rem}
  .rg-badge{width:23.125rem;max-width:90vw;margin:0 auto;margin-top:-1.375rem;background:#0c0c0c;border-radius:1rem;
    box-shadow:0 1rem 1.875rem rgba(0,0,0,.55), inset 0 -.5rem 1.375rem rgba(0,0,0,.22);
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.125rem 1rem .75rem}
  .rg-badge i{font-size:5.125rem;color:#fff;filter:drop-shadow(0 .625rem 1.875rem rgba(0,0,0,.6))}
  .rg-chip{margin-top:.75rem;background:var(--accent);color:#fff;padding:.5rem 1.125rem;border-radius:999px;font-weight:800;letter-spacing:.0125em}

  :root{ --panel-dark:#0f172a; --panel-darker:#0b1220; }
  .meta-tags{display:flex;flex-wrap:wrap;gap:.625rem;margin:1rem .125rem .625rem}
  .meta-tag{
    background:linear-gradient(180deg,var(--panel-dark),var(--panel-darker));
    color:#fff;border:1px solid rgba(255,255,255,.08);
    padding:.5rem .75rem;border-radius:.75rem;font-weight:900;letter-spacing:.0125em;
    box-shadow:0 .5rem 1rem rgba(0,0,0,.28)
  }

  .table-card{
    background:#fff;border-radius:1rem;box-shadow:0 .75rem 1.875rem rgba(0,0,0,.18);
    border:1px solid #e5e9f2; overflow:hidden
  }
  .table-responsive{width:100%;max-height:28.75rem;overflow:auto;background:#eef2f6}
  .table-responsive::-webkit-scrollbar{height:.625rem;width:.625rem}
  .table-responsive::-webkit-scrollbar-thumb{background:#9aa4b2;border-radius:999px}
  .table-responsive::-webkit-scrollbar-track{background:#e6ebf3;border-radius:999px}

  table.tabla{width:100%;border-collapse:separate;border-spacing:0 .625rem}
  .tabla thead th{
    position:sticky; top:0; z-index:4;
    background:linear-gradient(180deg,var(--panel-dark),var(--panel-darker));
    color:#fff;font-weight:900;text-transform:uppercase;letter-spacing:.02em;
    text-align:left;padding:.875rem 1rem; box-shadow:0 .25rem 0 rgba(255,255,255,.04)
  }
  .tabla th:nth-child(1){width:42%}
  .tabla th:nth-child(2){width:16%}
  .tabla th:nth-child(3){width:16%}
  .tabla th:nth-child(4){width:10%}
  .tabla th:nth-child(5){width:16%}

  .tabla tbody td{
    background:#fff; color:#0b1220; border:1px solid #e6ebf3;
    padding:.875rem 1rem; vertical-align:middle;
    transition: filter .12s ease, box-shadow .12s ease, background .12s ease
  }
  .tabla tbody tr td:first-child{border-top-left-radius:.75rem;border-bottom-left-radius:.75rem;border-left-width:1px}
  .tabla tbody tr td:last-child {border-top-right-radius:.75rem;border-bottom-right-radius:.75rem;border-right-width:1px}
  .tabla tbody tr:hover td{filter:saturate(110%); box-shadow:0 .5rem 1.125rem rgba(2,6,23,.08); background:#fff}

  .tabla thead th:first-child{left:0; z-index:5}
  .tabla tbody td:first-child{position:sticky; left:0; z-index:3; background:#fff; box-shadow:.0625rem 0 0 #e6ebf3}

  .alum{font-weight:900;letter-spacing:.0125em}
  .doc{opacity:.9;font-weight:800;font-variant-numeric:tabular-nums;
       font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .inp-nota, .inp-fallas{
    width:7.375rem; height:2.5rem; border:1px solid #cfd8dc; border-radius:.625rem; background:#f8fafc;
    padding:0 .625rem; font-weight:800; text-align:center; font-variant-numeric:tabular-nums; letter-spacing:.0125em;
    transition:border-color .12s ease, box-shadow .12s ease, background .12s ease
  }
  .inp-fallas{width:6rem}
  .inp-nota:focus, .inp-fallas:focus{
    outline:none; border-color: var(--accent);
    box-shadow:0 0 0 .1875rem color-mix(in srgb, var(--accent) 25%, transparent); background:#fff
  }
  .inp-nota::-webkit-outer-spin-button,
  .inp-nota::-webkit-inner-spin-button,
  .inp-fallas::-webkit-outer-spin-button,
  .inp-fallas::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }

  /* Botón principal */
  .rg-btn{
    height:2.5rem; min-width:8.25rem; border-radius:.625rem;
    background:var(--accent); color:#fff; border:0;
    box-shadow:0 .75rem 1.375rem color-mix(in srgb, var(--accent) 28%, transparent);
    font-weight:900; letter-spacing:.0125em; padding:0 1rem; cursor:pointer
  }
  .rg-btn:hover{transform:translateY(-.0625rem)}
  .rg-btn:disabled{opacity:.55;box-shadow:none;cursor:not-allowed}
  .rg-btn--ghost{background:transparent; color:var(--accent); border:1px solid var(--accent)}

  .tabla td.actions{position:relative}
  .tabla .save-status{position:absolute; right:.625rem; top:50%; transform:translateY(-50%); font-size:.86rem; font-weight:800; color:#059669}

  .msg{display:grid; place-items:center; height:5.125rem; color:#334155; font-weight:800}
  .dirty{outline:2px solid color-mix(in srgb, var(--accent) 45%, transparent)}
  @media (max-width: 56.25em){
    .tabla th:nth-child(2), .tabla td:nth-child(2){display:none}
    .tabla th:nth-child(1){width:auto}
  }
</style>
{% endblock %}

{% block content %}
  <div class="page-title">Registro de notas</div>

  <main class="main" role="main">
    <section class="rg" aria-label="Registro por grupo">
      <div class="rg-wrap">
        <div class="rg-inner">
          <div class="rg-badge" aria-hidden="true">
            <i class="fa-solid fa-clipboard-list"></i>
            <div class="rg-chip">TABLA</div>
          </div>

          <!-- Resumen como chips -->
          <div id="resumen-tags" class="meta-tags"></div>

          <div class="table-card">
            <div class="table-responsive">
              <table class="tabla" id="tabla-estudiantes" aria-label="Tabla de estudiantes del grupo">
                <thead>
                  <tr>
                    <th>Estudiante</th>
                    <th>Documento</th>
                    <th>Nota (1.00–5.00)</th>
                    <th>Fallas</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5"><div class="msg">Cargando…</div></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="rg-actions" style="margin-top:1rem; display:flex; gap:.75rem; align-items:center">
            <button type="button" id="btn-guardar-todo" class="rg-btn">Guardar</button>
            <span id="progreso" class="doc" style="opacity:.8"></span>
            <a href="{% url 'docente_registro_notas_filtro' %}" class="rg-btn rg-btn--ghost">Volver a filtros</a>
          </div>
        </div>
      </div>
    </section>
  </main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  /* ========= LECTURA DE PARÁMETROS ========= */
  const qs = new URLSearchParams(window.location.search);
  const sede_id       = qs.get("sede_id");
  const grado_id      = qs.get("grado_id");
  const grupo_id      = qs.get("grupo_id");
  const area_id       = qs.get("area_id");
  const asignatura_id = qs.get("asignatura_id");
  const periodo_id    = qs.get("periodo_id");

  if (!grupo_id || !asignatura_id || !periodo_id) {
    window.location.href = "{% url 'docente_registro_notas_filtro' %}";
  }

  /* ========= Helpers ========= */
  async function j(url){
    try{
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if (!r.ok) return {__error__: true, status: r.status, url};
      return await r.json();
    }catch(e){
      return {__error__: true, err: String(e), url};
    }
  }

  const $tags = document.getElementById("resumen-tags");
  function addTag(label, value){
    const s = document.createElement("span");
    s.className = "meta-tag";
    s.textContent = `${label}: ${value}`;
    $tags.appendChild(s);
  }

  /* ========= Resumen (nombres) ========= */
  (async () => {
    const pj = await j("{% url 'api_docente_periodos_abiertos' %}");
    const per = (pj?.periodos || []).find(x => String(x.id) === String(periodo_id));
    addTag("Periodo", per?.nombre || periodo_id);

    if (sede_id){
      const sj = await j("{% url 'api_docente_sedes' %}");
      const sede = (sj?.sedes || []).find(x => String(x.id) === String(sede_id));
      addTag("Sede", sede?.nombre || sede_id);
    }
    if (grado_id && sede_id){
      const gj = await j("{% url 'api_docente_grados_por_sede' %}?sede_id=" + encodeURIComponent(sede_id));
      const grado = (gj?.grados || []).find(x => String(x.id) === String(grado_id));
      addTag("Grado", grado?.nombre || grado_id);
    }
    if (sede_id && grado_id){
      const grj = await j("{% url 'api_docente_grupos_por_sede_grado' %}?sede_id=" + encodeURIComponent(sede_id) + "&grado_id=" + encodeURIComponent(grado_id));
      const grupo = (grj?.grupos || []).find(x => String(x.id) === String(grupo_id));
      addTag("Grupo", grupo?.nombre || grupo_id);
    }
    if (area_id && grupo_id){
      const aj = await j("{% url 'api_docente_areas_por_grupo' %}?grupo_id=" + encodeURIComponent(grupo_id));
      const area = (aj?.areas || []).find(x => String(x.id) === String(area_id));
      addTag("Área", area?.nombre || area_id);
    }
    if (grupo_id && area_id){
      const asj = await j("{% url 'api_docente_asignaturas_por_grupo_area' %}?grupo_id=" + encodeURIComponent(grupo_id) + "&area_id=" + encodeURIComponent(area_id));
      const asig = (asj?.asignaturas || []).find(x => String(x.id) === String(asignatura_id));
      addTag("Asignatura", asig?.nombre || asignatura_id);
    }
  })();

  /* ========= CSRF ========= */
  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`); if (v.length === 2) return v.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  /* ========= Tabla: estudiantes + notas ========= */
  const $tbody = document.querySelector("#tabla-estudiantes tbody");
  const $btnGuardarTodo = document.getElementById("btn-guardar-todo");
  const $progreso = document.getElementById("progreso");

  function putMsg(text){
    $tbody.innerHTML = `<tr><td colspan="5" style="padding:1.25rem"><div class="msg">${text}</div></td></tr>`;
  }

  function markDirty(input){
    const saved = input.getAttribute("data-saved-value") ?? "";
    if (String(saved) !== String(input.value)) input.classList.add("dirty");
    else input.classList.remove("dirty");
  }

  async function cargarTabla(){
    putMsg("Cargando…");

    const estResp = await j("{% url 'api_docente_estudiantes_por_grupo' %}?grupo_id=" + encodeURIComponent(grupo_id));
    if (estResp.__error__) { putMsg("No se pudieron cargar los estudiantes ("+(estResp.status||estResp.err||"")+")"); return; }
    const estudiantes = estResp.estudiantes || [];

    let notasMap = new Map();
    const notasUrl = "{% url 'api_docente_notas_por_grupo_asignatura_periodo' %}?grupo_id=" + encodeURIComponent(grupo_id) +
                     "&asignatura_id=" + encodeURIComponent(asignatura_id) +
                     "&periodo_id=" + encodeURIComponent(periodo_id);
    const notasResp = await j(notasUrl);
    if (!notasResp.__error__){
      const notas = notasResp.notas || [];
      notas.forEach(n => notasMap.set(String(n.estudiante_id), n));
    }

    $tbody.innerHTML = "";
    if (!estudiantes.length){
      putMsg("No hay estudiantes en este grupo.");
      return;
    }

    for (const e of estudiantes){
      const n = notasMap.get(String(e.id)) || {};
      const nota   = (n.nota   != null) ? Number(n.nota).toFixed(2) : "";
      const fallas = (n.fallas != null) ? String(n.fallas) : "0";

      const tr = document.createElement("tr");
      tr.setAttribute("data-row-estudiante", e.id);
      tr.setAttribute("data-asignatura-id",  asignatura_id);
      tr.setAttribute("data-periodo-id",     periodo_id);

      tr.innerHTML = `
        <td class="alum"><span>${(e.apellidos ?? "").toUpperCase()}</span>${e.apellidos ? ", " : ""}${(e.nombre ?? "").toUpperCase()}</td>
        <td class="doc">${e.documento ?? ""}</td>
        <td><input class="inp-nota"   type="number" min="1" max="5" step="0.01" value="${nota}"   data-saved-value="${nota}"></td>
        <td><input class="inp-fallas" type="number" min="0" step="1"    value="${fallas}" data-saved-value="${fallas}"></td>
        <td class="actions"><span class="save-status"></span></td>
      `;
      $tbody.appendChild(tr);
    }

    // Detectar cambios
    $tbody.querySelectorAll('.inp-nota, .inp-fallas').forEach(inp=>{
      inp.addEventListener('input', ()=> markDirty(inp));
    });
  }

  document.addEventListener("DOMContentLoaded", cargarTabla);

  /* ========= Guardar en lote (un solo click) ========= */
 async function guardarFila(tr){
  const estudiante_id = tr.getAttribute("data-row-estudiante");
  const asignatura_id = tr.getAttribute("data-asignatura-id");
  const periodo_id    = tr.getAttribute("data-periodo-id");
  const inpNota   = tr.querySelector(".inp-nota");
  const inpFallas = tr.querySelector(".inp-fallas");
  const statusEl  = tr.querySelector(".save-status");

  let nota   = (inpNota.value || "").trim();
  nota = nota.replace(',', '.'); // <-- normaliza coma a punto
  const fallas = (inpFallas.value || "0").trim();

  // Validación rápida cliente
  if (nota !== "") {
    const v = Number(nota);
    if (Number.isNaN(v) || v < 1 || v > 5) {
      statusEl.style.color = "#dc2626";
      statusEl.textContent = "Nota inválida (1–5)";
      inpNota.classList.add("dirty");
      return { ok:false };
    }
  }

  // Evitar requests si no hubo cambios
  const changed = (nota !== (inpNota.getAttribute("data-saved-value") ?? "")) ||
                  (fallas !== (inpFallas.getAttribute("data-saved-value") ?? "0"));
  if (!changed) return { ok:true, skipped:true };

  statusEl.style.color = "";
  statusEl.textContent = "Guardando…";
  inpNota.disabled = true; inpFallas.disabled = true;

  try{
    const resp = await fetch("{% url 'docente_registrar_nota' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken,
        "Accept": "application/json",
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
      },
      body: new URLSearchParams({ estudiante_id, asignatura_id, periodo_id, nota, fallas })
    });

    // Intenta leer el JSON; si no es JSON, arma uno básico con el status
    let data = {};
    try { data = await resp.json(); } catch { data = {}; }

    if (!resp.ok || !data.ok){
      const msg = (data && data.msg) ? data.msg : `Error ${resp.status}`;
      statusEl.style.color = "#dc2626";
      statusEl.textContent = msg;        // <-- AHORA SE VE EL MOTIVO
      inpNota.classList.add("dirty");    // borde para llamar la atención
      return { ok:false, msg };
    }

    // Éxito
    inpNota.setAttribute("data-saved-value", nota);
    inpFallas.setAttribute("data-saved-value", fallas);
    inpNota.classList.remove("dirty");
    inpFallas.classList.remove("dirty");
    statusEl.style.color = "#059669";
    statusEl.textContent = "Guardado ✓";
    return { ok:true };

  }catch(err){
    statusEl.style.color = "#dc2626";
    statusEl.textContent = String(err);
    return { ok:false, err };
  }finally{
    inpNota.disabled = false; inpFallas.disabled = false;
    setTimeout(()=> { if (statusEl.textContent === "Guardado ✓") statusEl.textContent = ""; }, 2200);
  }
}


  async function guardarTodo(){
    const filas = Array.from($tbody.querySelectorAll('tr[data-row-estudiante]'));
    if (!filas.length) return;

    $btnGuardarTodo.disabled = true;
    $progreso.textContent = `0 / ${filas.length}`;

    let ok = 0, skipped = 0, fail = 0;

    // Secuencial (evita saturar servidor; mantiene lógica actual)
    for (let i=0; i<filas.length; i++){
      const r = await guardarFila(filas[i]);
      if (r?.ok && r?.skipped) skipped++;
      else if (r?.ok) ok++;
      else fail++;
      $progreso.textContent = `${i+1} / ${filas.length}`;
    }

    // Resumen
    if (fail === 0){
      $progreso.textContent = `Listo: ${ok} guardadas${skipped?` • ${skipped} sin cambios`:''}`;
      setTimeout(()=> $progreso.textContent = "", 2500);
    }else{
      $progreso.textContent = `Completado con errores: ${ok} OK, ${fail} fallas`;
    }

    $btnGuardarTodo.disabled = false;
  }

  $btnGuardarTodo.addEventListener('click', guardarTodo);

  // Ctrl/Cmd + S => Guardar todo
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      guardarTodo();
    }
  });

  // Aviso al salir si hay cambios sin guardar
  window.addEventListener('beforeunload', (e)=>{
    const dirty = document.querySelector('.inp-nota.dirty, .inp-fallas.dirty');
    if (dirty){
      e.preventDefault(); e.returnValue = '';
    }
  });
</script>
{% endblock %}
