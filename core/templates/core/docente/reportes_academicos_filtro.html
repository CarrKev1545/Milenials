{% extends "core/base_dashboard_docente.html" %}
{% load static %}

{% block title %}Reportes académicos — Filtros{% endblock %}

{% block extra_css %}
<style>
  .page-title{position:sticky;top:var(--navbar-height);z-index:40;background:var(--accent);color:#fff;font-weight:800;letter-spacing:.2px;text-align:center;padding:10px 12px;box-shadow:0 4px 12px rgba(0,0,0,.35)}
  .rg{width:100%;max-width:1180px;margin:0 auto;padding:0 20px}
  .rg-wrap{position:relative;margin-top:14px}
  .rg-wrap::before{content:"";position:absolute;inset:-18px -22px;border-radius:18px;background:
    radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
    linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10);backdrop-filter: blur(6px) saturate(115%);
    box-shadow:0 22px 44px rgba(0,0,0,.50);z-index:0}
  .rg-inner{position:relative;z-index:1;padding:28px 24px 24px}
  .rg-badge{width:370px;max-width:90vw;margin:0 auto;margin-top:-22px;background:#0c0c0c;border-radius:16px;
    box-shadow:0 16px 30px rgba(0,0,0,.55), inset 0 -8px 22px rgba(0,0,0,.22);
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px 16px 12px}
  .rg-badge i{font-size:82px;color:#fff;filter:drop-shadow(0 10px 30px rgba(0,0,0,.6))}
  .rg-chip{margin-top:12px;background:var(--accent);color:#fff;padding:8px 18px;border-radius:999px;font-weight:800;letter-spacing:.2px}

  .rg-grid{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:14px 20px;align-items:center}
  .rg-field{position:relative;display:flex;align-items:center;gap:10px;height:48px;padding:0 14px 0 50px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 20px rgba(0,0,0,.22);width:100%}
  .rg-field select{appearance:none;width:100%;border:none;outline:none;background:transparent;color:#111;font-weight:600}
  .rg-ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:26px;display:grid;place-items:center;color:#111;opacity:.95}
  .rg-caret{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#111;opacity:.85}
  .rg-actions{margin-top:18px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
  .rg-btn{height:48px;min-width:180px;border-radius:12px;border:none;cursor:pointer;font-weight:800;color:#fff;background:var(--accent);box-shadow:0 12px 22px rgba(156,15,16,.38)}
  .rg-btn--ghost{background:#b51415}
  .disabled{opacity:.55;pointer-events:none}
  @media (max-width:1020px){ .rg-grid{ grid-template-columns:1fr; } }
</style>
{% endblock %}

{% block content %}
  <div class="page-title">Reportes académicos</div>

  <main class="main" role="main">
    <section class="rg" aria-label="Filtros por grupo">
      <div class="rg-wrap">
        <div class="rg-inner">
          <div class="rg-badge" aria-hidden="true">
            <i class="fa-solid fa-file-lines"></i>
            <div class="rg-chip">POR GRUPO</div>
          </div>

          <form id="form-reporte" class="rg-grid" autocomplete="off" novalidate>
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-building-columns"></i></span>
              <select id="sede" name="sede_id" required>
                <option value="">Seleccione la sede</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-sitemap"></i></span>
              <select id="grado" name="grado_id" required disabled>
                <option value="">Seleccione el grado</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-people-roof"></i></span>
              <select id="grupo" name="grupo_id" required disabled>
                <option value="">Seleccione el grupo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-calendar-days"></i></span>
              <select id="periodo" name="periodo_id" required disabled>
                <option value="">Seleccione periodo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>
          </form>

          <div class="rg-actions">
            <button id="btn-buscar" type="button" class="rg-btn disabled" aria-disabled="true">Buscar</button>
            <button id="btn-limpiar" type="button" class="rg-btn rg-btn--ghost">Eliminar</button>
          </div>
        </div>
      </div>
    </section>
  </main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  const $sede = document.getElementById('sede');
  const $grado = document.getElementById('grado');
  const $grupo = document.getElementById('grupo');
  const $periodo = document.getElementById('periodo');
  const $buscar = document.getElementById('btn-buscar');

  const disable = ($el, yes=true)=>{ $el.disabled = yes; if (yes) $el.value = '' };
  const enableBuscarIfReady = ()=>{
    const ok = $sede.value && $grado.value && $grupo.value && $periodo.value;
    $buscar.classList.toggle('disabled', !ok);
    $buscar.setAttribute('aria-disabled', String(!ok));
  };

  // sedes
  fetch("{% url 'api_docente_sedes' %}").then(r=>r.json()).then(({sedes=[]})=>{
    sedes.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.nombre; $sede.appendChild(o); });
  });

  // sede -> grados + periodos
  $sede.addEventListener('change', async ()=>{
    disable($grado); disable($grupo); disable($periodo);
    $grado.innerHTML = '<option value="">Seleccione el grado</option>';
    $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
    $periodo.innerHTML = '<option value="">Seleccione periodo</option>';

    if(!$sede.value){ enableBuscarIfReady(); return; }

    const g = await fetch("{% url 'api_docente_grados_por_sede' %}?sede_id="+encodeURIComponent($sede.value)).then(r=>r.json());
    (g.grados||[]).forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent=it.nombre; $grado.appendChild(o); });
    disable($grado,false);

    const p = await fetch("{% url 'api_docente_periodos_abiertos' %}").then(r=>r.json());
    (p.periodos||[]).forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent=it.nombre; $periodo.appendChild(o); });
    disable($periodo,false);

    enableBuscarIfReady();
  });

  // grado -> grupos
  $grado.addEventListener('change', async ()=>{
    disable($grupo);
    $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
    if(!$sede.value || !$grado.value){ enableBuscarIfReady(); return; }
    const url = "{% url 'api_docente_grupos_por_sede_grado' %}?sede_id="+encodeURIComponent($sede.value)+"&grado_id="+encodeURIComponent($grado.value);
    const r = await fetch(url).then(r=>r.json());
    (r.grupos||[]).forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent=it.nombre; $grupo.appendChild(o); });
    disable($grupo,false);
    enableBuscarIfReady();
  });

  $periodo.addEventListener('change', enableBuscarIfReady);
  $grupo.addEventListener('change', enableBuscarIfReady);

  // Buscar -> por_grupo
  $buscar.addEventListener('click', ()=>{
    if ($buscar.classList.contains('disabled')) return;
    const params = new URLSearchParams(new FormData(document.getElementById('form-reporte')));
    window.location.href = "{% url 'docente_reportes_academicos_por_grupo' %}?" + params.toString();
  });

  // Limpiar
  document.getElementById('btn-limpiar').addEventListener('click', ()=>{
    document.getElementById('form-reporte').reset();
    [$grado,$grupo,$periodo].forEach(e=>{ e.innerHTML = e.querySelector('option').outerHTML; disable(e,true); });
    enableBuscarIfReady();
  });
</script>
{% endblock %}
