{% extends "core/base.html" %}
{% load static %}
{% block title %}Eliminar Estudiantes{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card shadow-sm mx-auto" style="max-width: 920px;">
    <div class="card-body">

      <h4 class="mb-3">Eliminar Estudiantes</h4>

      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form id="form-eliminar" method="post" action="{% url 'rector_eliminar_estudiante' %}">
        {% csrf_token %}

        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-6">
            <label class="form-label">Documento del estudiante</label>
            <input
              type="text"
              inputmode="numeric"
              pattern="[0-9]{5,20}"
              minlength="5"
              maxlength="20"
              class="form-control"
              id="inp-doc"
              name="documento"
              placeholder="Solo dígitos (5–20)"
              required
            >
            <div class="form-text">
              Escribe el documento y te mostraremos los datos antes de eliminar.
            </div>
          </div>

          <div class="col-12 col-md-6 d-flex gap-2">
            <button id="btn-preview" type="button" class="btn btn-outline-primary">
              Buscar
            </button>
            <button id="btn-limpiar" type="button" class="btn btn-outline-secondary">
              Limpiar
            </button>

            <!-- ÚNICO botón: envía el formulario cuando hay alumno -->
            <button id="btn-eliminar" type="submit" class="btn btn-danger ms-auto" disabled>
              Eliminar Estudiante
            </button>
          </div>
        </div>

        <!-- Resumen del estudiante -->
        <div id="preview" class="mt-4" style="display:none;">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="text-muted mb-3">Resumen del estudiante</h6>
              <div class="row">
                <div class="col-12 col-md-6">
                  <div><strong>Nombres:</strong> <span id="pv-nombres">-</span></div>
                  <div><strong>Apellidos:</strong> <span id="pv-apellidos">-</span></div>
                  <div><strong>Documento:</strong> <span id="pv-doc">-</span></div>
                </div>
                <div class="col-12 col-md-6">
                  <div><strong>Sede:</strong> <span id="pv-sede">-</span></div>
                  <div><strong>Grado:</strong> <span id="pv-grado">-</span></div>
                  <div><strong>Grupo:</strong> <span id="pv-grupo">-</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
(function () {
  const inp = document.getElementById('inp-doc');
  const btnPreview = document.getElementById('btn-preview');
  const btnLimpiar = document.getElementById('btn-limpiar');
  const btnEliminar = document.getElementById('btn-eliminar');

  const pv = document.getElementById('preview');
  const pvNom = document.getElementById('pv-nombres');
  const pvApe = document.getElementById('pv-apellidos');
  const pvDoc = document.getElementById('pv-doc');
  const pvSede = document.getElementById('pv-sede');
  const pvGrado = document.getElementById('pv-grado');
  const pvGrupo = document.getElementById('pv-grupo');

  function resetPreview() {
    pvNom.textContent = '-';
    pvApe.textContent = '-';
    pvDoc.textContent = '-';
    pvSede.textContent = '-';
    pvGrado.textContent = '-';
    pvGrupo.textContent = '-';
    pv.style.display = 'none';
    btnEliminar.disabled = true;
  }

  btnLimpiar.addEventListener('click', function () {
    inp.value = '';
    resetPreview();
    inp.focus();
  });

  async function buscar() {
    const doc = (inp.value || '').trim();
    if (!/^\d{5,20}$/.test(doc)) {
      resetPreview();
      alert('Documento inválido. Usa solo dígitos (5–20).');
      return;
    }
    try {
      btnPreview.disabled = true;
      // Usa la API de este módulo
      const res = await fetch(`{% url 'api_estudiante_por_documento' %}?doc=${encodeURIComponent(doc)}`, {
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (!data.ok || !data.found) {
        resetPreview();
        alert('No se encontró estudiante con ese documento.');
        return;
      }
      const est = data.estudiante;
      pvNom.textContent = est.nombre || '-';
      pvApe.textContent = est.apellidos || '-';
      pvDoc.textContent = est.documento || '-';
      pvSede.textContent = est.sede || '-';
      pvGrado.textContent = est.grado || '-';
      pvGrupo.textContent = est.grupo || '-';
      pv.style.display = '';
      btnEliminar.disabled = false;  // habilita envío directo
    } catch (e) {
      resetPreview();
      alert('Error consultando el estudiante.');
    } finally {
      btnPreview.disabled = false;
    }
  }

  btnPreview.addEventListener('click', buscar);
  inp.addEventListener('keydown', function (ev) {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      buscar();
    }
  });
})();
</script>
{% endblock %}


