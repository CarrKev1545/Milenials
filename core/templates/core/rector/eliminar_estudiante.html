{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Eliminar Estudiantes{% endblock %}

{% block extra_css %}
<style>
  :root{
    font-size:16.5px;
    /* Paleta global (coincide con el resto del proyecto) */
    --bg-dark:#0b1220;
    --fg-light:#e5ecf6;
    --ink:#111;
    --border-light:rgba(255,255,255,.08);
    --shadow-deep:rgba(0,0,0,.38);
    --shadow-deeper:rgba(0,0,0,.45);
    --field-border:rgba(0,0,0,.08);
    --field-shadow:rgba(0,0,0,.22);
    --accent:#c62828;                    /* rojo principal */
    --accent-shadow:rgba(156,15,16,.35); /* sombra rojo */
    --btn-ghost:#3b82f6;                 /* Buscar (azulado) */
    --btn-muted:#6b7280;                 /* Limpiar (gris) */
  }
  @media (max-width:75em){ :root{font-size:16px} }
  @media (max-width:62em){ :root{font-size:15.5px} }
  @media (max-width:48em){ :root{font-size:15px} }
  @media (max-width:36em){ :root{font-size:14px} }

  /* ===== Layout general del módulo ===== */
  .del{ width:100%; max-width:52rem; margin:0 auto; padding:1.25rem; }
  .del-wrap{ position:relative; padding-top:2.35rem; }

  .del-wrap::before{
    content:""; position:absolute; inset:-1.25rem -1.25rem;
    border-radius:1.35rem;
    background:linear-gradient(180deg, rgba(12,12,12,.70), rgba(12,12,12,.84));
    border:1px solid var(--border-light);
    box-shadow:0 1.1rem 2.2rem var(--shadow-deeper), inset 0 .05rem .5rem #151518;
    z-index:0; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
  }

  .del-card{
    position:relative; z-index:1;
    color:var(--fg-light);
    background:linear-gradient(180deg, #151518, #151518);
    border:1px solid var(--border-light);
    border-radius:1.1rem;
    box-shadow:0 .8rem 1.6rem var(--shadow-deep), inset 0 .02rem .35rem rgba(0,0,0,.35);
    padding:1.35rem 1.35rem 1.1rem;
    backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
  }

  /* ===== Título (badge) ===== */
  .del-badge{
    position:absolute; left:50%; top:0; transform:translate(-50%,-88%);
    display:inline-block; background:var(--accent); color:#fff;
    padding:.78rem 1.85rem; border-radius:1rem; font-weight:800;
    font-size:1.22rem; letter-spacing:.3px;
    text-shadow:0 1px 0 rgba(0,0,0,.25);
    box-shadow:0 .9rem 1.5rem var(--shadow-deep),
               inset 0 -.28rem .68rem rgba(0,0,0,.18),
               0 0 0 .25rem rgba(198,40,40,.12);
    white-space:nowrap; z-index:2;
  }

  /* ===== Grid del formulario ===== */
  .del-form{ display:grid; gap:1rem; grid-template-columns:1fr; }

  /* ===== Campo con icono ===== */
  .del-field{
    position:relative; display:flex; align-items:center;
    height:3.85rem; border-radius:.95rem; background:#fff;
    border:1px solid var(--field-border);
    padding:0 .95rem 0 3rem;
    box-shadow:0 .65rem 1.3rem var(--field-shadow), inset 0 .06rem .22rem rgba(0,0,0,.06);
    transition: box-shadow .15s ease, border-color .15s ease, transform .08s ease;
  }
  .del-ico{
    position:absolute; left:.95rem; top:50%; transform:translateY(-50%);
    color:var(--ink); opacity:.9; font-size:1.08rem;
  }
  .del-field .form-control{
    border:0 !important; background:transparent !important;
    box-shadow:none !important; outline:0 !important;
    padding:0 !important; height:auto !important; color:var(--ink);
    font-weight:700; font-size:1.03rem;
  }
  .del-field:has(.form-control:focus-visible){
    box-shadow:0 0 0 .22rem rgba(198,40,40,.16), 0 .65rem 1.3rem var(--field-shadow);
    border-color:rgba(198,40,40,.32);
    transform:translateY(-1px);
  }
  .del-help{ opacity:.85; font-size:.92rem; margin-top:.35rem }

  /* ===== Acciones ===== */
  .del-actions{
    display:grid; gap:.85rem; grid-template-columns:repeat(3, 1fr); margin-top:.2rem;
  }
  @media (max-width:36em){ .del-actions{ grid-template-columns:1fr; } }

  .del-actions .btn{
    height:3rem; border-radius:999rem; border:1px solid var(--border-light);
    font-weight:800; font-size:1rem; color:#fff !important;
    transition: transform .12s ease, box-shadow .15s ease, filter .15s ease, opacity .12s ease;
  }
  .btn-find{
    background:var(--btn-ghost) !important;
    box-shadow:0 .8rem 1.6rem rgba(59,130,246,.30), inset 0 -.18rem .55rem rgba(0,0,0,.18);
  }
  .btn-clear{
    background:var(--btn-muted) !important;
    box-shadow:0 .8rem 1.6rem rgba(107,114,128,.30), inset 0 -.18rem .55rem rgba(0,0,0,.18);
  }
  .btn-danger{
    background:var(--accent) !important;
    box-shadow:0 .8rem 1.6rem var(--accent-shadow), inset 0 -.18rem .55rem rgba(0,0,0,.18);
  }

  .del-actions .btn:hover{ transform:translateY(-.04rem); filter:saturate(1.05); }
  .del-actions .btn:active{ transform:translateY(.02rem); }
  .del-actions .btn:disabled{ opacity:.55; filter:grayscale(.1); cursor:not-allowed; }

  /* ===== Mensajes (Django messages) ===== */
  .del-messages .alert{ border-radius:.75rem; margin-bottom:.5rem; }

  /* ===== RESUMEN DEL ESTUDIANTE: ancho completo y 2 columnas ===== */
  #preview{ width:100%; }
  #preview .card{
    width:100%;                 /* << fuerza a ocupar todo el ancho */
    max-width:none;             /* << elimina límites implícitos */
    background:linear-gradient(180deg, rgba(15,23,42,.65), rgba(15,23,42,.85));
    color:var(--fg-light); border:1px solid var(--border-light);
    border-radius:1rem; overflow:hidden;
    box-shadow:0 .8rem 1.6rem var(--shadow-deep), inset 0 .02rem .35rem rgba(255,255,255,.04);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  }
  #preview .card-body{ padding:1.1rem 1.25rem; }

  #preview h6{
    font-size:.92rem; letter-spacing:.25px; margin-bottom:.85rem !important;
    color:#cbd5e1;
    display:inline-block; background:rgba(255,255,255,.06);
    border:1px solid var(--border-light); border-radius:999rem;
    padding:.38rem .8rem;
  }

  /* Grid responsive del contenido del resumen (anula .row de Bootstrap) */
  #preview .row{
    margin:0 !important;        /* << quita márgenes negativos de .row */
    display:grid;
    grid-template-columns: 1fr; /* móvil: 1 columna */
    gap:.9rem 1.25rem;
  }
  @media (min-width:56.25em){   /* ~900px: 2 columnas */
    #preview .row{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }

  /* Anula padding/flex de las col-* para que el grid use todo el ancho */
  #preview .row > [class^="col-"],
  #preview .row > [class*=" col-"]{
    padding:0 !important;       /* << quita padding lateral de col-* */
    max-width:none !important;
    flex:none !important;
    width:100% !important;
  }

  /* Línea de dato: etiqueta a la izquierda, valor a la derecha */
  #preview .row > div > div{
    display:flex; align-items:flex-start; justify-content:space-between;
    gap:.75rem; padding:.4rem .1rem;
    border-bottom:1px dashed var(--border-light);
  }
  #preview .row > div > div:last-child{ border-bottom:0; }
  #preview strong{ color:#f1f5f9; font-weight:800; letter-spacing:.2px; min-width:7.5rem; }
  #preview span{ color:#e2e8f0; }

  @media (max-width:36em){
    #preview .row > div > div{ flex-wrap:wrap; }
    #preview strong{ min-width:auto; }
  }

  @media (prefers-reduced-motion: reduce){
    .del-field, .del-actions .btn { transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<section class="del" aria-labelledby="titulo-del">
  <div class="del-wrap">
    <div id="titulo-del" class="del-badge">Eliminar Estudiantes</div>

    <div class="del-card">
      {% if messages %}
        <div class="del-messages mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form id="form-eliminar" method="post" action="{% url 'rector_eliminar_estudiante' %}" class="del-form">
        {% csrf_token %}

        <!-- Campo documento (mismos ids/names) -->
        <div>
          <label for="inp-doc" class="form-label mb-2">Documento del estudiante</label>
          <div class="del-field">
            <span class="del-ico"><i class="fa-solid fa-id-card"></i></span>
            <input
              type="text"
              inputmode="numeric"
              pattern="[0-9]{5,20}"
              minlength="5"
              maxlength="20"
              class="form-control"
              id="inp-doc"
              name="documento"
              placeholder="Solo dígitos (5–20)"
              required
            >
          </div>
          <div class="del-help">
            Escribe el documento y te mostraremos los datos antes de eliminar.
          </div>
        </div>

        <!-- Botones (mismos ids) -->
        <div class="del-actions">
          <button id="btn-preview" type="button" class="btn btn-find">Buscar</button>
          <button id="btn-limpiar"  type="button" class="btn btn-clear">Limpiar</button>
          <button id="btn-eliminar" type="submit" class="btn btn-danger" disabled>Eliminar Estudiante</button>
        </div>

        <!-- Resumen del estudiante (mismos ids) -->
        <div id="preview" class="mt-4" style="display:none;">
          <div class="card border-0">
            <div class="card-body">
              <h6 class="mb-3">Resumen del estudiante</h6>
              <div class="row">
                <div class="col-12 col-md-6">
                  <div><strong>Nombres:</strong>   <span id="pv-nombres">-</span></div>
                  <div><strong>Apellidos:</strong> <span id="pv-apellidos">-</span></div>
                  <div><strong>Documento:</strong> <span id="pv-doc">-</span></div>
                </div>
                <div class="col-12 col-md-6">
                  <div><strong>Sede:</strong>   <span id="pv-sede">-</span></div>
                  <div><strong>Grado:</strong>  <span id="pv-grado">-</span></div>
                  <div><strong>Grupo:</strong>  <span id="pv-grupo">-</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const inp = document.getElementById('inp-doc');
  const btnPreview = document.getElementById('btn-preview');
  const btnLimpiar = document.getElementById('btn-limpiar');
  const btnEliminar = document.getElementById('btn-eliminar');

  const pv = document.getElementById('preview');
  const pvNom = document.getElementById('pv-nombres');
  const pvApe = document.getElementById('pv-apellidos');
  const pvDoc = document.getElementById('pv-doc');
  const pvSede = document.getElementById('pv-sede');
  const pvGrado = document.getElementById('pv-grado');
  const pvGrupo = document.getElementById('pv-grupo');

  function resetPreview() {
    pvNom.textContent = '-';
    pvApe.textContent = '-';
    pvDoc.textContent = '-';
    pvSede.textContent = '-';
    pvGrado.textContent = '-';
    pvGrupo.textContent = '-';
    pv.style.display = 'none';
    btnEliminar.disabled = true;
  }

  btnLimpiar.addEventListener('click', function () {
    inp.value = '';
    resetPreview();
    inp.focus();
  });

  async function buscar() {
    const doc = (inp.value || '').trim();
    if (!/^\d{5,20}$/.test(doc)) {
      resetPreview();
      alert('Documento inválido. Usa solo dígitos (5–20).');
      return;
    }
    try {
      btnPreview.disabled = true;
      const res = await fetch(`{% url 'api_estudiante_por_documento_elim' %}?doc=${encodeURIComponent(doc)}`, {
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (!data.ok || !data.found) {
        resetPreview();
        alert('No se encontró estudiante con ese documento.');
        return;
      }
      const est = data.estudiante;
      pvNom.textContent = est.nombre || '-';
      pvApe.textContent = est.apellidos || '-';
      pvDoc.textContent = est.documento || '-';
      pvSede.textContent = est.sede || '-';
      pvGrado.textContent = est.grado || '-';
      pvGrupo.textContent = est.grupo || '-';
      pv.style.display = '';
      btnEliminar.disabled = false;
    } catch (e) {
      resetPreview();
      alert('Error consultando el estudiante.');
    } finally {
      btnPreview.disabled = false;
    }
  }

  btnPreview.addEventListener('click', buscar);
  inp.addEventListener('keydown', function (ev) {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      buscar();
    }
  });
})();
</script>
{% endblock %}
