{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reportes académicos — Resultados</title>

  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    .page-title {
      position: sticky; top: var(--navbar-height); z-index: 40;
      background: var(--accent); color:#fff; font-weight:800;
      letter-spacing:.2px; text-align:center; padding:10px 12px;
      box-shadow:0 4px 12px rgba(0,0,0,.35);
    }

    .gt { width:100%; max-width:1280px; margin:0 auto; padding:0 20px; }
    .gt-wrap { position:relative; margin-top:10px; }
    .gt-wrap::before {
      content:""; position:absolute; inset:-18px -22px; border-radius:18px;
      background: radial-gradient(140% 160% at 10% 0%,rgba(255,255,255,.06) 0%,rgba(255,255,255,0) 45%),
                  linear-gradient(135deg,rgba(22,22,24,.88) 0%,rgba(16,16,18,.86) 100%);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter:blur(6px) saturate(115%);
      box-shadow:0 22px 44px rgba(0,0,0,.50);
      z-index:0;
    }
    .gt-inner { position:relative; z-index:1; padding:18px 18px 22px; }

    .gt-toolbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin:0 0 12px; }
    .gt-left { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .gt-chip {
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
      color:#e9e9e9; padding:6px 10px; border-radius:8px; font-size:12px;
    }
    .gt-input { height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.9); padding:0 12px; min-width:260px; }

    .gt-btn-sm {
      height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.08); color:#fff; padding:0 12px; cursor:pointer;
    }
    .gt-btn-sm:hover { background:rgba(255,255,255,.18); }

    .gt-table-wrap { overflow:auto; border-radius:10px; box-shadow:0 10px 26px rgba(0,0,0,.45); }
    table.gt-table { width:100%; border-collapse:separate; border-spacing:0; background:rgba(255,255,255,.95); color:#111; }
    .gt-table th,.gt-table td { padding:12px 14px; border-bottom:1px solid rgba(0,0,0,.08); }
    .gt-table thead th {
      position:sticky; top:0; z-index:5; background:#0b6fa4; color:#fff;
      font-weight:800; text-transform:uppercase; font-size:13px;
      border-right:1px solid rgba(255,255,255,.25); user-select:none;
    }
    .gt-table td:first-child,.gt-table th:first-child { text-align:center; width:56px; }
    .gt-table td:nth-child(2){min-width:220px}
    .gt-table td:nth-child(3){min-width:220px}
    .gt-table td:nth-child(4),.gt-table td:nth-child(5){text-align:center;width:120px}
    .muted { opacity:.55; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="nav-left">
      <img src="{% static 'img/logo2.jpeg' %}" alt="Logo colegio" class="logo">
      <div class="nav-title">
        <h3>RECTOR / <span class="nowrap">COORDINADOR</span></h3>
        <span class="user-name">{{ request.user.usuario }}</span>
      </div>
    </div>
    <nav class="nav-menu">
      <a href="{% url 'dashboard_rector' %}">Inicio</a>
      <a href="{% url 'rector_estudiantes_a_grupos' %}">Estudiante a grupos</a>
      <a href="{% url 'rector_asignacion_docentes_grupos' %}">Asignación de Docentes a grupos</a>
    </nav>
    <div class="nav-right"><a class="btn-logout" href="{% url 'logout' %}">Cerrar Sesión</a></div>
  </header>

  <div class="page-title">Reportes académicos</div>

  <main class="main">
    <section class="gt">
      <div class="gt-wrap">
        <div class="gt-inner">

          <!-- Toolbar -->
          <div class="gt-toolbar">
            <div class="gt-left">
              <div class="gt-chip">Reporte: {{ filtros|default:"Sin filtros" }}</div>
              <div class="gt-chip muted" id="hintFuente"></div>
            </div>
            <div class="gt-right">
              <input id="search" class="gt-input" type="search" placeholder="Buscar estudiante…">
              <select id="formato" class="gt-btn-sm" title="Formato de descarga">
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
              </select>
              <button id="exportCsv" class="gt-btn-sm"><i class="fa-solid fa-file-csv"></i>&nbsp;CSV</button>
              <button id="btnDescargar" class="gt-btn-sm"><i class="fa-solid fa-download"></i>&nbsp;Descargar</button>
              <button id="printBtn" class="gt-btn-sm"><i class="fa-solid fa-print"></i>&nbsp;Imprimir</button>
            </div>
          </div>

          <!-- Tabla -->
          <div class="gt-table-wrap">
            <table class="gt-table" id="reportTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Apellidos</th>
                  <th>Nombres</th>
                  <th>Nota</th>
                  <th>Fallas</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <!-- filas cargadas por JS -->
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-left">
        <img src="{% static 'img/logo2.jpeg' %}" alt="Logo colegio" class="footer-logo">
        <div class="footer-school">
          <div class="school-name">Nombre del Colegio</div>
          <div class="school-sub">Sede / Ciudad</div>
        </div>
      </div>
      <div class="footer-center">
        <div>Dirección: Calle Falsa 123</div>
        <div>Tel: (+57) 300 000 0000 · Email: info@colegio.edu.co</div>
      </div>
      <div class="footer-right">
        <nav class="footer-links">
          <a href="#">Privacidad</a>
          <a href="#">Términos</a>
          <a href="#">Contacto</a>
        </nav>
        <div class="copyright">© {% now "Y" %} Nombre del Colegio</div>
      </div>
    </div>
  </footer>

  <script>
    // === Utilidades ===
    const $ = s => document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const toNumber = v => (v==null||v==="") ? "" : String(v).replace(/\D+/g,"");

    const tbody     = $('#tbody');
    const search    = $('#search');
    const exportBtn = $('#exportCsv');
    const printBtn  = $('#printBtn');
    const btnDesc   = $('#btnDescargar');
    const formato   = $('#formato');
    const hintFuente= $('#hintFuente');

    // === Parámetros ===
    const params = {
      sede_id:        toNumber(qs.get('sede_id')),
      grado_id:       toNumber(qs.get('grado_id')),
      grupo_id:       toNumber(qs.get('grupo_id')),
      periodo_id:     toNumber(qs.get('periodo_id')),
      estudiante_id:  toNumber(qs.get('estudiante_id')),
      // opcional: algunas vistas podrían pasar asignatura_id
      asignatura_id:  toNumber(qs.get('asignatura_id'))
    };

    // === Carga de datos ===
    async function loadData(){
      if(!params.grupo_id){
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Falta el parámetro grupo_id.</td></tr>`;
        return;
      }

      // 1) Traer estudiantes activos del grupo
      const estURL = `{% url 'api_estudiantes_por_grupo' %}?grupo_id=${params.grupo_id}`;
      const estRes = await fetch(estURL).then(r=>r.ok?r.json():{estudiantes:[]});
      let estudiantes = estRes.estudiantes || [];

      // Si viene estudiante_id, filtrar
      if(params.estudiante_id){
        estudiantes = estudiantes.filter(e => String(e.id) === String(params.estudiante_id));
      }

      // 2) Si hay asignatura_id y periodo_id, traer notas existentes y mapear
      let mapaNotas = {};
      if(params.asignatura_id && params.periodo_id){
        hintFuente.textContent = "Fuente: Notas por grupo (asignatura y periodo).";
        const notasURL = `{% url 'api_notas_por_grupo' %}?grupo_id=${params.grupo_id}&asignatura_id=${params.asignatura_id}&periodo_id=${params.periodo_id}` + (params.estudiante_id?`&estudiante_id=${params.estudiante_id}`:"");
        const notasRes = await fetch(notasURL).then(r=>r.ok?r.json():{mapa:{}});
        mapaNotas = notasRes.mapa || {};
      }else{
        hintFuente.textContent = "Fuente: Estudiantes del grupo (sin asignatura/periodo: notas en blanco).";
      }

      // 3) Pintar tabla
      if(!estudiantes.length){
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No hay estudiantes para mostrar.</td></tr>`;
        return;
      }

      const rows = [];
      let idx = 1;
      for(const e of estudiantes){
        const key = String(e.id);
        const reg = mapaNotas[key] || {nota:"", fallas:""};
        rows.push(
          `<tr>
            <td>${idx++}</td>
            <td>${(e.apellidos||"").toString()}</td>
            <td>${(e.nombre||"").toString()}</td>
            <td>${reg.nota === undefined || reg.nota === "" ? "" : Number(reg.nota).toFixed(1)}</td>
            <td>${reg.fallas === undefined || reg.fallas === "" ? "" : reg.fallas}</td>
          </tr>`
        );
      }
      tbody.innerHTML = rows.join("");
    }

    // === Filtrado rápido ===
    search.addEventListener('input', () => {
      const q = search.value.toLowerCase().trim();
      [...tbody.rows].forEach(tr => {
        const txt = tr.innerText.toLowerCase();
        tr.style.display = txt.includes(q) ? '' : 'none';
      });
    });

    // === Exportar CSV de lo visible ===
    exportBtn.addEventListener('click', () => {
      const rows = [['#','Apellidos','Nombres','Nota','Fallas']];
      [...tbody.rows].forEach(tr => {
        if(tr.style.display==='none') return;
        rows.push([...tr.cells].map(td=>td.textContent.trim()));
      });
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'reporte_academico.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // === Descargar PDF/Excel desde el backend (boletines) ===
    btnDesc.addEventListener('click', () => {
      if(!params.grupo_id){
        alert('Falta grupo.');
        return;
      }
      if(!params.periodo_id){
        alert('Falta periodo.');
        return;
      }
      const q = new URLSearchParams({
        grupo_id: params.grupo_id,
        periodo_id: params.periodo_id,
        formato: (formato.value || 'pdf')
      });
      if(params.estudiante_id){ q.set('estudiante_id', params.estudiante_id); }
      // NOTA: la vista debe llamarse 'rector_reportes_academicos_export'
      window.location.href = "{% url 'rector_reportes_academicos_export' %}?"+q.toString();
    });

    // === Imprimir ===
    printBtn.addEventListener('click', ()=>window.print());

    // Dispara carga
    loadData().catch(err=>{
      console.error(err);
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Error cargando datos.</td></tr>`;
    });
  </script>
</body>
</html>