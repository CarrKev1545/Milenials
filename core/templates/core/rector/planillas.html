{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Planillas — Estudiantes activos{% endblock %}

{# Sin CSS inline. Todo el ajuste visual va en dashboard.patch.css #}
{% block extra_css %}{% endblock %}

{% block page_banner %}
  <div class="page-banner page-banner--info">
    <h1 class="page-title">Planillas — Estudiantes activos</h1>
  </div>
{% endblock %}

{% block content %}
  <section class="card card--panel max-w-980 mx-auto">
    <header class="card__header">
      <h2 class="card__title">Filtros</h2>
    </header>

    <div class="card__body">
      <div class="grid grid--form">
        <div class="form-line">
          <label for="pl-sede" class="form-label">Sede</label>
          <select id="pl-sede" class="form-select w-100">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="form-line">
          <label for="pl-grado" class="form-label">Grado</label>
          <select id="pl-grado" class="form-select w-100" disabled>
            <option value="">Todos</option>
          </select>
        </div>

        <div class="form-line">
          <label for="pl-grupo" class="form-label">Grupo</label>
          <select id="pl-grupo" class="form-select w-100" disabled>
            <option value="">Todos</option>
          </select>
        </div>
      </div>

      <div class="btns mt-2">
        <button type="button" id="btn-pdf" class="btn btn--pdf">Descargar PDF</button>
        <button type="button" id="btn-xls" class="btn btn--xls">Descargar Excel</button>
      </div>
    </div>
  </section>
{% endblock %}

{% block extra_js %}
{% url 'api_sedes' as api_sedes_url %}
{% url 'api_grados_por_sede' as api_grados_url %}
{% url 'api_grupos_por_sede_grado' as api_grupos_url %}
{% url 'planillas_export_pdf' as export_pdf_url %}
{% url 'planillas_export_excel' as export_xls_url %}

<script>
(() => {
  // ---- Elementos (IDs se conservan para no romper nada) ----
  const selSede  = document.getElementById('pl-sede');
  const selGrado = document.getElementById('pl-grado');
  const selGrupo = document.getElementById('pl-grupo');
  const btnPDF   = document.getElementById('btn-pdf');
  const btnXLS   = document.getElementById('btn-xls');

  // ---- Endpoints inyectados desde Django ----
  const URL_SEDES  = "{{ api_sedes_url|escapejs }}";
  const URL_GRADOS = "{{ api_grados_url|escapejs }}";
  const URL_GRUPOS = "{{ api_grupos_url|escapejs }}";

  const URL_PDF = "{{ export_pdf_url|escapejs }}";
  const URL_XLS = "{{ export_xls_url|escapejs }}";

  // ---- Util ----
  async function j(url){
    const r = await fetch(url, {credentials:'same-origin'});
    if(!r.ok) throw new Error(r.status + ' ' + url);
    return r.json();
  }
  function fill(select, placeholder, items, getValue, getText){
    select.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = ''; ph.textContent = placeholder;
    select.appendChild(ph);
    (items || []).forEach(it => {
      const o = document.createElement('option');
      o.value = getValue(it);
      o.textContent = getText(it);
      select.appendChild(o);
    });
  }
  function enable(el, on){ el.disabled = !on; }

  // ---- Carga Sedes ----
  async function loadSedes(){
    try{
      const data = await j(URL_SEDES);
      fill(selSede, 'Todas', data.sedes || data || [], s => s.id, s => s.nombre);
    }catch(e){ console.warn('Sedes:', e); }
  }

  // ---- Carga Grados (depende de sede) ----
  async function loadGrados(){
    const sede = selSede.value;
    enable(selGrado, false);
    enable(selGrupo, false);
    fill(selGrado, 'Todos', [], x=>x.id, x=>x.nombre);
    fill(selGrupo, 'Todos', [], x=>x.id, x=>x.nombre);
    if(!sede) return;

    try{
      const data = await j(`${URL_GRADOS}?sede_id=${encodeURIComponent(sede)}`);
      fill(selGrado, 'Todos', data.grados || data || [], g => g.id, g => g.nombre);
      enable(selGrado, true);
    }catch(e){ console.warn('Grados:', e); }
  }

  // ---- Carga Grupos (depende de sede+grado) ----
  async function loadGrupos(){
    const sede  = selSede.value;
    const grado = selGrado.value;
    enable(selGrupo, false);
    fill(selGrupo, 'Todos', [], x=>x.id, x=>x.nombre);
    if(!sede || !grado) return;

    try{
      const data = await j(`${URL_GRUPOS}?sede_id=${encodeURIComponent(sede)}&grado_id=${encodeURIComponent(grado)}`);
      const rows = (data.grupos || data || []).map(g => Array.isArray(g) ? {id:g[0], nombre:g[1]} : g);
      fill(selGrupo, 'Todos', rows, g=>g.id, g=>g.nombre);
      enable(selGrupo, true);
    }catch(e){ console.warn('Grupos:', e); }
  }

  // ---- Descargas ----
  function openExport(baseUrl){
    const p = new URLSearchParams();
    if(selSede.value)  p.set('sede_id',  selSede.value);
    if(selGrado.value) p.set('grado_id', selGrado.value);
    if(selGrupo.value) p.set('grupo_id', selGrupo.value);
    const url = baseUrl + (p.toString() ? `?${p}` : '');
    window.open(url, '_blank', 'noopener');
  }

  btnPDF.addEventListener('click', () => openExport(URL_PDF));
  btnXLS.addEventListener('click', () => openExport(URL_XLS));

  selSede .addEventListener('change', loadGrados);
  selGrado.addEventListener('change', loadGrupos);

  // Init
  loadSedes().then(loadGrados);
})();
</script>
{% endblock %}
