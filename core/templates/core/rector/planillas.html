{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Planillas — Estudiantes activos{% endblock %}

{% block extra_css %}
<style>
  /* Escala tipográfica estable */
  :root{
    font-size:16.5px;
    /* paleta traída del primer style */
    --bg-dark:#0b1220;
    --fg-light:#e5ecf6;
    --ink:#111;
    --border-light:rgba(255,255,255,.08);
    --shadow-deep:rgba(0,0,0,.35);
    --shadow-deeper:rgba(0,0,0,.45);
    --field-border:rgba(0,0,0,.06);
    --field-shadow:rgba(0,0,0,.22);
    --accent:#c62828;                    /* rojo principal */
    --accent-shadow:rgba(156,15,16,.35); /* sombra para rojo */
  }
  @media (max-width:75em){ :root{font-size:16px} }
  @media (max-width:62em){ :root{font-size:15.5px} }
  @media (max-width:48em){ :root{font-size:15px} }
  @media (max-width:36em){ :root{font-size:14px} }

  /* Contenedor */
  .pl{ width:100%; max-width:58rem; margin:0 auto; padding:1.25rem; }

  /* Marco trasero */
  .pl-wrap{ position:relative; padding-top:4.25rem; }
  .pl-wrap::before{
    content:"";
    position:absolute;
    top:-3.25rem; right:-2rem; bottom:-2rem; left:-2rem;
    border-radius:1.6rem;
    background:linear-gradient(180deg, rgba(12,12,12,.70), rgba(12,12,12,.84));
    border:1px solid var(--border-light);
    box-shadow:0 1.6rem 2.6rem var(--shadow-deeper), inset 0 .06rem .55rem rgba(255,255,255,.04);
    z-index:0;
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
  }

  /* Tarjeta principal (usa colores del patrón) */
  .pl-card{
    position:relative; z-index:1;
    color:var(--fg-light);
    background:linear-gradient(180deg, rgba(11,18,32,.86), rgba(11,18,32,.92)); /* ~#0b1220 */
    border:1px solid var(--border-light);
    border-radius:1.1rem;
    box-shadow:0 1rem 1.9rem var(--shadow-deep), inset 0 .02rem .35rem rgba(255,255,255,.04);
    padding:1.35rem;
    backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
  }

  /* Grid */
  .pl-form{ display:grid; gap:1.1rem; grid-template-columns:1fr; }
  @media (min-width:56.25em){ .pl-form{ grid-template-columns:repeat(2,1fr); } }
  .pl-field--span-2{ grid-column:1 / -1; }

  /* Campos (colores de inputs y adornos) */
  .pl-field{
    position:relative; display:flex; align-items:center;
    height:3.9rem; border-radius:.95rem;
    background:#fff; border:1px solid var(--field-border);
    padding:0 .95rem 0 3rem;
    box-shadow:0 .65rem 1.3rem var(--field-shadow), inset 0 .06rem .22rem rgba(0,0,0,.06);
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .pl-ico{
    position:absolute; left:.95rem; top:50%; transform:translateY(-50%);
    color:var(--ink); opacity:.9; font-size:1.08rem;
  }
  .pl-field select{
    width:100%; border:0; outline:none; background:transparent;
    font-weight:700; color:var(--ink); font-size:1.03rem; appearance:none;
  }
  .pl-field select:disabled{ opacity:.6; }
  .pl-field:has(select:focus-visible){
    /* focus en rojo del patrón */
    box-shadow:0 0 0 .24rem rgba(198,40,40,.18), 0 .7rem 1.35rem var(--field-shadow);
    border-color:rgba(198,40,40,.36);
  }
  .pl-field::after{
    content:"▾"; position:absolute; right:.85rem; top:50%; transform:translateY(-50%);
    color:var(--ink); opacity:.7; font-size:1rem; pointer-events:none; font-weight:700;
  }

  /* Acciones */
  .pl-actions{ display:grid; gap:.85rem; grid-template-columns:1fr; margin-top:.7rem; }
  @media (min-width:33.75em){ .pl-actions{ grid-template-columns:repeat(2,1fr);} }
  .pl-actions .btn{
    height:3rem; border-radius:999rem; border:1px solid var(--border-light);
    font-weight:800; font-size:1rem; color:#fff;
    transition: transform .12s ease, box-shadow .15s ease, filter .15s ease;
  }
  .btn-pdf{
    background:var(--accent);
    box-shadow:0 .8rem 1.6rem var(--accent-shadow), inset 0 -.18rem .55rem rgba(0,0,0,.18);
  }
  .btn-xls{
    /* mantenemos verde de Excel, solo ajustamos sombra a la misma lógica */
    background:#136f36;
    box-shadow:0 .8rem 1.6rem rgba(19,111,54,.32), inset 0 -.18rem .55rem rgba(0,0,0,.18);
  }
  .pl-actions .btn:hover{ transform:translateY(-.06rem); filter:saturate(1.06) brightness(1.02); }
  .pl-actions .btn:active{ transform:translateY(.02rem); }

  /* Título (badge) con colores del patrón */
  .pl-badge{
    position:absolute; left:50%; top:0; transform:translate(-50%,-45%);
    display:inline-block; background:var(--accent); color:#fff;
    padding:.85rem 1.95rem; border-radius:1rem; font-weight:800;
    font-size:1.24rem; letter-spacing:.35px;
    text-shadow:0 1px 0 rgba(0,0,0,.25);
    box-shadow:0 .9rem 1.5rem var(--shadow-deeper), inset 0 -.3rem .7rem rgba(0,0,0,.18);
    white-space:nowrap; z-index:2;
  }

  /* Ajustes responsive */
  @media (max-width:48em){
    .pl-wrap{ padding-top:3.25rem; }
    .pl-wrap::before{ top:-2.5rem; right:-1rem; bottom:-1rem; left:-1rem; }
    .pl-badge{ transform:translate(-50%,-95%); }
  }

  @media (prefers-reduced-motion: reduce){
    .pl-field, .pl-actions .btn { transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<section class="pl" aria-labelledby="titulo-pl">
  <div class="pl-wrap">
    <div id="titulo-pl" class="pl-badge">Plantillas</div>

    <div class="pl-card" role="group" aria-label="Filtros de exportación">
      <form class="pl-form" onsubmit="return false;" autocomplete="off">
        <!-- Sede -->
        <label class="pl-field" for="pl-sede">
          <span class="pl-ico"><i class="fa-solid fa-building-columns"></i></span>
          <select id="pl-sede">
            <option value="">Sedes</option>
          </select>
        </label>

        <!-- Grado -->
        <label class="pl-field" for="pl-grado">
          <span class="pl-ico"><i class="fa-solid fa-layer-group"></i></span>
          <select id="pl-grado" disabled>
            <option value="">Grados</option>
          </select>
        </label>

        <!-- Grupo (a todo el ancho) -->
        <label class="pl-field pl-field--span-2" for="pl-grupo">
          <span class="pl-ico"><i class="fa-solid fa-people-group"></i></span>
          <select id="pl-grupo" disabled>
            <option value="">Grupos</option>
          </select>
        </label>
      </form>

      <div class="pl-actions">
        <button type="button" id="btn-pdf" class="btn btn-pdf">Descargar PDF</button>
        <button type="button" id="btn-xls" class="btn btn-xls">Descargar Excel</button>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
{% url 'api_sedes' as api_sedes_url %}
{% url 'api_grados_por_sede' as api_grados_url %}
{% url 'api_grupos_por_sede_grado' as api_grupos_url %}
{% url 'planillas_export_pdf' as export_pdf_url %}
{% url 'planillas_export_excel' as export_xls_url %}

<script>
(() => {
  // ---- Elementos (IDs se conservan) ----
  const selSede  = document.getElementById('pl-sede');
  const selGrado = document.getElementById('pl-grado');
  const selGrupo = document.getElementById('pl-grupo');
  const btnPDF   = document.getElementById('btn-pdf');
  const btnXLS   = document.getElementById('btn-xls');

  // Placeholders tomados del DOM (respetan tu HTML: "Sedes/Grados/Grupos")
  const PH_SEDE  = selSede.options[0]?.text?.trim()  || 'Sede';
  const PH_GRADO = selGrado.options[0]?.text?.trim() || 'Grado';
  const PH_GRUPO = selGrupo.options[0]?.text?.trim() || 'Grupo';

  // ---- Endpoints inyectados desde Django ----
  const URL_SEDES  = "{{ api_sedes_url|escapejs }}";
  const URL_GRADOS = "{{ api_grados_url|escapejs }}";
  const URL_GRUPOS = "{{ api_grupos_url|escapejs }}";
  const URL_PDF    = "{{ export_pdf_url|escapejs }}";
  const URL_XLS    = "{{ export_xls_url|escapejs }}";

  // ---- Helpers ----
  async function j(url){
    const r = await fetch(url, { credentials:'same-origin' });
    if(!r.ok) throw new Error(`${r.status} ${url}`);
    return r.json();
  }

  function normalize(list) {
    const arr = Array.isArray(list) ? list : [];
    return arr.map(item => {
      if (Array.isArray(item)) return { id: item[0], nombre: String(item[1] ?? item[0]) };
      if (item && typeof item === 'object') {
        const id = item.id ?? item.value ?? item.pk ?? item.key ?? '';
        const nombre = item.nombre ?? item.name ?? item.text ?? item.label ?? item.titulo ?? String(id);
        return { id, nombre };
      }
      return { id: item, nombre: String(item) };
    });
  }

  function extractList(data) {
    if (!data) return [];
    if (Array.isArray(data.sedes))  return normalize(data.sedes);
    if (Array.isArray(data.grados)) return normalize(data.grados);
    if (Array.isArray(data.grupos)) return normalize(data.grupos);
    if (Array.isArray(data.results))return normalize(data.results);
    if (Array.isArray(data))        return normalize(data);
    return normalize(Object.values(data));
  }

  function fill(select, placeholder, items) {
    select.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = ''; ph.textContent = placeholder;
    select.appendChild(ph);
    items.forEach(({id, nombre}) => {
      const o = document.createElement('option');
      o.value = id; o.textContent = nombre;
      select.appendChild(o);
    });
    select.selectedIndex = 0; // queda mostrando el placeholder
  }

  function resetSelect(select, placeholder) {
    fill(select, placeholder, []);
    select.disabled = true;
  }

  function enable(select, on=true) { select.disabled = !on; }

  // ---- Carga Sedes ----
  async function loadSedes() {
    try{
      const data  = await j(URL_SEDES);
      const sedes = extractList(data);
      fill(selSede, PH_SEDE, sedes);     // << antes: 'Todas'
      enable(selSede, true);
    }catch(e){
      console.warn('Sedes:', e);
      resetSelect(selSede, PH_SEDE);
    }
  }

  // ---- Carga Grados (depende de sede) ----
  async function loadGrados() {
    const sede = selSede.value;
    resetSelect(selGrado, PH_GRADO);     // << antes: 'Todos'
    resetSelect(selGrupo, PH_GRUPO);     // << antes: 'Todos'
    if (!sede) return;

    try{
      const qs = new URLSearchParams({ sede_id: sede, sede: sede });
      const data   = await j(`${URL_GRADOS}?${qs.toString()}`);
      const grados = extractList(data);
      fill(selGrado, PH_GRADO, grados);
      enable(selGrado, grados.length > 0);
    }catch(e){
      console.warn('Grados:', e);
    }
  }

  // ---- Carga Grupos (depende de sede+grado) ----
  async function loadGrupos() {
    const sede  = selSede.value;
    const grado = selGrado.value;
    resetSelect(selGrupo, PH_GRUPO);
    if (!sede || !grado) return;

    try{
      const qs = new URLSearchParams({ sede_id: sede, sede: sede, grado_id: grado, grado: grado });
      const data   = await j(`${URL_GRUPOS}?${qs.toString()}`);
      const grupos = extractList(data);
      fill(selGrupo, PH_GRUPO, grupos);
      enable(selGrupo, grupos.length > 0);
    }catch(e){
      console.warn('Grupos:', e);
    }
  }

  // ---- Descargas ----
  function openExport(baseUrl){
    const p = new URLSearchParams();
    const add = (k,v) => { if (v) p.append(k, v); };

    if (selSede.value)  { add('sede_id', selSede.value);  add('sede',  selSede.value); }
    if (selGrado.value) { add('grado_id', selGrado.value); add('grado', selGrado.value); }
    if (selGrupo.value) { add('grupo_id', selGrupo.value); add('grupo', selGrupo.value); }

    const url = baseUrl + (p.toString() ? `?${p}` : '');
    window.open(url, '_blank', 'noopener');
  }

  // Eventos
  btnPDF.addEventListener('click', () => openExport(URL_PDF));
  btnXLS.addEventListener('click', () => openExport(URL_XLS));
  selSede .addEventListener('change', loadGrados);
  selGrado.addEventListener('change', loadGrupos);

  // Init
  resetSelect(selGrado, PH_GRADO);
  resetSelect(selGrupo, PH_GRUPO);
  loadSedes().then(loadGrados);
})();
</script>
{% endblock %}
