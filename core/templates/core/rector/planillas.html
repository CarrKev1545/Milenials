{% extends "core/base.html" %}
{% block title %}Planillas{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card glass-panel mx-auto" style="max-width:1180px;">
    <div class="card-body">
      <h3 class="mb-3">Planillas — Estudiantes activos</h3>
      <p class="text-muted mb-4">Descarga por sede, grado y grupo</p>

      <div class="row g-3">

        <!-- SEDE -->
        <div class="col-12">
          <label class="form-label">Sede</label>
          <select id="selSede" class="form-select">
            <option value="">Todas</option>
            {% for id, nombre in sedes %}
              <option value="{{ id }}" {% if sel_sede|stringformat:'s' == id|stringformat:'s' %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- GRADO (depende de SEDE) -->
        <div class="col-12">
          <label class="form-label">Grado</label>
          <select id="selGrado" class="form-select">
            <option value="">Todos</option>
            {# Se llena al vuelo según la sede; si vienes con valor, lo aplicamos al cargar #}
          </select>
        </div>

        <!-- GRUPO (depende de SEDE y GRADO) -->
        <div class="col-12">
          <label class="form-label">Grupo</label>
          <select id="selGrupo" class="form-select">
            <option value="">Todos</option>
            {# Se llena al vuelo según sede/grado #}
          </select>
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <a id="btnPdf"
             class="btn btn-danger"
             target="_blank"
             href="{% url 'planillas_export_pdf' %}">
            Descargar PDF
          </a>

          <a id="btnXls"
             class="btn btn-danger"
             target="_blank"
             href="{% url 'planillas_export_excel' %}">
            Descargar Excel
          </a>
        </div>
      </div>

      <p class="text-muted small mt-3 mb-0">
        Selecciona filtros: los botones de descarga usan automáticamente la sede, el grado y el grupo elegidos. La exportación se abre en otra pestaña.
      </p>
    </div>
  </div>
</div>

<script>
(function() {
  const $sede  = document.getElementById('selSede');
  const $grado = document.getElementById('selGrado');
  const $grupo = document.getElementById('selGrupo');
  const $btnPdf = document.getElementById('btnPdf');
  const $btnXls = document.getElementById('btnXls');

  const pdfBase = $btnPdf.getAttribute('href');
  const xlsBase = $btnXls.getAttribute('href');

  // Valores que llegan del servidor (si venías con query ?sede=&grado=&grupo=)
  const preSede  = "{{ sel_sede|default:'' }}";
  const preGrado = "{{ sel_grado|default:'' }}";
  const preGrupo = "{{ sel_grupo|default:'' }}";

  function qs() {
    const params = new URLSearchParams();
    if ($sede.value)  params.set('sede',  $sede.value);
    if ($grado.value) params.set('grado', $grado.value);
    if ($grupo.value) params.set('grupo', $grupo.value);
    return params.toString();
  }

  function refreshLinks() {
    const query = qs();
    $btnPdf.href = query ? `${pdfBase}?${query}` : pdfBase;
    $btnXls.href = query ? `${xlsBase}?${query}` : xlsBase;
  }

  // Helpers para poblar selects
  function setOptions($select, items, placeholderText) {
    const prev = $select.value;
    $select.innerHTML = ''; // limpia
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = placeholderText;
    $select.appendChild(optAll);

    items.forEach(([id, nombre]) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = nombre;
      $select.appendChild(opt);
    });

    // si el valor previo sigue existiendo, lo reponemos; si no, queda "Todos"
    if ([...$select.options].some(o => o.value === prev)) {
      $select.value = prev;
    } else {
      $select.value = '';
    }
  }

  async function cargarGrados() {
    // Grado depende de Sede
    const sede = $sede.value;
    if (!sede) {
      setOptions($grado, [], 'Todos');
      await cargarGrupos();   // grupos también cambian
      refreshLinks();
      return;
    }
    const url = `/api/grados-por-sede/?sede_id=${encodeURIComponent(sede)}`;
    const data = await fetch(url).then(r => r.json()).catch(() => []);
    // Esperamos una lista tipo [[id, nombre], ...]
    setOptions($grado, data, 'Todos');

    // Si vienes con un grado pre-seleccionado:
    if (preGrado && [...$grado.options].some(o => o.value === preGrado)) {
      $grado.value = preGrado;
    }
    await cargarGrupos();   // al cambiar grado, refrescamos grupos
    refreshLinks();
  }

  async function cargarGrupos() {
    // Grupo depende de Sede y (opcional) Grado
    const sede  = $sede.value || '';
    const grado = $grado.value || '';
    const url = `/api/grupos-por-sede-grado/?sede_id=${encodeURIComponent(sede)}&grado_id=${encodeURIComponent(grado)}`;
    const data = await fetch(url).then(r => r.json()).catch(() => []);
    setOptions($grupo, data, 'Todos');

    if (preGrupo && [...$grupo.options].some(o => o.value === preGrupo)) {
      $grupo.value = preGrupo;
    }
    refreshLinks();
  }

  // Eventos
  $sede.addEventListener('change', async () => {
    // Al cambiar de sede, refresco grados y luego grupos
    await cargarGrados();
  });

  $grado.addEventListener('change', async () => {
    await cargarGrupos();
  });

  $grupo.addEventListener('change', refreshLinks);

  // Init: si hay sede/grado/grupo iniciales, los aplicamos
  async function init() {
    // Si ya viene una sede preseleccionada en el HTML, úsala
    if (preSede) $sede.value = preSede;
    await cargarGrados();
    refreshLinks();
  }

  init();
})();
</script>
{% endblock %}
