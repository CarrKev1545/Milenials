{% extends "core/base.html" %}
{% block title %}Planillas{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card card-dashboard shadow mx-auto" style="max-width:1080px;">
    <div class="card-body">
      <h4 class="mb-3">Planillas — Estudiantes activos</h4>

      <form class="row g-3 mb-3" onsubmit="return false;">
        <div class="col-12">
          <small class="text-muted">Descarga por sede, grado y grupo</small>
        </div>

        <!-- SEDE -->
        <div class="col-12">
          <label class="form-label">Sede</label>
          <select id="selSede" name="sede" class="form-select">
            <option value="">Todas</option>
            {% for id,nombre in sedes %}
              <option value="{{ id }}" {% if sel_sede|stringformat:'s' == id|stringformat:'s' %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- GRADO (se llena según sede) -->
        <div class="col-12">
          <label class="form-label">Grado</label>
          <select id="selGrado" name="grado" class="form-select">
            <option value="">Todos</option>
            {% for id,nombre in grados %}
              <option value="{{ id }}" {% if sel_grado|stringformat:'s' == id|stringformat:'s' %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- GRUPO (se llena según sede y grado) -->
        <div class="col-12">
          <label class="form-label">Grupo</label>
          <select id="selGrupo" name="grupo" class="form-select">
            <option value="">Todos</option>
            {% for id,full in grupos %}
              <option value="{{ id }}" {% if sel_grupo|stringformat:'s' == id|stringformat:'s' %}selected{% endif %}>{{ full }}</option>
            {% endfor %}
          </select>
        </div>

        <a id="btnPdf"
          class="btn btn-danger"
           href="{% url 'planillas_export_pdf' %}"
           target="_blank" rel="noopener">
           Descargar PDF
         </a>

         <a id="btnExcel"
           class="btn btn-danger"
           href="{% url 'planillas_export_excel' %}"
           target="_blank" rel="noopener">
           Descargar Excel
          </a>
        </div>
      </form>

      <p class="text-muted small mb-0">
        Selecciona filtros: los botones de descarga usan automáticamente la sede, el grado y el grupo elegidos.
        La exportación se abre en otra pestaña.
      </p>
    </div>
  </div>
</div>

<script>
(function () {
  const sedeSel  = document.getElementById('selSede');
  const gradoSel = document.getElementById('selGrado');
  const grupoSel = document.getElementById('selGrupo');

  const btnPdf   = document.getElementById('btnPdf');
  const btnExcel = document.getElementById('btnExcel');

  // Construye el query y lo aplica a los botones
  function updateLinks() {
    const sede  = sedeSel.value || '';
    const grado = gradoSel.value || '';
    const grupo = grupoSel.value || '';

    const qs = new URLSearchParams({sede, grado, grupo}).toString();

   
    const basePdf   = btnPdf.getAttribute('href').split('?')[0];
    const baseExcel = btnExcel.getAttribute('href').split('?')[0];

    btnPdf.href   = `${basePdf}?${qs}`;
    btnExcel.href = `${baseExcel}?${qs}`;
  }

  // Helpers para combos
  function resetSelect(selectEl, placeholderText) {
    selectEl.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = placeholderText;
    selectEl.appendChild(opt);
  }

  function fillSelect(selectEl, items, valueKey, labelKey) {
    for (const item of items) {
      const opt = document.createElement('option');
      opt.value = item[valueKey];
      opt.textContent = item[labelKey];
      selectEl.appendChild(opt);
    }
  }

  async function loadGrados() {
    // Vacía grado y grupo
    resetSelect(gradoSel, 'Todos');
    resetSelect(grupoSel, 'Todos');

    const sedeId = sedeSel.value || '';
    if (!sedeId) {
      // Sin sede elegida, deja grados como “Todos” (opcional: podrías cargar todos)
      updateLinks();
      return;
    }

    gradoSel.disabled = true;
    try {
      const url = `/api/grados-por-sede/?sede_id=${encodeURIComponent(sedeId)}`;
      const res = await fetch(url, {cache: 'no-store'});
      const data = await res.json();
      fillSelect(gradoSel, data.results, 'id', 'nombre');

      // Si venías con un grado seleccionado (por GET), intenta mantenerlo
      const pre = "{{ sel_grado|default_if_none:'' }}";
      if (pre) { gradoSel.value = pre; }
    } catch (e) {
      console.error('Error cargando grados:', e);
    } finally {
      gradoSel.disabled = false;
      updateLinks();
      // al cambiar grados, también refrescamos grupos
      loadGrupos();
    }
  }

  async function loadGrupos() {
    resetSelect(grupoSel, 'Todos');

    const sedeId  = sedeSel.value || '';
    const gradoId = gradoSel.value || '';

    grupoSel.disabled = true;
    try {
      const url = `/api/grupos-por-sede-grado/?sede_id=${encodeURIComponent(sedeId)}&grado_id=${encodeURIComponent(gradoId)}`;
      const res = await fetch(url, {cache: 'no-store'});
      const data = await res.json();
      fillSelect(grupoSel, data.results, 'id', 'full');

      const pre = "{{ sel_grupo|default_if_none:'' }}";
      if (pre) { grupoSel.value = pre; }
    } catch (e) {
      console.error('Error cargando grupos:', e);
    } finally {
      grupoSel.disabled = false;
      updateLinks();
    }
  }

  // Eventos
  sedeSel.addEventListener('change', () => {
    // Si cambia sede, recarga grados y grupos
    loadGrados();
  });
  gradoSel.addEventListener('change', () => {
    // Si cambia grado, recarga grupos
    loadGrupos();
  });
  grupoSel.addEventListener('change', updateLinks);

  // Init en carga (poblar combos dependientes y armar links)
  document.addEventListener('DOMContentLoaded', () => {
    // Arrancamos poblando en cascada con lo que haya seleccionado por GET (si aplica)
    if (sedeSel.value) {
      loadGrados();
    } else {
      updateLinks();
    }
  });
})();
</script>
{% endblock %}
