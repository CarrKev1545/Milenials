{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Planillas — Estudiantes activos{% endblock %}

{# No añadimos CSS: heredamos los estilos globales del proyecto #}
{% block extra_css %}{% endblock %}

{% block page_banner %}
  <div class="page-banner page-banner--info">
    <h1 class="page-title">Planillas — Estudiantes activos</h1>
  </div>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-12 col-xl-9 mx-auto">

      <div class="card shadow-sm">
        <div class="card-header">
          <strong>Filtros</strong>
        </div>

        <div class="card-body">
          <div class="row g-3">

            <div class="col-12 col-md-6">
              <label for="pl-sede" class="form-label">Sede</label>
              <select id="pl-sede" class="form-select">
                <option value="">Todas</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label for="pl-grado" class="form-label">Grado</label>
              <select id="pl-grado" class="form-select" disabled>
                <option value="">Todos</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label for="pl-grupo" class="form-label">Grupo</label>
              <select id="pl-grupo" class="form-select" disabled>
                <option value="">Todos</option>
              </select>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <button type="button" id="btn-pdf" class="btn btn-danger">
              Descargar PDF
            </button>
            <button type="button" id="btn-xls" class="btn btn-success">
              Descargar Excel
            </button>
          </div>
        </div>
      </div>

      {# Si había un párrafo de ayuda, lo omitimos para mantener limpieza visual #}

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% url 'api_sedes' as api_sedes_url %}
{% url 'api_grados_por_sede' as api_grados_url %}
{% url 'api_grupos_por_sede_grado' as api_grupos_url %}
{% url 'planillas_export_pdf' as export_pdf_url %}
{% url 'planillas_export_excel' as export_xls_url %}

<script>
(() => {
  // ---- Elementos (IDs se conservan) ----
  const selSede  = document.getElementById('pl-sede');
  const selGrado = document.getElementById('pl-grado');
  const selGrupo = document.getElementById('pl-grupo');
  const btnPDF   = document.getElementById('btn-pdf');
  const btnXLS   = document.getElementById('btn-xls');

  // ---- Endpoints inyectados desde Django ----
  const URL_SEDES  = "{{ api_sedes_url|escapejs }}";
  const URL_GRADOS = "{{ api_grados_url|escapejs }}";
  const URL_GRUPOS = "{{ api_grupos_url|escapejs }}";

  const URL_PDF = "{{ export_pdf_url|escapejs }}";
  const URL_XLS = "{{ export_xls_url|escapejs }}";

  // ---- Helpers ----
  async function j(url){
    const r = await fetch(url, { credentials:'same-origin' });
    if(!r.ok) throw new Error(`${r.status} ${url}`);
    return r.json();
  }

  // Normaliza arrays/objetos a [{id, nombre}]
  function normalize(list) {
    const arr = Array.isArray(list) ? list : [];
    return arr.map(item => {
      if (Array.isArray(item)) {
        // [id, "Nombre"] o [id, "Sede - Grado - Grupo"]
        return { id: item[0], nombre: String(item[1] ?? item[0]) };
      }
      if (item && typeof item === 'object') {
        const id = item.id ?? item.value ?? item.pk ?? item.key ?? '';
        const nombre = item.nombre ?? item.name ?? item.text ?? item.label ?? item.titulo ?? String(id);
        return { id, nombre };
      }
      // Primitivos
      return { id: item, nombre: String(item) };
    });
  }

  // Extrae la lista de una respuesta flexible
  function extractList(data) {
    if (!data) return [];
    // claves comunes
    if (Array.isArray(data.sedes))  return normalize(data.sedes);
    if (Array.isArray(data.grados)) return normalize(data.grados);
    if (Array.isArray(data.grupos)) return normalize(data.grupos);
    if (Array.isArray(data.results))return normalize(data.results);
    if (Array.isArray(data))        return normalize(data);
    // objeto con índices numéricos -> conviértelo
    return normalize(Object.values(data));
  }

  function fill(select, placeholder, items) {
    select.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = ''; ph.textContent = placeholder;
    select.appendChild(ph);
    items.forEach(({id, nombre}) => {
      const o = document.createElement('option');
      o.value = id; o.textContent = nombre;
      select.appendChild(o);
    });
  }

  function resetSelect(select, placeholder) {
    fill(select, placeholder, []);
    select.disabled = true;
  }

  function enable(select, on=true) {
    select.disabled = !on;
  }

  // ---- Carga Sedes ----
  async function loadSedes() {
    try{
      const data = await j(URL_SEDES);
      const sedes = extractList(data);
      console.debug('SEDES ->', sedes, data);
      fill(selSede, 'Todas', sedes);
      enable(selSede, true);
    }catch(e){
      console.warn('Sedes:', e);
      resetSelect(selSede, 'Todas');
    }
  }

  // ---- Carga Grados (depende de sede) ----
  async function loadGrados() {
    const sede = selSede.value;
    // reset dependientes
    resetSelect(selGrado, 'Todos');
    resetSelect(selGrupo, 'Todos');
    if (!sede) return;

    try{
      const qs = new URLSearchParams({ sede_id: sede, sede: sede }); // enviamos ambos nombres
      const data = await j(`${URL_GRADOS}?${qs.toString()}`);
      const grados = extractList(data);
      console.debug('GRADOS ->', grados, data);
      fill(selGrado, 'Todos', grados);
      enable(selGrado, grados.length > 0);
    }catch(e){
      console.warn('Grados:', e);
    }
  }

  // ---- Carga Grupos (depende de sede+grado) ----
  async function loadGrupos() {
    const sede  = selSede.value;
    const grado = selGrado.value;
    resetSelect(selGrupo, 'Todos');
    if (!sede || !grado) return;

    try{
      const qs = new URLSearchParams({
        sede_id: sede, sede: sede,
        grado_id: grado, grado: grado
      });
      const data = await j(`${URL_GRUPOS}?${qs.toString()}`);
      const grupos = extractList(data);
      console.debug('GRUPOS ->', grupos, data);
      fill(selGrupo, 'Todos', grupos);
      enable(selGrupo, grupos.length > 0);
    }catch(e){
      console.warn('Grupos:', e);
    }
  }

  // ---- Descargas ----
  function openExport(baseUrl){
    const p = new URLSearchParams();
    const add = (k,v) => { if (v) p.append(k, v); };

    if (selSede.value)  { add('sede_id', selSede.value);  add('sede',  selSede.value); }
    if (selGrado.value) { add('grado_id', selGrado.value); add('grado', selGrado.value); }
    if (selGrupo.value) { add('grupo_id', selGrupo.value); add('grupo', selGrupo.value); }

    const url = baseUrl + (p.toString() ? `?${p}` : '');
    console.debug('EXPORT URL ->', url);   // para verificar en consola
    window.open(url, '_blank', 'noopener');
  }

  // Eventos
  btnPDF.addEventListener('click', () => openExport(URL_PDF));
  btnXLS.addEventListener('click', () => openExport(URL_XLS));
  selSede .addEventListener('change', loadGrados);
  selGrado.addEventListener('change', loadGrupos);

  // Init
  resetSelect(selGrado, 'Todos');
  resetSelect(selGrupo, 'Todos');
  loadSedes().then(loadGrados);
})();
</script>
{% endblock %}