{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Asignación de Docentes a grupos{% endblock %}

{% block extra_css %}
<style>
  /* ===== Escala base rem (fluida) ===== */
  :root{ font-size:16px; }
  @media (max-width:75em){ :root{ font-size:15px; } } /* ~1200px */
  @media (max-width:62em){ :root{ font-size:14px; } } /* ~992px  */
  @media (max-width:48em){ :root{ font-size:13px; } } /* ~768px  */
  @media (max-width:36em){ :root{ font-size:12px; } } /* ~576px  */

  /* ===== Layout general (patrón rector) ===== */
  .re{ width:100%; max-width:70rem; margin:0 auto; padding:1rem; }
  .re-title{ text-align:center; font-weight:800; font-size:1.5rem; margin-bottom:1.25rem; }

  .re-wrap{ display:grid; grid-template-columns:1fr 2fr; gap:1.25rem; align-items:start; }
  @media (max-width:56.25em){ .re-wrap{ grid-template-columns:1fr; } }

  /* Avatar / ilustración */
  .re-left{ display:flex; justify-content:center; }
  .re-avatar{
    width:6.25rem; height:6.25rem; border-radius:50%;
    display:grid; place-items:center; background:#0c0c0c;
    box-shadow:0 .75rem 1.5rem rgba(0,0,0,.35), inset 0 -.5rem 1rem rgba(0,0,0,.2);
  }
  .re-avatar i{ font-size:3rem; color:#fff; filter:drop-shadow(0 .5rem 1rem rgba(0,0,0,.4)); }

  /* Card derecha */
  .re-right{
    background:#0b1220; color:#e5ecf6;
    border-radius:1rem; padding:1.25rem;
    border:1px solid rgba(255,255,255,.08);
    box-shadow:0 .75rem 1.5rem rgba(0,0,0,.35);
  }

  /* Formulario */
  .re-form{ display:grid; grid-template-columns:1fr; gap:1rem; }
  @media (min-width:48em){ .re-form{ grid-template-columns:repeat(2,1fr); } }
  .re-form .re-field:nth-last-child(1){ grid-column:1 / -1; } /* por si quieres que el último campo se expanda */

  .re-field{
    position:relative; display:flex; align-items:center;
    height:4rem; border-radius:.875rem; background:#fff; color:#111;
    border:1px solid rgba(0,0,0,.06);
    box-shadow:0 .625rem 1.25rem rgba(0,0,0,.22);
    padding:0 .875rem 0 2.75rem;
  }
  .re-ico{
    position:absolute; left:.875rem; top:50%; transform:translateY(-50%);
    color:#111; opacity:.9;
  }
  .re-caret{
    position:absolute; right:.625rem; top:50%; transform:translateY(-50%);
    color:#111; opacity:.85; pointer-events:none;
  }
  .re-field select{
    appearance:none; width:100%; border:none; outline:none; background:transparent;
    color:#111; font-weight:700; font-size:1rem; cursor:pointer;
  }
  .select:disabled{ opacity:.6; cursor:not-allowed; }

  /* Acciones */
  .re-actions{
    display:grid; gap:.75rem; grid-template-columns:1fr; margin-top:1rem;
  }
  @media (min-width:33.75em){ .re-actions{ grid-template-columns:repeat(3,1fr); } }
  .btn{
    height:2.75rem; border:none; border-radius:999rem; cursor:pointer; font-weight:800; color:#fff;
    background:var(--accent,#c62828);
    box-shadow:0 .75rem 1.5rem rgba(156,15,16,.35);
    transition:.15s transform ease, .15s box-shadow ease, .15s background ease;
  }
  .btn:hover{ transform:translateY(-.125rem); box-shadow:0 1rem 2rem rgba(156,15,16,.45); }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }
  .btn--danger{ background:#c62828; }
  .btn--ghost{ background:#374151; }
  .btn--muted{ background:#6b7280; }

  /* Mensajes flash */
  .re-msg{ margin:.5rem 0; padding:.6rem .9rem; border-radius:.8rem; font-weight:700; }
  .re-msg--ok{ background:#065f46; color:#d1fae5; }
  .re-msg--err{ background:#7f1d1d; color:#fee2e2; }

  /* Toast */
  .toast{
    position:fixed; right:1rem; bottom:1rem; z-index:1000;
    background:#111827; color:#fff; padding:.625rem .75rem; border-radius:.625rem;
    box-shadow:0 .5rem 1.5rem rgba(0,0,0,.25); max-width:60ch;
    opacity:1; transition:opacity .18s ease;
  }
  .toast.hidden{ opacity:0; pointer-events:none; }

  /* Modal de confirmación */
  .backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:grid; place-items:center; z-index:1100;
  }
  .backdrop.hidden{ display:none; }
  .modal{
    width:min(32rem, 92vw);
    background:#0b1220; color:#e5ecf6;
    border:1px solid rgba(255,255,255,.08);
    border-radius:1rem; padding:1rem;
    box-shadow:0 1rem 2.5rem rgba(0,0,0,.45);
  }
  .modal h3{ margin:0 0 .5rem; font-weight:800; font-size:1.1rem; }
  .modal p{ margin:.25rem 0 1rem; color:#e2e8f0; }
  .modal-actions{ display:flex; gap:.75rem; justify-content:flex-end; flex-wrap:wrap; }
</style>
{% endblock %}

{% block content %}
<section class="re" aria-labelledby="titulo-adg">
  <h1 id="titulo-adg" class="re-title text-xl mb-4">Asignación de Docentes a grupos</h1>

  <div class="re-wrap">
    <!-- Columna izquierda (avatar ilustrativo) -->
    <aside class="re-left" aria-label="Ilustración docentes a grupos">
      <div class="re-avatar" aria-hidden="true">
        <i class="fa-solid fa-chalkboard-user"></i>
      </div>
    </aside>

    <!-- Columna derecha -->
    <div class="re-right">
      {% if messages %}
        {% for m in messages %}
          <div class="re-msg {% if m.tags == 'success' %}re-msg--ok{% else %}re-msg--err{% endif %}">
            {{ m }}
          </div>
        {% endfor %}
      {% endif %}

      <div class="re-card">
        <form class="re-form" id="adg-form" autocomplete="off" novalidate>
          {% csrf_token %}

          <!-- DOCENTE -->
          <label class="re-field" for="adg-docente">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-user-tie"></i></span>
            <select id="adg-docente" name="docente_id" class="select" aria-label="Seleccione el docente" required>
              <option value="">Seleccione el docente</option>
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>
          <!-- GRUPO -->
          <label class="re-field" for="adg-grupos">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-users-rectangle"></i></span>
            <select id="adg-grupos" name="grupo_id" class="select" aria-label="Seleccione el grupo" required disabled>
              <option value="">Seleccione el grupo</option>
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- ASIGNATURA -->
          <label class="re-field" for="adg-asignatura">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-book"></i></span>
            <select id="adg-asignatura" name="grupo_asignatura_id" class="select" aria-label="Seleccione la asignatura" required disabled>
              <option value="">Seleccione la asignatura</option>
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>
        </form>

        <!-- Acciones -->
        <div class="re-actions">
          <button type="button" class="btn btn--danger" id="btn-asignar" disabled>Asignar</button>
          <button type="button" class="btn btn--ghost"  id="btn-quitar"  disabled>Quitar asignación</button>
          <button type="reset"  form="adg-form" class="btn btn--muted" id="btn-eliminar">Limpiar</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de confirmación para REEMPLAZAR -->
<div id="modalReemplazo" class="backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Reemplazar docente asignado</h3>
    <p>Ya existe un docente asignado a esa (grupo, asignatura). ¿Deseas reemplazarlo por el seleccionado?</p>
    <div class="modal-actions">
      <button type="button" class="btn btn--ghost"  data-cancel>Cancelar</button>
      <button type="button" class="btn btn--danger" data-confirm>Reemplazar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const $ = (s) => document.querySelector(s);
  const form       = $('#adg-form');
  const docenteSel = $('#adg-docente');
  const grupoSel   = $('#adg-grupos');
  const asigSel    = $('#adg-asignatura');
  const btnAsignar = $('#btn-asignar');
  const btnQuitar  = $('#btn-quitar');

  /* ENDPOINTS */
  const URL_API_DOCENTES        = "{% url 'api_docentes' %}";
  const URL_API_GRUPOS_DOCENTE  = "{% url 'api_grupos_por_docente' %}";
  const URL_API_ASIGS_POR_GRUPO = "{% url 'api_asignaturas_por_grupo' %}";
  const URL_POST_ASIGNAR_ASIG   = "{% url 'rector_asignar_docente_asignatura' %}";
  const URL_POST_QUITAR_ASIG    = "{% url 'rector_quitar_docente_asignatura' %}";
  const URL_POST_VINCULAR_DG    = "{% url 'rector_vincular_docente_grupo' %}";

  /* Utils */
  function clearSelect(sel, placeholder){
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = placeholder;
    sel.appendChild(opt);
  }
  function disable(el, on){ el.disabled = !!on; }
  async function fetchJSON(url){
    const r = await fetch(url, {headers: {'X-Requested-With':'fetch'}});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }
  function getCSRF(){
    return document.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
  }
  function showToast(msg, ok=true) {
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.background = ok ? "#065f46" : "#7f1d1d";
    el.classList.remove("hidden");
    setTimeout(() => el.classList.add("hidden"), 2600);
  }
  async function parseMaybeJSON(resp){
    const ct = resp.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      try { return await resp.json(); } catch { return {}; }
    }
    return {};
  }
  function toggleButtons(){
    const hasDoc = !!docenteSel.value;
    const hasGrp = !!grupoSel.value;
    const hasGA  = !!asigSel.value;
    btnAsignar.disabled = !(hasDoc && hasGrp && hasGA);
    btnQuitar.disabled  = !(hasDoc && hasGA);
  }

  /* Modal de reemplazo */
  const modal = document.getElementById("modalReemplazo");
  let pendingPayload = null;
  const openModal  = () => { modal.classList.remove("hidden"); modal.setAttribute("aria-hidden","false"); };
  const closeModal = () => { modal.classList.add("hidden");    modal.setAttribute("aria-hidden","true");  };

  modal.querySelector("[data-cancel]").addEventListener("click", closeModal);
  modal.querySelector("[data-confirm]").addEventListener("click", async () => {
    if (!pendingPayload) return closeModal();
    try {
      const fd = new FormData();
      Object.entries(pendingPayload).forEach(([k, v]) => fd.append(k, v));
      fd.append("reemplazar", "1");

      const resp = await fetch(URL_POST_ASIGNAR_ASIG, {
        method: "POST",
        headers: { "X-CSRFToken": getCSRF() },
        body: fd
      });

      const data = await parseMaybeJSON(resp);
      if (resp.ok && (data.ok !== false)) showToast(data.msg || "Asignación actualizada.", true);
      else                                 showToast(data.msg || "No se pudo reemplazar la asignación.", false);
    } catch {
      showToast("Error de red al reemplazar.", false);
    } finally {
      pendingPayload = null; closeModal();
    }
  });

  /* Cargar DOCENTES */
  async function cargarDocentes(){
    clearSelect(docenteSel, 'Seleccione el docente');
    try{
      const data = await fetchJSON(URL_API_DOCENTES);
      (data.docentes || []).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.nombre_completo;
        docenteSel.appendChild(opt);
      });
    }catch(e){ console.warn('No se pudieron cargar docentes:', e); }
  }

  /* Cargar GRUPOS por docente */
  async function cargarGruposPorDocente(docente_id){
    clearSelect(grupoSel, 'Seleccione el grupo');
    clearSelect(asigSel,  'Seleccione la asignatura');
    disable(grupoSel, true); disable(asigSel, true); toggleButtons();
    if(!docente_id) return;

    try{
      const data = await fetchJSON(URL_API_GRUPOS_DOCENTE + `?docente_id=${encodeURIComponent(docente_id)}`);
      const lista = (data.grupos || []);
      if (lista.length){
        lista.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id; opt.textContent = g.etiqueta; // "11° 102"
          grupoSel.appendChild(opt);
        });
        disable(grupoSel, false);
      }else{
        const opt = document.createElement('option');
        opt.value=''; opt.textContent='No hay grupos en la sede del docente'; opt.disabled=true;
        grupoSel.appendChild(opt);
      }
    }catch(e){ console.warn('No se pudieron cargar grupos:', e); }
  }

  /* Cargar ASIGNATURAS por grupo */
  async function cargarAsignaturasPorGrupo(grupo_id){
    clearSelect(asigSel, 'Seleccione la asignatura');
    disable(asigSel, true); toggleButtons();
    if(!grupo_id) return;

    try{
      const data = await fetchJSON(URL_API_ASIGS_POR_GRUPO + `?grupo_id=${encodeURIComponent(grupo_id)}`);
      const lista = data.asignaturas || [];
      if (lista.length){
        lista.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.ga_id;  opt.textContent = a.nombre;
          asigSel.appendChild(opt);
        });
        disable(asigSel, false);
      }else{
        const opt = document.createElement('option');
        opt.value=''; opt.textContent='No hay asignaturas para este grupo'; opt.disabled=true;
        asigSel.appendChild(opt);
      }
    }catch(e){ console.warn('No se pudieron cargar asignaturas:', e); }
  }

  /* Vincular docente↔grupo si hace falta */
  async function ensureVinculo(docente_id, grupo_id) {
    const fd = new FormData();
    fd.append("docente_id", docente_id);
    fd.append("grupo_id",   grupo_id);

    const resp = await fetch(URL_POST_VINCULAR_DG, {
      method: "POST",
      headers: { "X-CSRFToken": getCSRF() },
      body: fd
    });

    const data = await parseMaybeJSON(resp);
    if (!resp.ok || (data.ok === false)) throw new Error(data?.msg || "No se pudo vincular docente con grupo.");
    if (data.created) showToast("Vinculado docente↔grupo.", true);
  }

  /* Eventos */
  docenteSel.addEventListener('change', () => { cargarGruposPorDocente(docenteSel.value); toggleButtons(); });
  grupoSel.addEventListener('change',   () => { cargarAsignaturasPorGrupo(grupoSel.value); toggleButtons(); });
  asigSel.addEventListener('change', toggleButtons);

  form.addEventListener('reset', () => {
    setTimeout(() => {
      clearSelect(grupoSel, 'Seleccione el grupo');
      clearSelect(asigSel,  'Seleccione la asignatura');
      disable(grupoSel, true); disable(asigSel, true); toggleButtons();
    }, 0);
  });

  /* Asignar */
  btnAsignar.addEventListener('click', async () => {
    const docente_id = docenteSel.value, grupo_id = grupoSel.value, ga_id = asigSel.value;
    if(!docente_id || !grupo_id || !ga_id){ alert('Selecciona docente, grupo y asignatura.'); return; }
    try{
      btnAsignar.disabled = true;
      await ensureVinculo(docente_id, grupo_id);

      const fd = new FormData();
      fd.append("docente_id", docente_id);
      fd.append("grupo_id",   grupo_id);
      fd.append("grupo_asignatura_id", ga_id);

      const r = await fetch(URL_POST_ASIGNAR_ASIG, { method:'POST', headers:{'X-CSRFToken': getCSRF()}, body: fd });

      if (r.status === 409) { pendingPayload = { docente_id, grupo_id, grupo_asignatura_id: ga_id }; openModal(); return; }

      const data = await parseMaybeJSON(r);
      if (!r.ok || (data.ok === false)) { showToast(data.msg || "No se pudo asignar.", false); return; }
      showToast(data.msg || "Asignación registrada.", true);
    }catch(e){
      showToast(e.message || 'Error de red al asignar.', false);
    } finally { btnAsignar.disabled = false; toggleButtons(); }
  });

  /* Quitar */
  btnQuitar.addEventListener('click', async () => {
    const docente_id = docenteSel.value, ga_id = asigSel.value;
    if(!docente_id || !ga_id){ alert('Selecciona docente y asignatura.'); return; }
    if(!confirm('¿Quitar esta asignación del docente?')) return;
    try{
      btnQuitar.disabled = true;
      const fd = new FormData();
      fd.append("docente_id", docente_id);
      fd.append("grupo_asignatura_id", ga_id);

      const r = await fetch(URL_POST_QUITAR_ASIG, { method:'POST', headers:{'X-CSRFToken': getCSRF()}, body: fd });
      const data = await parseMaybeJSON(r);
      if (!r.ok || (data.ok === false)) { showToast(data.msg || "No se pudo eliminar la asignación.", false); return; }
      showToast(data.msg || "Asignación eliminada.", true);
    }catch(_){
      showToast('Error de red al eliminar.', false);
    } finally { btnQuitar.disabled = false; toggleButtons(); }
  });

  /* Hacer clickeable toda la franja del select */
  document.querySelectorAll('.re-field').forEach(label => {
    if (!label.hasAttribute('tabindex')) label.tabIndex = 0;
    const sel = label.querySelector('select'); if (!sel) return;

    label.addEventListener('click', (ev) => {
      if (ev.target === sel || sel.disabled) return;
      ev.preventDefault(); sel.focus();
      if (typeof sel.showPicker === 'function') { try { sel.showPicker(); } catch(_) {} }
      try { sel.click(); } catch(_) {}
    });

    label.addEventListener('keydown', (ev) => {
      if (ev.key === 'Enter' || ev.key === ' ') {
        ev.preventDefault(); if (sel.disabled) return;
        sel.focus();
        if (typeof sel.showPicker === 'function') { try { sel.showPicker(); } catch(_) {} }
        try { sel.click(); } catch(_) {}
      }
    });
  });

  /* Init */
  cargarDocentes();
})();
</script>
{% endblock %}
