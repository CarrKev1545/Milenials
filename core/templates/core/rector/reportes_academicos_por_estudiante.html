{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Reportes académicos — Por estudiante{% endblock %}

{% block extra_css %}
<style>
  /* ===== Barra roja ===== */
  .page-title{
    position:sticky; top:var(--navbar-height); z-index:40;
    background:var(--accent); color:#fff; font-weight:800; letter-spacing:.2px;
    text-align:center; padding:10px 12px; box-shadow:0 4px 12px rgba(0,0,0,.35);
  }

  /* ===== Panel glass ===== */
  .np{ width:100%; max-width:1280px; margin:0 auto; padding-inline:clamp(12px,3vw,20px); }
  .np-wrap{ position:relative; margin-top:14px; display:block; }
  .np-wrap::before{
    content:""; position:absolute; inset:-18px -22px; border-radius:18px;
    background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(6px) saturate(115%);
    box-shadow:0 22px 44px rgba(0,0,0,.50);
    z-index:0; pointer-events:none;
  }
  .np-inner{
    position:relative; z-index:1;
    padding:28px 24px 24px;
    text-align: initial;
  }

  /* ===== Badge ===== */
  .np-badge{
    width: clamp(240px, 92%, 360px);
    margin: -22px auto 0;
    background:#0c0c0c; border-radius:16px;
    box-shadow:0 16px 30px rgba(0,0,0,.55), inset 0 -8px 22px rgba(0,0,0,.22);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:18px 16px 12px; position:relative;
  }
  @media (min-width:900px){
    .np-badge{
      width: clamp(260px, 28vw, 420px);
      left:50%; transform:translateX(-50%);
      margin-left:0 !important; margin-right:0 !important;
    }
  }
  .np-badge i{ font-size:82px; color:#fff; line-height:1; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)); }
  .np-chip{
    margin-top:12px; background:var(--accent); color:#fff; padding:8px 18px;
    border-radius:999px; font-weight:800; letter-spacing:.2px; box-shadow:0 12px 24px rgba(0,0,0,.45);
  }

  /* ===== Grid ===== */
  .np-grid{ margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:14px 20px; align-items:center; }
  @media (max-width:1020px){ .np-grid{ grid-template-columns:1fr; } }

  /* ===== Campos ===== */
  .np-field{
    position: relative;
    display: flex; align-items: center;
    height: 48px;
    padding: 0;
    background:#fff; border-radius:14px; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 10px 20px rgba(0,0,0,.22);
    width:100%;
    cursor: pointer;
  }
  .np-field select{
    position: absolute; inset: 0;
    width: 100%; height: 100%;
    appearance: none;
    border: 0; outline: none; background: transparent;
    color:#111; font-weight:600; cursor: pointer;
    padding-left: 50px; padding-right: 36px;
  }
  .np-field input{
    width: 100%;
    border: 0; outline: none; background: transparent;
    color:#111; font-weight:600; padding-left: 50px;
  }
  .np-field input[readonly]{ background:#f7f7f7; cursor:not-allowed; }
  .np-ico{ position:absolute; left:14px; top:50%; transform:translateY(-50%); width:26px; display:grid; place-items:center; color:#111; opacity:.95; }
  .np-caret{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    color:#111; opacity:.85; pointer-events: none;
  }

  /* ===== Acciones ===== */
  .np-actions{ margin-top:6px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  .np-btn{
    height:48px; min-width:180px; border-radius:12px; border:none; cursor:pointer; font-weight:800; color:#fff;
    background:var(--accent); box-shadow:0 12px 22px rgba(156,15,16,.38);
    transition:.12s transform ease,.12s box-shadow ease,.12s background ease;
  }
  .np-btn:hover{ transform:translateY(-2px); box-shadow:0 18px 28px rgba(156,15,16,.48); }
  .np-btn:active{ transform: translateY(0) scale(.985); }
  .np-btn--ghost{ background:#b51415; }

  /* Selector PDF/Excel */
  #formato{
    height:48px; border-radius:12px; padding:0 12px;
    background:#222; color:#fff; border:1px solid rgba(255,255,255,.18);
    box-shadow:0 12px 22px rgba(0,0,0,.35);
    min-width:130px; font-weight:700;
  }
  #formato:focus{ outline:none; box-shadow:0 0 0 3px rgba(255,255,255,.18), 0 12px 22px rgba(0,0,0,.35); }

  @media (max-width:360px){
    .np-badge i{ font-size:68px; }
    .np-chip{ padding:6px 14px; }
  }
</style>
{% endblock %}

{% block page_banner %}
  <div class="page-title">Reportes académicos</div>
{% endblock %}

{% block content %}
<main class="main" role="main">
  <section class="np" aria-label="Reportes por estudiante">
    <div class="np-wrap">
      <div class="np-inner">
        <div class="np-badge" aria-hidden="true">
          <i class="fa-solid fa-user-graduate"></i>
          <div class="np-chip">POR ESTUDIANTE</div>
        </div>

        <!-- Filtrado -->
        <form id="filtros-form" class="np-grid" method="get" action="{% url 'rector_reportes_academicos_tabla' %}">
          <!-- Sede -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-building-columns"></i></span>
            <select id="sede_id" name="sede_id" aria-label="Seleccione la sede">
              <option value="">Seleccione la sede</option>
            </select>
            <span class="np-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Estudiante -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-user-graduate"></i></span>
            <select id="estudiante_id" name="estudiante_id" aria-label="Seleccione estudiante" disabled>
              <option value="">Seleccione estudiante</option>
            </select>
          </label>

          <!-- Grado -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-sitemap"></i></span>
            <select id="grado_id" name="grado_id" aria-label="Seleccione el grado" disabled>
              <option value="">Grado</option>
            </select>
            <span class="np-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Nombre (solo lectura) -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-id-card"></i></span>
            <input id="estudiante_nombre" type="text" name="nombre" placeholder="Nombre del estudiante" aria-label="Nombre del estudiante" readonly />
          </label>

          <!-- Grupo -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-people-roof"></i></span>
            <select id="grupo_id" name="grupo_id" aria-label="Seleccione el grupo" disabled>
              <option value="">Grupo</option>
            </select>
            <span class="np-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Periodo (opcional) -->
          <label class="np-field">
            <span class="np-ico"><i class="fa-solid fa-calendar-days"></i></span>
            <select id="periodo_id" name="periodo_id" aria-label="Seleccione periodo" disabled>
              <option value="">Periodo (opcional)</option>
            </select>
            <span class="np-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <div class="np-actions" style="grid-column:1/-1;">
            <button type="button" class="np-btn" id="btn-descargar">Descargar</button>
            <select id="formato" class="np-input" style="height:48px;border-radius:12px;padding:0 12px;">
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
            </select>
            <button type="reset" class="np-btn np-btn--ghost">Limpiar</button>
          </div>

          <!-- TEXTOS legibles para chip -->
          <input type="hidden" name="sede">
          <input type="hidden" name="grado">
          <input type="hidden" name="grupo">
          <input type="hidden" name="estudiante">
          <input type="hidden" name="periodo">
        </form>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
  const $ = s => document.querySelector(s);
  const setSelect = (el, items, placeholder="Seleccione") => {
    el.innerHTML = `<option value="">${placeholder}</option>`;
    (items || []).forEach(it => el.insertAdjacentHTML(
      'beforeend',
      `<option value="${it.id}">${it.nombre || (it.apellidos + " " + it.nombre)}</option>`
    ));
  };
  const enable = (el, on=true) => el.disabled = !on;

  // Elements
  const sedeSel    = $('#sede_id');
  const gradoSel   = $('#grado_id');
  const grupoSel   = $('#grupo_id');
  const periodoSel = $('#periodo_id');
  const estSel     = $('#estudiante_id');
  const estNombre  = $('#estudiante_nombre');

  // Hidden (textos)
  const hSede  = document.querySelector('input[name="sede"]');
  const hGrado = document.querySelector('input[name="grado"]');
  const hGrupo = document.querySelector('input[name="grupo"]');
  const hEst   = document.querySelector('input[name="estudiante"]');
  const hPer   = document.querySelector('input[name="periodo"]');

  // State
  const st = { sede_id:"", grado_id:"", grupo_id:"", periodo_id:"", estudiante_id:"" };

  // Init: sedes + periodos
  (async function init(){
    try{
      const sedes = await fetch("{% url 'api_sedes' %}").then(r=>r.json());
      setSelect(sedeSel, sedes.sedes, "Seleccione la sede"); enable(sedeSel, true);

      const pers  = await fetch("{% url 'api_periodos_abiertos' %}").then(r=>r.json());
      setSelect(periodoSel, pers.periodos, "Periodo"); enable(periodoSel, true);
    }catch(e){ console.error(e); }
  })();

  // Sede -> grados
  sedeSel.addEventListener('change', async e=>{
    st.sede_id = e.target.value || "";
    hSede.value = sedeSel.options[sedeSel.selectedIndex]?.text || "";

    setSelect(gradoSel, [], "Grado");  enable(gradoSel, false);
    setSelect(grupoSel, [], "Grupo");  enable(grupoSel, false);
    setSelect(estSel,   [], "Seleccione estudiante"); enable(estSel, false);
    estNombre.value = ""; st.estudiante_id = "";

    if(!st.sede_id) return;

    try{
      const g = await fetch("{% url 'api_grados_por_sede' %}?sede_id="+st.sede_id).then(r=>r.json());
      setSelect(gradoSel, g.grados, "Grado"); enable(gradoSel, true);
    }catch(e){ console.error(e); }
  });

  // Grado -> grupos
  gradoSel.addEventListener('change', async e=>{
    st.grado_id = e.target.value || "";
    hGrado.value = gradoSel.options[gradoSel.selectedIndex]?.text || "";

    setSelect(grupoSel, [], "Grupo"); enable(grupoSel, false);
    setSelect(estSel,   [], "Seleccione estudiante"); enable(estSel, false);
    estNombre.value = ""; st.estudiante_id = "";

    if(!st.grado_id || !st.sede_id) return;

    try{
      const url = "{% url 'api_grupos_por_sede_grado' %}?sede_id="+st.sede_id+"&grado_id="+st.grado_id;
      const g = await fetch(url).then(r=>r.json());
      setSelect(grupoSel, g.grupos, "Grupo"); enable(grupoSel, true);
    }catch(e){ console.error(e); }
  });

  // Grupo -> estudiantes
  grupoSel.addEventListener('change', async e=>{
    st.grupo_id = e.target.value || "";
    hGrupo.value = grupoSel.options[grupoSel.selectedIndex]?.text || "";

    setSelect(estSel, [], "Seleccione estudiante"); enable(estSel, false);
    estNombre.value = ""; st.estudiante_id = "";

    if(!st.grupo_id) return;

    try{
      const eg = await fetch("{% url 'api_estudiantes_por_grupo' %}?grupo_id="+st.grupo_id).then(r=>r.json());
      const opts = (eg.estudiantes || []).map(e => ({ id: e.id, nombre: `${e.apellidos} ${e.nombre}`.trim() }));
      setSelect(estSel, opts, "Seleccione estudiante"); enable(estSel, true);
    }catch(e){ console.error(e); }
  });

  // Periodo (opcional)
  periodoSel.addEventListener('change', e=>{
    st.periodo_id = e.target.value || "";
    hPer.value = periodoSel.options[periodoSel.selectedIndex]?.text || "";
  });

  // Estudiante -> nombre readonly + hidden
  estSel.addEventListener('change', e=>{
    st.estudiante_id = e.target.value || "";
    const nombre = estSel.options[estSel.selectedIndex]?.text || "";
    estNombre.value = nombre;
    hEst.value = nombre;
  });

  /* ====== Descarga (en otra pestaña) ====== */
  document.getElementById('btn-descargar').addEventListener('click', ()=>{
    const grupo   = document.getElementById('grupo_id').value;
    const periodo = document.getElementById('periodo_id').value; // opcional
    const est     = document.getElementById('estudiante_id').value;
    const formato = document.getElementById('formato').value || 'pdf';

    // Requisitos: grupo y estudiante; periodo es opcional
    if(!grupo || !est){
      alert('Seleccione grupo y estudiante');
      return;
    }
    const q = new URLSearchParams({ grupo_id: grupo, estudiante_id: est, formato });
    if (periodo) q.set('periodo_id', periodo);

    const url = "{% url 'rector_reportes_academicos_export' %}?"+q.toString();
    window.open(url, '_blank', 'noopener'); // 👉 abre en otra pestaña
  });

  // Reset visual + hidden
  document.querySelector('#filtros-form').addEventListener('reset', ()=>{
    setTimeout(()=>{
      hSede.value = hGrado.value = hGrupo.value = hEst.value = hPer.value = "";
      estNombre.value = "";
      st.sede_id = st.grado_id = st.grupo_id = st.estudiante_id = st.periodo_id = "";
      setSelect(gradoSel, [], "Grado"); enable(gradoSel, false);
      setSelect(grupoSel, [], "Grupo"); enable(grupoSel, false);
      setSelect(estSel,   [], "Seleccione estudiante"); enable(estSel, false);
    },0);
  });
</script>
{% endblock %}
