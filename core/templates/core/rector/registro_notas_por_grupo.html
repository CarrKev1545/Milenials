{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Registro de notas — Por grupo{% endblock %}

{% block extra_css %}
<style>
  /* ===== Barra roja ===== */
  .page-title{
    position: sticky;
    top: var(--navbar-height);
    z-index: 40;
    background: var(--accent);
    color: #fff;
    font-weight: 800;
    letter-spacing: .2px;
    text-align: center;
    padding: 10px 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,.35);
  }

  /* ===== Panel glass ===== */
  .rg{ width:100%; max-width:1280px; margin:0 auto; padding-inline: clamp(12px, 3vw, 20px); }
  .rg-wrap{ position:relative; margin-top:14px; display:block; }
  .rg-wrap::before{
    content:""; position:absolute; inset:-18px -22px; border-radius:18px;
    background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(6px) saturate(115%);
    box-shadow:0 22px 44px rgba(0,0,0,.50);
    z-index:0;
    pointer-events:none; /* el “glass” no intercepta clics */
  }
  .rg-inner{
    position:relative; z-index:1; text-align:initial;
    padding:28px 24px 24px;
    padding-bottom:max(96px, env(safe-area-inset-bottom, 24px));
  }

  /* ===== Badge centrado (móvil + desktop) ===== */
  .rg-badge{
    width:clamp(220px,64vw,340px);
    margin:-22px auto 0;
    background:#0c0c0c; border-radius:16px;
    box-shadow:0 16px 30px rgba(0,0,0,.55), inset 0 -8px 22px rgba(0,0,0,.22);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:18px 16px 12px; position:relative;
    left:50%; transform:translateX(-50%);
  }
  @media (max-width:400px){
    .rg-badge i{ font-size:64px; }
    .rg-chip{ padding:6px 14px; font-size:.95rem; }
  }
  @media (min-width:900px){
    .rg-badge{ left:50%; transform:translateX(-50%); margin-left:0!important; margin-right:0!important; }
  }
  .rg-badge i{ font-size:82px; color:#fff; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)); }
  .rg-chip{ margin-top:12px; background:var(--accent); color:#fff; padding:8px 18px; border-radius:999px; font-weight:800; letter-spacing:.2px; }

  /* ===== Grid de campos ===== */
  .rg-grid{ margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:14px 20px; align-items:center; }
  @media (max-width:1020px){ .rg-grid{ grid-template-columns:1fr; } }

  /* ===== Campos ===== */
  .rg-field{
    position:relative; display:flex; align-items:center; gap:10px;
    height:48px; padding:0 36px 0 16px; /* menos padding izq al ocultar icono */
    background:#fff; border-radius:14px; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 10px 20px rgba(0,0,0,.22); width:100%;
    cursor:pointer; /* para indicar que toda la franja es interactiva */
  }
  .rg-field select{
    appearance:none; width:100%; border:none; outline:none; background:transparent;
    color:#111; font-weight:600; cursor:pointer;
  }
  .rg-ico{ display:none; } /* ocultamos el icono de la izquierda */
  .rg-caret{ position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#111; opacity:.85; pointer-events:none; }

  /* ===== Acciones ===== */
  .rg-actions{
    position:sticky; bottom:calc(12px + env(safe-area-inset-bottom, 0px)); z-index:2;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.12) 45%, rgba(0,0,0,.22));
    padding-top:8px; display:grid; gap:12px; grid-template-columns:1fr;
  }
  @media (min-width:560px){ .rg-actions{ grid-template-columns:1fr 1fr; } }

  .rg-btn{
    height:48px; border-radius:12px; border:none; cursor:pointer; font-weight:800; color:#fff;
    background:var(--accent); box-shadow:0 12px 22px rgba(156,15,16,.38);
    transition:.12s transform ease,.12s box-shadow ease,.12s background ease;
    width:100%; min-width:0;
  }
  .rg-btn:hover{ transform:translateY(-2px); box-shadow:0 18px 28px rgba(156,15,16,.48); }
  .rg-btn:active{ transform:translateY(0) scale(.985); }
  .rg-btn--ghost{ background:#b51415; }
  .disabled{ opacity:.55; pointer-events:none; }
</style>
{% endblock %}

{% block page_banner %}
  <div class="page-title">Registro de notas</div>
{% endblock %}

{% block content %}
<main class="main" role="main">
  <section class="rg" aria-label="Filtros por grupo">
    <div class="rg-wrap">
      <div class="rg-inner">
        <div class="rg-badge" aria-hidden="true">
          <i class="fa-solid fa-people-group"></i>
          <div class="rg-chip">POR GRUPO</div>
        </div>

        <form id="form-grupo" class="rg-grid" autocomplete="off" novalidate>
          <!-- SEDE -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-building-columns"></i></span>
            <select id="sede" name="sede_id" required>
              <option value="">Seleccione la sede</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- ÁREA -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-list"></i></span>
            <select id="area" name="area_id" required disabled>
              <option value="">Seleccione el área</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- GRADO -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-sitemap"></i></span>
            <select id="grado" name="grado_id" required disabled>
              <option value="">Seleccione el grado</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- ASIGNATURA -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-book-open-reader"></i></span>
            <select id="asignatura" name="asignatura_id" required disabled>
              <option value="">Seleccione la asignatura</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- GRUPO -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-people-roof"></i></span>
            <select id="grupo" name="grupo_id" required disabled>
              <option value="">Seleccione el grupo</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- PERIODO -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-calendar-days"></i></span>
            <select id="periodo" name="periodo_id" required disabled>
              <option value="">Seleccione periodo</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>
        </form>

        <div class="rg-actions">
          <button type="button" class="rg-btn disabled" id="btn-buscar" aria-disabled="true">Buscar</button>
          <button type="button" class="rg-btn rg-btn--ghost" id="btn-limpiar">Eliminar</button>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block extra_js %}
<script>
  const $sede = document.getElementById('sede');
  const $grado = document.getElementById('grado');
  const $grupo = document.getElementById('grupo');
  const $area = document.getElementById('area');
  const $asignatura = document.getElementById('asignatura');
  const $periodo = document.getElementById('periodo');
  const $buscar = document.getElementById('btn-buscar');

  const disable = ($el, yes=true) => { $el.disabled = yes; if (yes) $el.value = ''; };

  const enableBuscarIfReady = () => {
    const ok = $sede.value && $grado.value && $grupo.value && $area.value && $asignatura.value && $periodo.value;
    $buscar.classList.toggle('disabled', !ok);
    $buscar.setAttribute('aria-disabled', String(!ok));
  };

  // 1) sedes
  fetch("{% url 'api_sedes' %}").then(r => r.json()).then(({sedes}) => {
    for (const s of sedes) {
      const o = document.createElement('option'); o.value = s.id; o.textContent = s.nombre;
      $sede.appendChild(o);
    }
  });

  // 2) sede -> grados + periodos
  $sede.addEventListener('change', async () => {
    disable($grado); disable($grupo); disable($area); disable($asignatura); disable($periodo);
    $grado.innerHTML = '<option value="">Seleccione el grado</option>';
    $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
    $area.innerHTML = '<option value="">Seleccione el área</option>';
    $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';
    $periodo.innerHTML = '<option value="">Seleccione periodo</option>';

    if (!$sede.value) { enableBuscarIfReady(); return; }

    const g = await fetch("{% url 'api_grados_por_sede' %}?sede_id=" + $sede.value).then(r=>r.json());
    for (const it of g.grados) {
      const o = document.createElement('option'); o.value = it.id; o.textContent = it.nombre;
      $grado.appendChild(o);
    }
    disable($grado, false);

    const p = await fetch("{% url 'api_periodos_abiertos' %}").then(r=>r.json());
    for (const it of p.periodos) {
      const o = document.createElement('option'); o.value = it.id; o.textContent = it.nombre;
      $periodo.appendChild(o);
    }
    disable($periodo, false);

    enableBuscarIfReady();
  });

  // 3) grado -> grupos
  $grado.addEventListener('change', async () => {
    disable($grupo); disable($area); disable($asignatura);
    $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
    $area.innerHTML = '<option value="">Seleccione el área</option>';
    $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

    if (!$sede.value || !$grado.value) { enableBuscarIfReady(); return; }

    const resp = await fetch("{% url 'api_grupos_por_sede_grado' %}?sede_id=" + $sede.value + "&grado_id=" + $grado.value).then(r=>r.json());
    for (const it of resp.grupos) {
      const o = document.createElement('option'); o.value = it.id; o.textContent = it.nombre;
      $grupo.appendChild(o);
    }
    disable($grupo, false);
    enableBuscarIfReady();
  });

  // 4) grupo -> áreas
  $grupo.addEventListener('change', async () => {
    disable($area); disable($asignatura);
    $area.innerHTML = '<option value="">Seleccione el área</option>';
    $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

    if (!$grupo.value) { enableBuscarIfReady(); return; }

    const resp = await fetch("{% url 'api_areas_por_grupo' %}?grupo_id=" + $grupo.value).then(r=>r.json());
    for (const it of resp.areas) {
      const o = document.createElement('option'); o.value = it.id; o.textContent = it.nombre;
      $area.appendChild(o);
    }
    disable($area, false);
    enableBuscarIfReady();
  });

  // 5) área -> asignaturas
  $area.addEventListener('change', async () => {
    disable($asignatura);
    $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

    if (!$area.value) { enableBuscarIfReady(); return; }

    const url = "{% url 'api_asignaturas_por_grupo_area' %}?grupo_id=" + $grupo.value + "&area_id=" + $area.value;
    const resp = await fetch(url).then(r=>r.json());
    for (const it of resp.asignaturas) {
      const o = document.createElement('option'); o.value = it.id; o.textContent = it.nombre;
      $asignatura.appendChild(o);
    }
    disable($asignatura, false);
    enableBuscarIfReady();
  });

  // 6) habilitar buscar cuando cambie algo
  $periodo.addEventListener('change', enableBuscarIfReady);
  [$sede,$grado,$grupo,$area,$asignatura].forEach(el => el.addEventListener('change', enableBuscarIfReady));

  // Buscar
  $buscar.addEventListener('click', () => {
    if ($buscar.classList.contains('disabled')) return;
    const params = new URLSearchParams(new FormData(document.getElementById('form-grupo')));
    window.location.href = "{% url 'rector_reporte_notas_tabla' %}?" + params.toString();
  });

  // Limpiar
  document.getElementById('btn-limpiar')?.addEventListener('click', () => {
    document.getElementById('form-grupo').reset();
    [$grado,$grupo,$area,$asignatura,$periodo].forEach(e=>{
      e.innerHTML = e.querySelector('option').outerHTML;
      e.disabled = true;
    });
    enableBuscarIfReady();
  });

  /* ====== Toque en cualquier parte del cuadro para abrir el select ====== */
  function openPicker(el){
    if (!el || el.disabled) return;
    try{
      if (typeof el.showPicker === 'function') { el.showPicker(); return; }
    }catch(_){}
    el.focus();
    // Fallback razonable para navegadores que no soportan showPicker
    el.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
    el.click();
  }

  document.querySelectorAll('.rg-field').forEach(lbl=>{
    const sel = lbl.querySelector('select');
    const inp = lbl.querySelector('input');
    if (sel){
      lbl.addEventListener('click', (e)=>{
        if (e.target.tagName.toLowerCase() !== 'select') {
          e.preventDefault();
          openPicker(sel);
        }
      });
    }else if (inp){
      lbl.addEventListener('click', (e)=>{
        if (e.target !== inp){ inp.focus(); }
      });
    }
  });
</script>
{% endblock %}
