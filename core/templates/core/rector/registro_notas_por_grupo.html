{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de notas — Por grupo</title>

  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .page-title{position:sticky;top:var(--navbar-height);z-index:40;background:var(--accent);color:#fff;font-weight:800;letter-spacing:.2px;text-align:center;padding:10px 12px;box-shadow:0 4px 12px rgba(0,0,0,.35)}
    .rg{width:100%;max-width:1280px;margin:0 auto;padding:0 20px}
    .rg-wrap{position:relative;margin-top:14px}
    .rg-wrap::before{content:"";position:absolute;inset:-18px -22px;border-radius:18px;background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
      border:1px solid rgba(255,255,255,.10);backdrop-filter: blur(6px) saturate(115%);
      box-shadow:0 22px 44px rgba(0,0,0,.50);z-index:0}
    .rg-inner{position:relative;z-index:1;padding:28px 24px 24px}
    .rg-badge{width:370px;max-width:90vw;margin:0 auto;margin-top:-22px;background:#0c0c0c;border-radius:16px;
      box-shadow:0 16px 30px rgba(0,0,0,.55), inset 0 -8px 22px rgba(0,0,0,.22);
      display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px 16px 12px}
    .rg-badge i{font-size:82px;color:#fff;filter:drop-shadow(0 10px 30px rgba(0,0,0,.6))}
    .rg-chip{margin-top:12px;background:var(--accent);color:#fff;padding:8px 18px;border-radius:999px;font-weight:800;letter-spacing:.2px}
    .rg-grid{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:14px 20px;align-items:center}
    .rg-field{position:relative;display:flex;align-items:center;gap:10px;height:48px;padding:0 14px 0 50px;background:#fff;border-radius:14px;border:1px solid rgba(0,0,0,.06);box-shadow:0 10px 20px rgba(0,0,0,.22);width:100%}
    .rg-field select{appearance:none;width:100%;border:none;outline:none;background:transparent;color:#111;font-weight:600}
    .rg-ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:26px;display:grid;place-items:center;color:#111;opacity:.95}
    .rg-caret{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#111;opacity:.85}
    .rg-actions{margin-top:18px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
    .rg-btn{height:48px;min-width:180px;border-radius:12px;border:none;cursor:pointer;font-weight:800;color:#fff;background:var(--accent);box-shadow:0 12px 22px rgba(156,15,16,.38);transition:.12s transform ease,.12s box-shadow ease,.12s background ease}
    .rg-btn:hover{transform:translateY(-2px);box-shadow:0 18px 28px rgba(156,15,16,.48)}
    .rg-btn:active{transform:translateY(0) scale(.985)}
    .rg-btn--ghost{background:#b51415}
    .disabled{opacity:.55;pointer-events:none}
    @media (max-width:1020px){ .rg-grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar" id="navbar" role="navigation" aria-label="Barra principal">
    <div class="nav-left">
      <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menú" aria-controls="main-menu" aria-expanded="false">
        <i class="fa-solid fa-bars"></i>
      </button>

      <img src="{% static 'img/logo2.jpeg' %}" alt="Logo colegio" class="logo">

      <div class="nav-title">
        <h3>RECTOR / <span class="nowrap">COORDINADOR</span></h3>
        <span class="user-name">{{ request.user.usuario }}</span>
      </div>
    </div>

    <nav class="nav-menu" id="main-menu" aria-label="Menú principal">
      <a href="{% url 'dashboard_rector' %}">Inicio</a>
      <a href="{% url 'rector_estudiantes_a_grupos' %}">Estudiante a grupos</a>
      <a href="{% url 'rector_asignacion_docentes_grupos' %}">Asignación de Docentes a grupos</a>
    </nav>

    <div class="nav-right">
      <a href="{% url 'logout' %}" class="btn-logout">Cerrar Sesión</a>
    </div>

    <!-- Fondo oscuro para el menú en móvil -->
    <div class="nav-backdrop" id="nav-backdrop" hidden></div>
  </header>

  <!-- Barra roja -->
  <div class="page-title">Registro de notas</div>

  <!-- CONTENIDO -->
  <main class="main" role="main">
    <section class="rg" aria-label="Filtros por grupo">
      <div class="rg-wrap">
        <div class="rg-inner">
          <div class="rg-badge" aria-hidden="true">
            <i class="fa-solid fa-people-group"></i>
            <div class="rg-chip">POR GRUPO</div>
          </div>

          <form id="form-grupo" class="rg-grid" autocomplete="off" novalidate>
            <!-- SEDE -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-building-columns"></i></span>
              <select id="sede" name="sede_id" required>
                <option value="">Seleccione la sede</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <!-- ÁREA -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-list"></i></span>
              <select id="area" name="area_id" required disabled>
                <option value="">Seleccione el área</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <!-- GRADO -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-sitemap"></i></span>
              <select id="grado" name="grado_id" required disabled>
                <option value="">Seleccione el grado</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <!-- ASIGNATURA -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-book-open-reader"></i></span>
              <select id="asignatura" name="asignatura_id" required disabled>
                <option value="">Seleccione la asignatura</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <!-- GRUPO -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-people-roof"></i></span>
              <select id="grupo" name="grupo_id" required disabled>
                <option value="">Seleccione el grupo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <!-- PERIODO -->
            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-calendar-days"></i></span>
              <select id="periodo" name="periodo_id" required disabled>
                <option value="">Seleccione periodo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>
          </form>

          <div class="rg-actions">
            <button type="button" class="rg-btn disabled" id="btn-buscar" aria-disabled="true">Buscar</button>
            <button type="button" class="rg-btn rg-btn--ghost" id="btn-limpiar">Eliminar</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo" aria-label="Pie de página del sitio">
    <div class="footer-inner">
      <div class="footer-left">
        <img src="{% static 'img/logo2.jpeg' %}" alt="Logo colegio" class="footer-logo">
        <div class="footer-school">
          <div class="school-name">Nombre del Colegio</div>
          <div class="school-sub">Sede / Ciudad</div>
        </div>
      </div>
      <div class="footer-center">
        <div>Dirección: Calle Falsa 123</div>
        <div>Tel: (+57) 300 000 0000 · Email: info@colegio.edu.co</div>
      </div>
      <div class="footer-right">
        <nav class="footer-links">
          <a href="#">Privacidad</a><a href="#">Términos</a><a href="#">Contacto</a>
        </nav>
        <div class="copyright">© {% now "Y" %} Nombre del Colegio</div>
      </div>
    </div>
  </footer>

  <script>
    const $sede = document.getElementById('sede');
    const $grado = document.getElementById('grado');
    const $grupo = document.getElementById('grupo');
    const $area = document.getElementById('area');
    const $asignatura = document.getElementById('asignatura');
    const $periodo = document.getElementById('periodo');
    const $buscar = document.getElementById('btn-buscar');

    const disable = ($el, yes=true) => {
      $el.disabled = yes;
      if (yes) $el.value = '';
    };

    const enableBuscarIfReady = () => {
      const ok = $sede.value && $grado.value && $grupo.value && $area.value && $asignatura.value && $periodo.value;
      $buscar.classList.toggle('disabled', !ok);
      $buscar.setAttribute('aria-disabled', String(!ok));
    };

    // 1) sedes
    fetch("{% url 'api_sedes' %}")
      .then(r => r.json()).then(({sedes}) => {
        for (const s of sedes) {
          const o = document.createElement('option');
          o.value = s.id; o.textContent = s.nombre;
          $sede.appendChild(o);
        }
      });

    // 2) al cambiar sede -> grados + grupos (limpia dependientes)
    $sede.addEventListener('change', async () => {
      disable($grado); disable($grupo); disable($area); disable($asignatura); disable($periodo);
      $grado.innerHTML = '<option value="">Seleccione el grado</option>';
      $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
      $area.innerHTML = '<option value="">Seleccione el área</option>';
      $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';
      $periodo.innerHTML = '<option value="">Seleccione periodo</option>';

      if (!$sede.value) { enableBuscarIfReady(); return; }

      // grados por sede
      const g = await fetch("{% url 'api_grados_por_sede' %}?sede_id=" + $sede.value).then(r=>r.json());
      for (const it of g.grados) {
        const o = document.createElement('option');
        o.value = it.id; o.textContent = it.nombre;
        $grado.appendChild(o);
      }
      disable($grado, false);

      // periodos (abre todos los abiertos)
      const p = await fetch("{% url 'api_periodos_abiertos' %}").then(r=>r.json());
      for (const it of p.periodos) {
        const o = document.createElement('option');
        o.value = it.id; o.textContent = it.nombre;
        $periodo.appendChild(o);
      }
      disable($periodo, false);

      enableBuscarIfReady();
    });

    // 3) al cambiar grado -> grupos
    $grado.addEventListener('change', async () => {
      disable($grupo); disable($area); disable($asignatura);
      $grupo.innerHTML = '<option value="">Seleccione el grupo</option>';
      $area.innerHTML = '<option value="">Seleccione el área</option>';
      $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

      if (!$sede.value || !$grado.value) { enableBuscarIfReady(); return; }

      const resp = await fetch("{% url 'api_grupos_por_sede_grado' %}?sede_id=" + $sede.value + "&grado_id=" + $grado.value).then(r=>r.json());
      for (const it of resp.grupos) {
        const o = document.createElement('option');
        o.value = it.id; o.textContent = it.nombre;
        $grupo.appendChild(o);
      }
      disable($grupo, false);
      enableBuscarIfReady();
    });

    // 4) al cambiar grupo -> áreas de ese grupo (derivadas de sus asignaturas)
    $grupo.addEventListener('change', async () => {
      disable($area); disable($asignatura);
      $area.innerHTML = '<option value="">Seleccione el área</option>';
      $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

      if (!$grupo.value) { enableBuscarIfReady(); return; }

      const resp = await fetch("{% url 'api_areas_por_grupo' %}?grupo_id=" + $grupo.value).then(r=>r.json());
      for (const it of resp.areas) {
        const o = document.createElement('option');
        o.value = it.id; o.textContent = it.nombre;
        $area.appendChild(o);
      }
      disable($area, false);
      enableBuscarIfReady();
    });

    // 5) al cambiar área -> asignaturas (de ese grupo en esa área)
    $area.addEventListener('change', async () => {
      disable($asignatura);
      $asignatura.innerHTML = '<option value="">Seleccione la asignatura</option>';

      if (!$area.value) { enableBuscarIfReady(); return; }

      const url = "{% url 'api_asignaturas_por_grupo_area' %}?grupo_id=" + $grupo.value + "&area_id=" + $area.value;
      const resp = await fetch(url).then(r=>r.json());
      for (const it of resp.asignaturas) {
        const o = document.createElement('option');
        o.value = it.id; o.textContent = it.nombre;
        $asignatura.appendChild(o);
      }
      disable($asignatura, false);
      enableBuscarIfReady();
    });

    // 6) habilitar buscar cuando falte algo
    $periodo.addEventListener('change', enableBuscarIfReady);
    [$sede,$grado,$grupo,$area,$asignatura].forEach(el => el.addEventListener('change', enableBuscarIfReady));

    // Buscar -> redirige a la tabla
    $buscar.addEventListener('click', () => {
      if ($buscar.classList.contains('disabled')) return;
      const params = new URLSearchParams(new FormData(document.getElementById('form-grupo')));
      window.location.href = "{% url 'rector_reporte_notas_tabla' %}?" + params.toString();
    });

    document.getElementById('btn-limpiar')?.addEventListener('click', () => {
      document.getElementById('form-grupo').reset();
      [$grado,$grupo,$area,$asignatura,$periodo].forEach(e=>{ e.innerHTML = e.querySelector('option').outerHTML; disable(e,true); });
      enableBuscarIfReady();
    });
  </script>
</body>
</html>