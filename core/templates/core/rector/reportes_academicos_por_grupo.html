{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Reportes académicos — Por grupo{% endblock %}

{% block extra_css %}
<style>
  /* ===== Barra roja ===== */
  .page-title{
    position:sticky; top:var(--navbar-height); z-index:40;
    background:var(--accent); color:#fff; font-weight:800; letter-spacing:.2px;
    text-align:center; padding:10px 12px; box-shadow:0 4px 12px rgba(0,0,0,.35);
  }

  /* ===== Panel glass ===== */
  .rg{ width:100%; max-width:1280px; margin:0 auto; padding-inline:clamp(12px,3vw,20px); }
  .rg-wrap{ position:relative; margin-top:14px; display:block; }
  .rg-wrap::before{
    content:""; position:absolute; inset:-18px -22px; border-radius:18px;
    background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(6px) saturate(115%);
    box-shadow:0 22px 44px rgba(0,0,0,.50);
    z-index:0; pointer-events:none;
  }
  .rg-inner{
    position:relative; z-index:1;
    padding:28px 24px max(96px, env(safe-area-inset-bottom, 24px));
  }

  /* ===== Badge ===== */
  .rg-badge{
    width:clamp(220px, 64vw, 340px);
    margin:-22px auto 0;
    background:#0c0c0c; border-radius:16px;
    box-shadow:0 16px 30px rgba(0,0,0,.55), inset 0 -8px 22px rgba(0,0,0,.22);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:18px 16px 12px; position:relative;
  }
  @media (min-width: 900px){
    .rg-badge{ left:auto; right:auto; transform:none; margin-left:auto !important; margin-right:auto !important; }
  }
  .rg-badge i{ font-size:82px; color:#fff; line-height:1; filter:drop-shadow(0 10px 30px rgba(0,0,0,.6)); }
  .rg-chip{
    margin-top:12px; background:var(--accent); color:#fff; padding:8px 18px;
    border-radius:999px; font-weight:800; letter-spacing:.2px; box-shadow:0 12px 24px rgba(0,0,0,.45);
  }

  /* ===== Grid ===== */
  .rg-grid{ margin-top:18px; display:grid; grid-template-columns:1fr 1fr; gap:14px 20px; align-items:center; }
  @media (max-width:1020px){ .rg-grid{ grid-template-columns:1fr; } }

  /* ===== Campos ===== */
  .rg-field{
    position: relative;
    display: flex; align-items: center;
    height: 48px;
    padding: 0;
    background:#fff; border-radius:14px; border:1px solid rgba(0,0,0,.06);
    box-shadow:0 10px 20px rgba(0,0,0,.22);
    width:100%;
    cursor: pointer;
  }
  .rg-field select{
    position: absolute; inset: 0; width: 100%; height: 100%;
    appearance: none; border: 0; outline: none; background: transparent;
    color:#111; font-weight:600; cursor: pointer;
    padding-left: 16px; padding-right: 36px;
  }
  .rg-ico{ display:none !important; }
  .rg-caret{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    color:#111; opacity:.85; pointer-events: none; z-index: 1;
  }

  /* ===== Acciones ===== */
  .rg-actions{
    position:sticky; bottom:calc(12px + env(safe-area-inset-bottom, 0px)); z-index:2;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.12) 45%, rgba(0,0,0,.22));
    padding-top:8px; display:grid; gap:12px; grid-template-columns:1fr;
  }
  @media (min-width:560px){ .rg-actions{ grid-template-columns:1fr auto 1fr; } }

  .rg-btn{
    height:48px; border-radius:12px; border:none; cursor:pointer; font-weight:800; color:#fff;
    background:var(--accent); box-shadow:0 12px 22px rgba(156,15,16,.38);
    transition:.12s transform ease,.12s box-shadow ease,.12s background ease;
  }
  .rg-btn:hover{ transform:translateY(-2px); box-shadow:0 18px 28px rgba(156,15,16,.48); }
  .rg-btn:active{ transform:translateY(0) scale(.985); }
  .rg-btn--ghost{ background:#b51415; }

  /* Selector de formato */
  #formato{
    height:48px; border-radius:12px; padding:0 12px;
    background:#1a1a1a; color:#fff; border:1px solid rgba(255,255,255,.15);
    box-shadow:0 8px 18px rgba(0,0,0,.35); outline:none;
  }

  .rg-note{font-size:.9rem;color:#dde7ef;text-align:center;margin-top:4px}
  @media (max-width:360px){
    .rg-badge i{ font-size:68px; }
    .rg-chip{ padding:6px 14px; }
  }
</style>
{% endblock %}

{% block page_banner %}
  <div class="page-title">Reportes académicos</div>
{% endblock %}

{% block content %}
<main class="main" role="main">
  <section class="rg" aria-label="Reportes por grupo">
    <div class="rg-wrap">
      <div class="rg-inner">
        <div class="rg-badge" aria-hidden="true">
          <i class="fa-solid fa-people-group"></i>
          <div class="rg-chip">POR GRUPO</div>
        </div>

        <form id="formReporte" class="rg-grid" method="get" action="{% url 'rector_reportes_academicos_tabla' %}">
          <!-- Sede -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-building-columns"></i></span>
            <select id="sede_id" name="sede_id" aria-label="Seleccione la sede">
              <option value="">Seleccione la sede</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Periodo -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-calendar-alt"></i></span>
            <select id="periodo_id" name="periodo_id" aria-label="Seleccione periodo" disabled>
              <option value="">Periodo</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Grado -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-sitemap"></i></span>
            <select id="grado_id" name="grado_id" aria-label="Seleccione el grado" disabled>
              <option value="">Grado</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Grupo -->
          <label class="rg-field">
            <span class="rg-ico"><i class="fa-solid fa-people-roof"></i></span>
            <select id="grupo_id" name="grupo_id" aria-label="Seleccione el grupo" disabled>
              <option value="">Grupo</option>
            </select>
            <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Acciones -->
          <div class="rg-actions" style="grid-column:1/-1;">
            <button type="button" class="rg-btn" id="btn-descargar" disabled>Descargar</button>
            <select id="formato">
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
            </select>
            <button type="reset" class="rg-btn rg-btn--ghost">Limpiar</button>
          </div>


          <!-- TEXTOS legibles para el chip en la tabla -->
          <input type="hidden" name="sede">
          <input type="hidden" name="grado">
          <input type="hidden" name="grupo">
          <input type="hidden" name="periodo">
        </form>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block extra_js %}
<!-- Form oculto para exportar en OTRA pestaña -->
<form id="exportForm" action="{% url 'rector_reportes_academicos_export' %}" method="GET" target="_blank" style="display:none">
  <input type="hidden" name="grupo_id">
  <input type="hidden" name="grado_id">
  <input type="hidden" name="sede_id">
  <input type="hidden" name="periodo_id" required>
  <input type="hidden" name="formato" value="pdf">
  <input type="hidden" name="bulk" value="1">
  <input type="hidden" name="scope" value="">
</form>

<script>
  const $ = s => document.querySelector(s);
  const setSelect = (el, items, placeholder="Seleccione") => {
    el.innerHTML = `<option value="">${placeholder}</option>`;
    (items || []).forEach(it => el.insertAdjacentHTML('beforeend', `<option value="${it.id}">${it.nombre}</option>`));
  };
  const enable = (el, on=true) => el.disabled = !on;

  const sedeSel    = $('#sede_id');
  const gradoSel   = $('#grado_id');
  const grupoSel   = $('#grupo_id');
  const periodoSel = $('#periodo_id');
  const btnBuscar  = $('#btnBuscar');   // por si no existe
  const btnDesc    = $('#btn-descargar');

  const hSede    = document.querySelector('input[name="sede"]');
  const hGrado   = document.querySelector('input[name="grado"]');
  const hGrupo   = document.querySelector('input[name="grupo"]');
  const hPeriodo = document.querySelector('input[name="periodo"]');

  const st = { sede_id:"", grado_id:"", grupo_id:"", periodo_id:"" };

  (async function init(){
    try{
      const sedes = await fetch("{% url 'api_sedes' %}").then(r=>r.json());
      setSelect(sedeSel, sedes.sedes, "Seleccione la sede"); enable(sedeSel, true);

      const pers = await fetch("{% url 'api_periodos_abiertos' %}").then(r=>r.json());
      setSelect(periodoSel, pers.periodos, "Periodo"); enable(periodoSel, true);
    }catch(e){ console.error(e); }
    validate();
  })();

  sedeSel.addEventListener('change', async e=>{
    st.sede_id = e.target.value || "";
    hSede.value = sedeSel.options[sedeSel.selectedIndex]?.text || "";
    setSelect(gradoSel, [], "Grado"); enable(gradoSel, false);
    setSelect(grupoSel, [], "Grupo"); enable(grupoSel, false);
    st.grado_id = st.grupo_id = "";
    if(!st.sede_id){ validate(); return; }
    try{
      const g = await fetch("{% url 'api_grados_por_sede' %}?sede_id="+st.sede_id).then(r=>r.json());
      setSelect(gradoSel, g.grados, "Grado"); enable(gradoSel, true);
    }catch(e){ console.error(e); }
    validate();
  });

  gradoSel.addEventListener('change', async e=>{
    st.grado_id = e.target.value || "";
    hGrado.value = gradoSel.options[gradoSel.selectedIndex]?.text || "";
    setSelect(grupoSel, [], "Grupo"); enable(grupoSel, false);
    st.grupo_id = "";
    if(!st.grado_id || !st.sede_id){ validate(); return; }
    try{
      const url = "{% url 'api_grupos_por_sede_grado' %}?sede_id="+st.sede_id+"&grado_id="+st.grado_id;
      const g = await fetch(url).then(r=>r.json());
      setSelect(grupoSel, g.grupos, "Grupo"); enable(grupoSel, true);
    }catch(e){ console.error(e); }
    validate();
  });

  grupoSel.addEventListener('change', e=>{
    st.grupo_id = e.target.value || "";
    hGrupo.value = grupoSel.options[grupoSel.selectedIndex]?.text || "";
    validate();
  });

  periodoSel.addEventListener('change', e=>{
    st.periodo_id = e.target.value || "";
    hPeriodo.value = periodoSel.options[periodoSel.selectedIndex]?.text || "";
    validate();
  });

  function validate(){
    const okBuscar = !!(st.sede_id && st.grado_id && st.grupo_id && st.periodo_id);
    if (btnBuscar) btnBuscar.disabled = !okBuscar;

    // Para descargar: requiere periodo y (grupo || (sede+grado))
    const okDesc = (!!st.periodo_id && ( !!st.grupo_id || (!!st.grado_id && !!st.sede_id) ));
    btnDesc.disabled = !okDesc;
  }

  // ⭐ Descargar en OTRA pestaña usando el form oculto
  document.getElementById('btn-descargar').addEventListener('click', ()=>{
    const grupo   = grupoSel.value;
    const grado   = gradoSel.value;
    const sede    = sedeSel.value;
    const periodo = periodoSel.value;
    const formato = (document.getElementById('formato').value || 'pdf').toLowerCase();

    if (!periodo) { alert('Seleccione periodo'); return; }
    if (!grupo && !(sede && grado)) { alert('Seleccione Grupo, o Sede + Grado.'); return; }

    const f = document.getElementById('exportForm');
    f.querySelector('input[name="formato"]').value   = formato;
    f.querySelector('input[name="periodo_id"]').value = periodo;

    if (grupo) {
      // Exportar un SOLO grupo (scope=grupo)
      f.querySelector('input[name="scope"]').value   = 'grupo';
      f.querySelector('input[name="grupo_id"]').value = grupo;
      f.querySelector('input[name="grado_id"]').value = '';
      f.querySelector('input[name="sede_id"]').value  = '';
    } else {
      // Exportar TODOS los grupos del grado (scope=grado)
      f.querySelector('input[name="scope"]').value   = 'grado';
      f.querySelector('input[name="grupo_id"]').value = '';
      f.querySelector('input[name="grado_id"]').value = grado;
      f.querySelector('input[name="sede_id"]').value  = sede;
    }

    // Abre en otra pestaña por target="_blank"
    f.submit();
  });

  // Reset
  document.getElementById('formReporte').addEventListener('reset', ()=>{
    setTimeout(()=>{
      hSede.value = hGrado.value = hGrupo.value = hPeriodo.value = "";
      st.sede_id = st.grado_id = st.grupo_id = st.periodo_id = "";
      setSelect(gradoSel, [], "Grado"); enable(gradoSel, false);
      setSelect(grupoSel, [], "Grupo"); enable(grupoSel, false);
      validate();
    },0);
  });
</script>
{% endblock %}

