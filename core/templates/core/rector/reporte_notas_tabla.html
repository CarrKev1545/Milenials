{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Registro de notas — Tabla</title>
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --panel-bg: rgba(10,10,12,.92);
    --panel-bd: rgba(255,255,255,.08);
    --panel-shadow: 0 20px 50px rgba(0,0,0,.55);
    --row-bg: #ffffff;
    --row-bd: #e8eef2;
    --header-bg: #0ea061;
    --header-fg: #ffffff;
    --text-main:#1b2730;
    --text-dim:#546e7a;
    --chip-bg:#203036;
    --chip-fg:#d5e7ef;
    --accent:#c62828;
    --accent-2:#b51415;
    --input-bd:#b0bec5;
    --input-focus:#0ea061;
  }

  .page-title{position:sticky;top:var(--navbar-height);z-index:40;background:var(--accent);color:#fff;font-weight:800;letter-spacing:.2px;text-align:center;padding:10px 12px;box-shadow:0 4px 12px rgba(0,0,0,.35)}

  .sheet{
    width:100%;max-width:1280px;margin:18px auto;padding:22px 22px 18px;
    background:var(--panel-bg); border:1px solid var(--panel-bd);
    border-radius:20px; box-shadow:var(--panel-shadow); backdrop-filter:saturate(115%) blur(4px);
  }

  .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  .tag{background:var(--chip-bg);color:var(--chip-fg);border:1px solid rgba(255,255,255,.06);
       border-radius:999px;padding:6px 12px;font-weight:700;font-size:.88rem}

  #docente{color:#e6f4ea;margin-bottom:10px;font-weight:700}

  .table-wrap{background:rgba(255,255,255,.06);border:1px solid var(--panel-bd);
              border-radius:14px;overflow:hidden}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  col.apellidos{width:36%}
  col.nombres{width:30%}
  col.nota{width:17%}
  col.fallas{width:17%}

  thead th{
    background:var(--header-bg);color:var(--header-fg);
    padding:14px 12px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;
    border-bottom:1px solid rgba(0,0,0,.15); text-align:left
  }
  thead th:nth-child(3), thead th:nth-child(4){ text-align:center }

  tbody tr{background:var(--row-bg)}
  tbody td{
    color:var(--text-main); font-weight:600; padding:12px 14px; border-bottom:1px solid var(--row-bd);
  }
  tbody tr:last-child td{ border-bottom:none }
  tbody td:first-child, tbody td:nth-child(2){ color:#0b1720 }
  tbody td:nth-child(3), tbody td:nth-child(4){ text-align:center }

  .nota, .fallas{
    width:110px; max-width:95%;
    text-align:center; font-weight:800; color:#102028;
    background:#fff; border:1px solid var(--input-bd); border-radius:10px; padding:8px 10px;
    transition:.15s border-color ease, .15s box-shadow ease;
    display:inline-block;
  }
  .nota:focus, .fallas:focus{
    outline:none; border-color:var(--input-focus); box-shadow:0 0 0 4px rgba(14,160,97,.18)
  }

  tbody tr:hover td{ background:#f7fbff }

  .actions{display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px}
  .btn{
    height:44px; border:none; border-radius:12px; padding:0 18px; color:#fff; font-weight:900; cursor:pointer;
    box-shadow:0 14px 28px rgba(0,0,0,.25); transition:.12s transform ease,.12s box-shadow ease,.12s background ease
  }
  .btn:hover{ transform:translateY(-2px) }
  .btn:active{ transform:translateY(0) scale(.985) }
  .btn-primary{ background:var(--accent) }
  .btn-primary:hover{ background:#a01f1f }
  .btn-ghost{ background:#38424a }
  .btn-ghost:hover{ background:#2b3339 }

  .small{font-size:.92rem;color:#e2edf4}
  ::selection { background:#ffcc80; color:#000 }
  ::-moz-selection { background:#ffcc80; color:#000 }
</style>

<!-- Bloque UX duro: validación + toast -->
<style>
  .cell-ok    input{ border-color:#059669 !important; box-shadow:0 0 0 3px rgba(5,150,105,.18) }
  .cell-bad   input{ border-color:#b91c1c !important; box-shadow:0 0 0 3px rgba(185,28,28,.18) }
  .cell-empty input{ border-color:#b0bec5 !important; box-shadow:none }
  .hint-bar{ margin-top:8px; font-size:.92rem; color:#e2edf4 }
  .hint-bar .bad{ color:#fecaca; font-weight:700 }
  #toast{
    position:fixed; right:16px; bottom:16px; z-index:2000;
    background:#111827; color:#fff; padding:10px 12px; border-radius:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.25); max-width:60ch; opacity:0; pointer-events:none;
    transition:opacity .18s ease, transform .18s ease; transform:translateY(6px);
  }
  #toast.show{ opacity:1; transform:translateY(0) }
</style>
</head>

<body>
<header class="navbar">
  <div class="nav-left">
    <img src="{% static 'img/logo2.jpeg' %}" class="logo" alt="logo">
    <div class="nav-title"><h3>RECTOR / COORDINADOR</h3></div>
  </div>
  <nav class="nav-menu">
    <a href="{% url 'dashboard_rector' %}">Inicio</a>
    <a href="{% url 'rector_estudiantes_a_grupos' %}">Estudiante a grupos</a>
    <a href="{% url 'rector_asignacion_docentes_grupos' %}">Asignación de Docentes a grupos</a>
  </nav>
  <div class="nav-right"><a href="{% url 'logout' %}" class="btn-logout">Cerrar Sesión</a></div>
</header>

<div class="page-title">Registro de notas</div>

<main class="main">
  <section class="sheet">
    <!-- CSRF oculto (lo usa el helper JS) -->
    <form id="csrf-holder" style="display:none">{% csrf_token %}</form>

    <div id="meta" class="meta"></div>
    <div class="small" id="docente"></div>

    <div class="table-wrap">
      <table id="tabla">
        <colgroup>
          <col class="apellidos"><col class="nombres"><col class="nota"><col class="fallas">
        </colgroup>
        <thead>
          <tr>
            <th>Apellidos</th>
            <th>Nombres</th>
            <th>Nota (1.0–5.0)</th>
            <th>Fallas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="actions">
      <button class="btn btn-ghost" id="btn-limpiar-celdas" type="button">
        <i class="fa-solid fa-eraser"></i> Limpiar celdas
      </button>
      <button class="btn btn-primary" id="btn-guardar" type="button">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>
    </div>

    <div class="hint-bar" id="hint-bar"></div>
    <div id="toast" role="status" aria-live="polite"></div>
  </section>
</main>

<!-- helper para registrar/actualizar una nota -->
<script src="{% static 'core/js/registro_notas_api.js' %}"></script>

<script>
  // === Parámetros ===
  const params = new URLSearchParams(location.search);
  const grupo_id      = params.get('grupo_id');
  const asignatura_id = params.get('asignatura_id');
  const periodo_id    = params.get('periodo_id');
  const sede_id       = params.get('sede_id');
  const grado_id      = params.get('grado_id');
  const area_id       = params.get('area_id');
  const estFiltro     = params.get('estudiante_id'); // si vienes "por estudiante"

  // === Encabezado (chips) ===
  async function fillMeta() {
    const meta = document.getElementById('meta');
    const pieces = [];

    try{
      const sede = await fetch("{% url 'api_sedes' %}").then(r=>r.json());
      const sed = sede.sedes.find(s=> String(s.id) === String(sede_id));
      if (sed) pieces.push(['Sede', sed.nombre]);

      const gds = await fetch("{% url 'api_grados_por_sede' %}?sede_id=" + sede_id).then(r=>r.json());
      const grd = gds.grados.find(g=> String(g.id) === String(grado_id));
      if (grd) pieces.push(['Grado', grd.nombre]);

      const grs = await fetch("{% url 'api_grupos_por_sede_grado' %}?sede_id=" + sede_id + "&grado_id=" + grado_id).then(r=>r.json());
      const grp = grs.grupos.find(g=> String(g.id) === String(grupo_id));
      if (grp) pieces.push(['Grupo', grp.nombre]);

      if (area_id){
        const ars = await fetch("{% url 'api_areas_por_grupo' %}?grupo_id=" + grupo_id).then(r=>r.json());
        const ar = ars.areas.find(a=> String(a.id) === String(area_id));
        if (ar) pieces.push(['Área', ar.nombre]);

        const asjs = await fetch("{% url 'api_asignaturas_por_grupo_area' %}?grupo_id=" + grupo_id + "&area_id=" + area_id).then(r=>r.json());
        const asig = asjs.asignaturas.find(a=> String(a.id) === String(asignatura_id));
        if (asig) pieces.push(['Asignatura', asig.nombre]);
      }else{
        pieces.push(['Asignatura', '—']);
      }

      const pers = await fetch("{% url 'api_periodos_abiertos' %}").then(r=>r.json());
      const per = pers.periodos.find(p=> String(p.id) === String(periodo_id));
      if (per) pieces.push(['Periodo', per.nombre]);
    }catch(_){}

    meta.innerHTML = pieces.map(([k,v]) => `<div class="tag"><b>${k}:</b> ${v}</div>`).join('');

    try{
      const d = await fetch("{% url 'api_docente_de_grupo_asignatura' %}?grupo_id=" + grupo_id + "&asignatura_id=" + asignatura_id).then(r=>r.json());
      document.getElementById('docente').textContent =
        d.docente ? ("Docente: " + d.docente.nombre + " " + d.docente.apellidos) : "Docente: N/A";
    }catch(_){}
  }

  // === Tabla (con precarga de NOTAS/FALLAS desde BD) ===
  async function loadTabla() {
    const tbody = document.querySelector('#tabla tbody');
    tbody.innerHTML = '';

    // 1) lista de estudiantes (opcionalmente filtrada a 1)
    const resp = await fetch("{% url 'api_estudiantes_por_grupo' %}?grupo_id=" + grupo_id).then(r=>r.json());
    let lista = resp.estudiantes || [];
    if (estFiltro) lista = lista.filter(e => String(e.id) === String(estFiltro));

    // 2) pintar filas
    for (const e of lista) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <input class="nota"   type="number" step="0.1" min="1.0" max="5.0" value=""
       data-est="${e.id}" inputmode="decimal" lang="es">
        <input class="fallas" type="number" step="1"   min="0"   value=""
       data-est="${e.id}" inputmode="numeric">
      `;
      tbody.appendChild(tr);
    }

    // 3) traer notas de BD y precargar
    try{
      const rNotas = await fetch(
        "{% url 'api_notas_por_grupo_asignatura_periodo' %}?grupo_id=" + grupo_id +
        "&asignatura_id=" + asignatura_id + "&periodo_id=" + periodo_id
      ).then(r=>r.json());

      const map = Object.create(null);
      (rNotas.notas || []).forEach(n => { map[String(n.estudiante_id)] = n; });

      document.querySelectorAll('input.nota').forEach(inp => {
        const n = map[inp.dataset.est];
        if (n && typeof n.nota !== 'undefined' && n.nota !== null) {
          const val = Number(n.nota);
          inp.value = isFinite(val) ? val.toFixed(1) : '';
        }
      });
      document.querySelectorAll('input.fallas').forEach(inp => {
        const n = map[inp.dataset.est];
        if (n && typeof n.fallas !== 'undefined' && n.fallas !== null) {
          inp.value = String(n.fallas);
        }
      });
    }catch(_){
      /* si falla, quedan vacías como antes */
    }
  }

  /* ================= UX DURA: validaciones, estados y toast ================= */

  function showToast(msg, ok=true){
    const el=document.getElementById('toast'); if(!el) return;
    el.textContent = msg || '';
    el.style.background = ok ? '#065f46' : '#7f1d1d';
    el.classList.add('show');
    setTimeout(()=> el.classList.remove('show'), 2400);
  }

  const $tbody   = document.querySelector('#tabla tbody');
  const $guardar = document.getElementById('btn-guardar');
  const $hintBar = document.getElementById('hint-bar');

  function normDecimal(str){
    if (str == null) return '';
    str = String(str).trim().replace(/,/g, '.');     // ← todas las comas
    str = str.replace(/[^\d.]/g, '');                // solo dígitos y punto
    const i = str.indexOf('.');
    if (i !== -1) {
      const head = str.slice(0, i + 1);
      const tail = str.slice(i + 1).replace(/\./g, '');
      str = head + tail; ;
    }
    return str;
  }

 function validateNota(input, mutate = false){
  const td  = input.closest('td');
  const raw = String(input.value ?? '');
  const v   = normDecimal(raw);

  if (mutate && v !== raw){
    const pos = input.selectionStart || raw.length;
    input.value = v;                               // solo en blur
    // intenta conservar el cursor en posición natural
    const newPos = Math.min(v.length, pos + (v.length - raw.length));
    try { input.setSelectionRange(newPos, newPos); } catch(_) {}
  }

  if (v === ''){
    td.classList.remove('cell-ok','cell-bad'); td.classList.add('cell-empty');
    return {ok:true, empty:true};
  }
  const num = Number(v);
  const ok  = Number.isFinite(num) && num >= 1.0 && num <= 5.0;
  if (!ok){
    td.classList.remove('cell-ok','cell-empty'); td.classList.add('cell-bad');
    return {ok:false, empty:false};
  }
  td.classList.remove('cell-bad','cell-empty'); td.classList.add('cell-ok');
  return {ok:true, empty:false, value:num};
}


  function validateFallas(input){
    const td = input.closest('td');
    let vv = (input.value || '').trim();
    vv = vv.replace(/[^\d-]/g,'');
    input.value = vv;

    if (vv === ''){
      td.classList.remove('cell-ok','cell-bad'); td.classList.add('cell-empty');
      return {ok:true, empty:true};
    }
    if (!/^-?\d+$/.test(vv)){
      td.classList.remove('cell-ok','cell-empty'); td.classList.add('cell-bad');
      return {ok:false, empty:false};
    }
    const n = parseInt(vv,10);
    if (n < 0){
      td.classList.remove('cell-ok','cell-empty'); td.classList.add('cell-bad');
      return {ok:false, empty:false};
    }
    td.classList.remove('cell-bad','cell-empty'); td.classList.add('cell-ok');
    return {ok:true, empty:false, value:n};
  }

  function validateAll(){
    let errors = 0;
    document.querySelectorAll('input.nota').forEach(inp => { if (!validateNota(inp, false).ok) errors++; });
    document.querySelectorAll('input.fallas').forEach(inp => { if (!validateFallas(inp).ok) errors++; });

    const disabled = errors > 0;
    $guardar.disabled = disabled;
    $guardar.classList.toggle('disabled', disabled);
    if ($hintBar){
      $hintBar.innerHTML = disabled
        ? `Hay <span class="bad">${errors}</span> campo(s) con error. Corrígelos para poder guardar.`
        : `Todo listo. Puedes guardar.`;
    }
    return errors;
  }

  function attachFieldHandlers(){
    document.querySelectorAll('input.nota').forEach(inp=>{
      inp.addEventListener('input', ()=> { validateNota(inp, false); validateAll(); });
      inp.addEventListener('blur',  ()=>{
        const r = validateNota(inp, true); // normaliza coma→punto aquí
        if (r.ok && !r.empty){
          const n = Number(normDecimal(inp.value));
          const clamped = Math.min(5, Math.max(1, n));
          const rounded = Math.round(clamped * 10) / 10; // redondeo a décimas
          inp.value = rounded.toFixed(1);                 // 2 decimales
        }
        validateAll();
      });
      inp.closest('td').classList.add('cell-empty');
    });

    document.querySelectorAll('input.fallas').forEach(inp=>{
      inp.addEventListener('input', ()=> validateAll());
      inp.addEventListener('blur',  ()=> validateAll());
      inp.closest('td').classList.add('cell-empty');
    });

    validateAll();
  }

  function preventWheelOnNumberInputs(){
    document.querySelectorAll('input[type="number"]').forEach(inp=>{
      inp.addEventListener('wheel', e=>{
        if (document.activeElement === inp) e.preventDefault();
      }, {passive:false});
    });
  }
  (function patchAfterLoad(){
    const orig = window.loadTabla;
    if (typeof orig === 'function'){
      window.loadTabla = async function(){
        await orig();
        attachFieldHandlers();
        preventWheelOnNumberInputs();
      }
    }
  })();

  // Parche: engancha handlers justo después de tu loadTabla()
  (function interceptAfterLoad(){
    const originalLoadTabla = window.loadTabla;
    if (typeof originalLoadTabla === 'function'){
      window.loadTabla = async function(){
        await originalLoadTabla();
        attachFieldHandlers();
      }
    } else {
      const obs = new MutationObserver(()=>{ attachFieldHandlers(); obs.disconnect(); validateAll(); });
      obs.observe($tbody, {childList:true});
    }
  })();

  // === Guardar usando la API fila-a-fila (rector_registrar_nota) ===
  document.getElementById('btn-guardar').addEventListener('click', async (ev) => {
    // Bloqueo si hay errores visibles
    if (validateAll() > 0){
      ev.preventDefault();
      showToast('Corrige los campos marcados antes de guardar.', false);
      return;
    }

    const filas = [];
    document.querySelectorAll('input.nota').forEach(inp => {
      const id = inp.dataset.est;
      const nota = inp.value;
      const fallas = document.querySelector(`input.fallas[data-est="${id}"]`).value;
      filas.push({estudiante_id: id, nota, fallas});
    });

    let ok = 0, fail = 0, inserts = 0, updates = 0;
    $guardar.disabled = true;

    try{
      for (const f of filas) {
        // Nota vacía = no enviamos (omite filas totalmente vacías)
        const hasNota   = String(f.nota   || '').trim().length > 0;
        const hasFallas = String(f.fallas || '').trim().length > 0;
        if (!hasNota && !hasFallas) continue;

        const res = await guardarNota(
          f.estudiante_id,
          asignatura_id,
          periodo_id,
          hasNota ? f.nota : '',           // servidor entiende vacío
          hasFallas ? f.fallas : '0'
        );

        if (res && res.ok) {
          ok++;
          if (res.accion === 'INSERT') inserts++;
          if (res.accion === 'UPDATE') updates++;
        } else {
          fail++;
        }
      }

      showToast(`Guardado: ${ok} OK (ins: ${inserts}, upd: ${updates}) · ${fail} fallos`, fail===0);
      // refrescar (vuelve a pintar y reengancha validadores)
      await loadTabla();
      attachFieldHandlers();
    } catch(e){
      showToast('Error de red guardando notas.', false);
    } finally{
      $guardar.disabled = false;
    }
  });

  // Limpiar celdas (UI)
  document.getElementById('btn-limpiar-celdas').addEventListener('click', () => {
    document.querySelectorAll('input.nota, input.fallas').forEach(i => i.value = '');
    attachFieldHandlers(); // re-colorea como vacías
  });

  fillMeta().then(loadTabla);
</script>

<footer class="site-footer" role="contentinfo" aria-label="Pie de página del sitio">
  <div class="footer-inner">
    <div class="footer-left">
      <img src="{% static 'img/logo2.jpeg' %}" alt="Logo colegio" class="footer-logo">
      <div class="footer-school">
        <div class="school-name">Nombre del Colegio</div>
        <div class="school-sub">Sede / Ciudad</div>
      </div>
    </div>
    <div class="footer-center">
      Dirección: Calle Falsa 123<br>
      Tel: (+57) 300 000 0000 · Email: info@colegio.edu.co
    </div>
    <div class="footer-right">
      <nav class="footer-links">
        <a href="#">Privacidad</a>
        <a href="#">Términos</a>
        <a href="#">Contacto</a>
      </nav>
      <div class="copyright">© {% now "Y" %} Nombre del Colegio</div>
    </div>
  </div>
</footer>
</body>
</html>
