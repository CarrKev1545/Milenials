{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Estudiante a grupos{% endblock %}

{% block extra_css %}
<style>
  /* Solo ajustes puntuales para esta página (todo lo demás lo da dashboard.patch.css) */

  /* Nombre autocompletado: pista visual */
  #eg-nombre[readonly]{ font-style: italic; opacity:.95; }

  /* Inputs dentro de .re-field (ya tenemos los selects en el patch) */
  .re-field input{
    flex: 1 1 auto; min-width:0;
    height: 64px;
    font-size: clamp(1rem,.95rem + .2vw,1.08rem);
    color:#f6f6fa;
    background: transparent;
    border:none; outline:none;
  }
  .re-field input::placeholder{ color:#c8c8cf; opacity:.9; }

  /* Estado deshabilitado para selects dependientes */
  .is-disabled{ opacity:.6; cursor:not-allowed; }
</style>
{% endblock %}

{% block content %}
<section class="re" aria-labelledby="titulo-eg">
  <h1 id="titulo-eg" class="re-title">Estudiante a grupos</h1>

  <div class="re-wrap">
    <!-- Columna izquierda: avatar -->
    <aside class="re-left" aria-label="Ilustración estudiantes">
      <div class="re-avatar" aria-hidden="true">
        <i class="fa-solid fa-people-group"></i>
      </div>
    </aside>

    <!-- Columna derecha: formulario -->
    <div class="re-right">

      {% if messages %}
        {% for m in messages %}
          <div class="re-msg {% if m.tags == 'success' %}re-msg--ok{% else %}re-msg--err{% endif %}">
            {{ m }}
          </div>
        {% endfor %}
      {% endif %}

      <div class="re-card">
        <form class="re-form" id="eg-form" method="post" autocomplete="off" novalidate>
          {% csrf_token %}

          <!-- Documento -->
          <label class="re-field" for="eg-doc">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-id-card"></i></span>
            <input id="eg-doc" name="documento" type="text" inputmode="numeric" pattern="[0-9]{4,30}"
                   placeholder="Cédula de ciudadanía / Tarjeta de identidad"
                   aria-label="Documento del estudiante" required>
          </label>

          <!-- Nombre (solo lectura) -->
          <label class="re-field" for="eg-nombre">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-user"></i></span>
            <input id="eg-nombre" name="nombre_estudiante" type="text"
                   placeholder="Nombre del estudiante" aria-label="Nombre del estudiante"
                   readonly>
          </label>

          <!-- Sede -->
          <label class="re-field" for="eg-sede">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-building"></i></span>
            <select id="eg-sede" name="sede_id" required aria-label="Seleccione la sede">
              <option value="">Seleccione la sede</option>
              {% for s in sedes %}
                <option value="{{ s.id }}">{{ s.nombre }}</option>
              {% endfor %}
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Grado (se activa al elegir sede) -->
          <label class="re-field" for="eg-grado">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-graduation-cap"></i></span>
            <select id="eg-grado" name="grado_id" required aria-label="Seleccione el grado" disabled>
              <option value="">Seleccione el grado</option>
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>

          <!-- Grupo (se activa al elegir grado) -->
          <label class="re-field" for="eg-grupo">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-users-rectangle"></i></span>
            <select id="eg-grupo" name="grupo_id" required aria-label="Seleccione el grupo" disabled>
              <option value="">Seleccione el grupo</option>
            </select>
            <span class="re-caret" aria-hidden="true"><i class="fa-solid fa-chevron-down"></i></span>
          </label>
        </form>

        <!-- Acciones -->
        <div class="re-actions">
          <button type="submit" form="eg-form" class="btn btn--danger">Asignar</button>
          <button type="reset"  form="eg-form" class="btn btn--danger">Limpiar</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Toast (reutiliza estilos del patch) -->
<div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const $ = (s) => document.querySelector(s);

  const form     = $('#eg-form');
  const csrfInp  = form.querySelector('input[name=csrfmiddlewaretoken]');
  const docInp   = $('#eg-doc');
  const nameInp  = $('#eg-nombre');
  const sedeSel  = $('#eg-sede');
  const gradoSel = $('#eg-grado');
  const grupoSel = $('#eg-grupo');

  /* ---------- helpers ---------- */
  function showToast(msg, ok=true){
    const el = $('#toast');
    el.textContent = msg;
    el.style.background = ok ? '#065f46' : '#7f1d1d';
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2600);
  }
  function clearSelect(sel, ph){
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = ph;
    sel.appendChild(opt);
  }
  function setDisabled(sel, on){
    sel.disabled = !!on;
    sel.classList.toggle('is-disabled', !!on);
  }
  async function fetchJSON(url){
    const r = await fetch(url, {headers: {'X-Requested-With':'fetch'}});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  /* ---------- Documento → nombre (debounce + blur) ---------- */
  let timer = null;
  function sanitizeDoc(){
    docInp.value = docInp.value.replace(/\D+/g, '').slice(0, 30);
    if(!docInp.value) nameInp.value = '';
  }
  async function lookupByDoc(){
    const doc = docInp.value.trim();
    if(!doc){ nameInp.value=''; return; }
    try{
      const data = await fetchJSON("{% url 'api_estudiante_por_documento' %}?doc="+encodeURIComponent(doc));
      nameInp.value = data.nombre_completo || `${data.nombre||''} ${data.apellidos||''}`.trim();
    }catch{ nameInp.value=''; }
  }
  docInp.addEventListener('input', () => {
    sanitizeDoc();
    clearTimeout(timer);
    if(docInp.value.length >= 5){ timer = setTimeout(lookupByDoc, 350); }
    else{ nameInp.value=''; }
  });
  docInp.addEventListener('blur', lookupByDoc);

  /* ---------- Cascada Sede → Grado → Grupo ---------- */
  // Estado inicial
  setDisabled(gradoSel, true);
  setDisabled(grupoSel, true);

  sedeSel.addEventListener('change', async () => {
    clearSelect(gradoSel, 'Seleccione el grado');
    clearSelect(grupoSel, 'Seleccione el grupo');
    setDisabled(grupoSel, true);

    const sede_id = sedeSel.value;
    setDisabled(gradoSel, !sede_id);
    if(!sede_id) return;

    try{
      const data = await fetchJSON("{% url 'api_grados_por_sede' %}?sede_id="+encodeURIComponent(sede_id));
      const grados = Array.isArray(data) ? data : (data.grados || []);
      grados.forEach(g=>{
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.nombre;
        gradoSel.appendChild(opt);
      });
    }catch(e){ console.warn('Error cargando grados:', e); }
  });

  gradoSel.addEventListener('change', async () => {
    clearSelect(grupoSel, 'Seleccione el grupo');
    setDisabled(grupoSel, true);

    const sede_id  = sedeSel.value;
    const grado_id = gradoSel.value;
    if(!sede_id || !grado_id) return;

    try{
      const data = await fetchJSON("{% url 'api_grupos_por_sede_grado' %}?sede_id="+encodeURIComponent(sede_id)+"&grado_id="+encodeURIComponent(grado_id));
      const grupos = Array.isArray(data) ? data : (data.grupos || []);
      grupos.forEach(g=>{
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.nombre;
        grupoSel.appendChild(opt);
      });
      setDisabled(grupoSel, grupos.length === 0);
    }catch(e){ console.warn('Error cargando grupos:', e); }
  });

  /* ---------- Envío ---------- */
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      documento: docInp.value.trim(),
      sede_id:   sedeSel.value,
      grado_id:  gradoSel.value,
      grupo_id:  grupoSel.value,
    };
    if(!payload.documento || !payload.sede_id || !payload.grado_id || !payload.grupo_id){
      showToast('Completa documento, sede, grado y grupo.', false); return;
    }
    try{
      const r = await fetch("{% url 'rector_estudiantes_a_grupos_asignar' %}", {
        method:'POST',
        headers:{
          'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8',
          'X-CSRFToken': csrfInp ? csrfInp.value : '',
        },
        body: new URLSearchParams(payload),
      });
      const data = await r.json();
      if(data.ok){ showToast(data.msg || 'Estudiante asignado con éxito.'); }
      else{ showToast(data.msg || 'No se pudo asignar.', false); }
    }catch{ showToast('Error de red al asignar.', false); }
  });

  /* ---------- Reset ---------- */
  form.addEventListener('reset', ()=>{
    setTimeout(()=>{
      clearSelect(gradoSel, 'Seleccione el grado');
      clearSelect(grupoSel, 'Seleccione el grupo');
      setDisabled(gradoSel, true);
      setDisabled(grupoSel, true);
      nameInp.value = '';
    },0);
  });

  /* ---------- UX extra: que toda la franja enfoque el control ---------- */
  document.querySelectorAll('.re-field').forEach(label=>{
    if(!label.hasAttribute('tabindex')) label.tabIndex = 0;
    const ctl = label.querySelector('select, input');
    if(!ctl) return;

    label.addEventListener('click',(ev)=>{
      if(ev.target === ctl) return;
      if(ctl.disabled) return;
      ev.preventDefault();
      ctl.focus();
      if(ctl.tagName === 'SELECT' && typeof ctl.showPicker === 'function'){ try{ ctl.showPicker(); }catch{} }
    });
    label.addEventListener('keydown',(ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){
        ev.preventDefault();
        if(ctl.disabled) return;
        ctl.focus();
        if(ctl.tagName === 'SELECT' && typeof ctl.showPicker === 'function'){ try{ ctl.showPicker(); }catch{} }
      }
    });
  });
})();
</script>
{% endblock %}
