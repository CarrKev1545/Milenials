{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Registro Estudiantes{% endblock %}

{% block extra_css %}
<style>
  /* Solo esta página (se apoya en dashboard.patch.css) */

  /* Grid del formulario: 1 col en móvil, 2 en desktop */
  .re-form{
    display:grid; gap: var(--s-4);
    grid-template-columns: 1fr;
  }
  @media (min-width: 900px){
    .re-form{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .re-field--span-2{ grid-column: 1 / -1; }
  }

  /* Inputs dentro de la franja (misma altura que selects) */
  .re-field input{
    flex: 1 1 auto; min-width: 0;
    height: 64px;
    font-size: clamp(1rem, .95rem + .2vw, 1.08rem);
    color: #f6f6fa;
    background: transparent;
    border: none; outline: none;
  }

  /* Botones rojos consistentes, responsivos */
  .re-actions{
    display:grid; gap:12px;
    grid-template-columns: 1fr;
    margin-top: 12px;
  }
  @media (min-width: 540px){
    .re-actions{ grid-template-columns: repeat(2,1fr); }
  }
  .re-actions .btn{
    width:100%; min-width:0; height:48px; border-radius:999px;
    background: var(--brand); color:#fff; border-color:transparent;
    box-shadow: 0 4px 14px rgba(156,15,16,.35);
  }
  .re-actions .btn:hover{ transform: translateY(-1px); }

  /* Mensajes */
  #re-msg{ margin-top: 10px; }
  .re-msg{margin:.5rem 0; padding:.6rem .9rem; border-radius:.8rem; font-weight:600;}
  .re-msg--ok{background:#065f46; color:#d1fae5;}
  .re-msg--err{background:#7f1d1d; color:#fee2e2;}
</style>
{% endblock %}

{% block content %}
<section class="re" aria-labelledby="titulo-re">
  <h1 id="titulo-re" class="re-title">Registro Estudiantes</h1>

  <div class="re-wrap">
    <!-- Columna izquierda: avatar -->
    <aside class="re-left" aria-label="Avatar estudiante">
      <div class="re-avatar" aria-hidden="true">
        <i class="fa-solid fa-user-graduate" aria-hidden="true"></i>
      </div>
    </aside>

    <!-- Columna derecha: tarjeta + formulario + acciones -->
    <div class="re-right">
      <div class="re-card">
        <form id="re-form" class="re-form" autocomplete="off" novalidate>
          {% csrf_token %}

          <!-- Nombre -->
          <label class="re-field" for="re-nombre">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-user"></i></span>
            <input id="re-nombre" name="nombre" type="text"
                   placeholder="Nombre" aria-label="Nombre"
                   pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"
                   title="El nombre solo puede contener letras y espacios"
                   autocomplete="given-name" required />
          </label>

          <!-- Apellidos -->
          <label class="re-field" for="re-apellido">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-user-pen"></i></span>
            <input id="re-apellido" name="apellidos" type="text"
                   placeholder="Apellidos" aria-label="Apellidos"
                   pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"
                   title="Los apellidos solo pueden contener letras y espacios"
                   autocomplete="family-name" required />
          </label>

          <!-- Número de documento (ocupa las 2 columnas en desktop) -->
          <label class="re-field re-field--span-2" for="re-documento">
            <span class="re-ico" aria-hidden="true"><i class="fa-solid fa-id-card"></i></span>
            <input id="re-documento" name="documento" type="text" inputmode="numeric"
                   placeholder="Número de documento" aria-label="Número de documento"
                   autocomplete="off" required />
          </label>
        </form>

        <!-- Acciones -->
        <div class="re-actions">
          <button id="btn-crear" type="submit" form="re-form" class="btn">Crear</button>
          <button type="reset" form="re-form" class="btn">Limpiar</button>
        </div>

        <!-- Mensaje dinámico -->
        <div id="re-msg" class="re-msg" role="status" aria-live="polite"></div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form   = document.getElementById('re-form');
  const nombre = document.getElementById('re-nombre');
  const ape    = document.getElementById('re-apellido');
  const doc    = document.getElementById('re-documento');
  const msg    = document.getElementById('re-msg');

  const NAME_RX = /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/;

  // Helpers
  const showMsg = (ok, text) => {
    msg.className = 're-msg ' + (ok ? 're-msg--ok' : 're-msg--err');
    msg.textContent = text;
    msg.scrollIntoView({block:'nearest', behavior:'smooth'});
  };
  const getCSRFT = () =>
    document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

  // Sanitizar documento: solo dígitos máx 20
  doc?.addEventListener('input', () => {
    doc.value = doc.value.replace(/\D+/g, '').slice(0, 20);
  });

  // Normalizar espacios en nombres
  function normSpaces(v){ return v.replace(/\s+/g,' ').trim(); }

  // Submit AJAX
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const vNombre = normSpaces(nombre.value);
    const vApe    = normSpaces(ape.value);
    const vDoc    = (doc.value || '').trim();

    if (!vNombre || !vApe || !vDoc){
      showMsg(false, 'Completa Nombre, Apellidos y Documento.');
      return;
    }
    if (!NAME_RX.test(vNombre)){
      showMsg(false, 'El nombre solo puede contener letras y espacios.');
      return;
    }
    if (!NAME_RX.test(vApe)){
      showMsg(false, 'Los apellidos solo pueden contener letras y espacios.');
      return;
    }

    // Deshabilita mientras envía
    const btn = document.getElementById('btn-crear');
    btn && (btn.disabled = true);

    try {
      const resp = await fetch("{% url 'rector_registro_estudiantes_crear' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFT(),
        },
        body: JSON.stringify({
          nombre: vNombre,
          apellidos: vApe,
          documento: vDoc,
        }),
      });

      const data = await resp.json().catch(() => ({}));

      if (resp.ok && data.ok){
        showMsg(true, data.msg || 'Estudiante registrado con éxito.');
        form.reset();
        nombre.focus();
      } else {
        showMsg(false, data.msg || 'No se pudo registrar el estudiante.');
      }
    } catch (err) {
      showMsg(false, 'Error de conexión con el servidor.');
    } finally {
      btn && (btn.disabled = false);
    }
  });

  // Reset: limpia mensaje
  form?.addEventListener('reset', () => {
    setTimeout(() => { msg.textContent = ''; msg.className = 're-msg'; }, 0);
  });
})();
</script>
{% endblock %}
