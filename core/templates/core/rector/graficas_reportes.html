{% extends "core/base_dashboard.html" %}
{% load static %}

{% block title %}Gráficas y Reportes{% endblock %}

{% block extra_css %}
<style>
  /* ===== Paleta y escala base ===== */
  :root{
    font-size:16px;
    --bg-dark:#0b1220;
    --bg-card:#151826;                 /* carta interna */
    --plate-grad-from:#0c0c0c;
    --plate-grad-to:#111318;
    --border-light:rgba(255,255,255,.08);
    --text-light:#e5ecf6;
    --ink:#0f172a;
    --accent:#c62828;                  /* rojo proyecto */
    --accent-2:#136f36;                /* verde auxiliar */
    --accent-shadow:rgba(156,15,16,.35);
    --shadow-deep:rgba(0,0,0,.38);
    --shadow-deeper:rgba(0,0,0,.45);
  }
  @media (max-width:75em){ :root{ font-size:15px } }
  @media (max-width:62em){ :root{ font-size:14.5px } }
  @media (max-width:48em){ :root{ font-size:14px } }

  /* ===== Wrapper con “backplate” amplio (como en otras vistas) ===== */
  .gr-wrap{
    max-width:70rem;
    margin:0 auto;
    padding:1.25rem;
    position:relative;
  }
  .gr-wrap::before{
    content:"";
    position:absolute;
    top:-2rem; right:-1.25rem; bottom:-1.25rem; left:-1.25rem;
    border-radius:1.35rem;
    background:linear-gradient(180deg, var(--plate-grad-from,.72), var(--plate-grad-to,.84));
    background:linear-gradient(180deg, rgba(12,12,12,.70), rgba(12,12,12,.84));
    border:1px solid var(--border-light);
    box-shadow:0 1.1rem 2.2rem var(--shadow-deeper), inset 0 .05rem .5rem rgba(255,255,255,.035);
    z-index:0; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
  }

  /* ===== Filtros / Selects ===== */
  .gr-filtros{
    position:relative; z-index:1;
    display:grid; gap:1rem;
    grid-template-columns:repeat(3, 1fr);
    margin-bottom:1.1rem;
  }
  @media (max-width:56.25em){ .gr-filtros{ grid-template-columns:1fr; } }

  .gr-field{
    position:relative;
    display:flex; align-items:center;
    height:3.25rem; padding:0 1rem 0 3rem;
    border-radius:.95rem;
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    box-shadow:0 .65rem 1.3rem rgba(0,0,0,.22), inset 0 .06rem .22rem rgba(0,0,0,.06);
    transition: box-shadow .15s ease, border-color .15s ease, transform .08s ease;
  }
  /* Icono a la izquierda para consistencia visual (usa tu HTML si ya tienes <i>) */
  .gr-field::before{
    content:"\f0ce"; /* fa-table as fallback */
    font: normal 900 1.05rem/1 "Font Awesome 6 Free";
    position:absolute; left:.95rem; top:50%; transform:translateY(-50%);
    color:var(--ink); opacity:.9;
  }
  .gr-field:focus-within{
    box-shadow:0 0 0 .22rem rgba(198,40,40,.16), 0 .65rem 1.3rem rgba(0,0,0,.22);
    border-color:rgba(198,40,40,.32);
    transform:translateY(-1px);
  }
  .gr-field select{
    appearance:none; width:100%;
    border:0; outline:0; background:transparent;
    color:var(--ink); font-weight:700; font-size:1.02rem; cursor:pointer;
  }
  .gr-field select:disabled{ opacity:.6; cursor:not-allowed; }
  .gr-field::after{
    content:"▾"; position:absolute; right:.9rem; top:50%; transform:translateY(-50%);
    color:var(--ink); opacity:.55; font-weight:700; pointer-events:none;
  }

  /* Menú del select */
  select option{
    background:var(--bg-card); color:var(--text-light);
  }
  select option:checked, select option:hover{
    background:var(--accent); color:#fff;
  }

  /* ===== Tarjetas/gráficas ===== */
  .gr-grid{
    position:relative; z-index:1;
    display:grid; gap:1rem;
    grid-template-columns:1fr;          /* móvil */
  }
  @media (min-width:56.25em){          /* ≥900px: 2 columnas */
    .gr-grid{ grid-template-columns:repeat(2, 1fr); }
  }

  .gr-card{
    background:linear-gradient(180deg, rgba(9,16,32,.86), rgba(9,16,32,.92));
    border:1px solid var(--border-light);
    border-radius:1.1rem;
    padding:1rem 1rem 1.15rem;
    box-shadow:0 .8rem 1.6rem var(--shadow-deep), inset 0 .02rem .35rem rgba(255,255,255,.04);
    color:var(--text-light);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  }

  .gr-title{
    margin:0 0 .6rem;
    font-weight:800; letter-spacing:.25px;
    font-size:1.06rem; color:#f1f5f9;
    display:flex; align-items:center; gap:.5rem;
  }
  .gr-title::before{
    content:""; width:.5rem; height:.5rem; border-radius:999rem;
    background:var(--accent);
    box-shadow:0 0 .55rem var(--accent-shadow);
  }

  .chart{
    width:100%;
    height:clamp(16rem, 42vw, 24rem);   /* responde al ancho */
  }

  /* ===== Botones de utilidad (si existieran) ===== */
  .gr-actions{
    display:flex; gap:.6rem; flex-wrap:wrap; margin:.4rem 0 0 auto;
  }
  .gr-btn{
    appearance:none; border:1px solid var(--border-light);
    background:var(--accent); color:#fff; font-weight:800; font-size:.95rem;
    height:2.6rem; padding:0 1rem; border-radius:999rem; cursor:pointer;
    box-shadow:0 .8rem 1.6rem var(--accent-shadow), inset 0 -.18rem .55rem rgba(0,0,0,.18);
    transition: transform .12s ease, filter .15s ease;
  }
  .gr-btn:hover{ transform:translateY(-1px); filter:saturate(1.05); }
  .gr-btn--ghost{ background:#374151; }
  .gr-btn--ok{ background:var(--accent-2); }

  @media (prefers-reduced-motion: reduce){
    .gr-field, .gr-btn{ transition:none !important; }
  }
</style>
{% endblock %}



{% block page_banner %}
  <div class="admin-bar">Gráficas (BETA)</div>
{% endblock %}

{% block content %}
<section class="gr-wrap">
  <div class="gr-filtros">
    <label class="gr-field">
      <select id="f-sede">
        <option value="">Todas las sedes</option>
      </select>
    </label>
    <label class="gr-field">
      <select id="f-grado" disabled>
        <option value="">Todos los grados</option>
      </select>
    </label>
    <label class="gr-field">
      <select id="f-grupo" disabled>
        <option value="">Todos los grupos</option>
      </select>
    </label>
  </div>

  <div class="gr-grid">
    <article class="gr-card">
      <h3 class="gr-title">Estudiantes activos por sede</h3>
      <div id="chart-activos-sede" class="chart"></div>
    </article>

    <article class="gr-card">
      <h3 class="gr-title">Reprobados por asignatura</h3>
      <div id="chart-reprobados" class="chart"></div>
    </article>
  </div>
</section>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  {# Resolver URLs de los endpoints #}
  {% url 'api_sedes'                 as api_sedes_url %}
  {% url 'api_grados_por_sede'       as api_grados_url %}
  {% url 'api_grupos_por_sede_grado' as api_grupos_url %}
  {% url 'api_metrics_activos'       as api_activos_url %}
  {% url 'api_metrics_histograma'    as api_hist_url %}

  <script>
    window.GR_URLS = {
      api_sedes: "{{ api_sedes_url|escapejs }}",
      api_grados_por_sede: "{{ api_grados_url|escapejs }}",
      api_grupos_por_sede_grado: "{{ api_grupos_url|escapejs }}",
      api_metrics_activos: "{{ api_activos_url|escapejs }}",
      api_metrics_histograma: "{{ api_hist_url|escapejs }}"
    };
  </script>

  <script src="{% static 'core/js/graficas_reportes.js' %}"></script>
{% endblock %}
