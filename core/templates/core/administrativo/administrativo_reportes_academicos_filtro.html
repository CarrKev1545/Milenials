{% extends "core/base_dashboard_administrativo.html" %} 
{% load static %}

{% block title %}Reportes académicos — Filtros{% endblock %}

{% block extra_css %}
<style>
  /* ===== Escala base rem + ajustes fluidos por breakpoint ===== */
  :root { font-size: 16px; } /* 1rem = 16px */
  @media (max-width: 75em) { :root { font-size: 15px; } } /* ~1200px */
  @media (max-width: 62em) { :root { font-size: 14px; } } /* ~992px  */
  @media (max-width: 48em) { :root { font-size: 13px; } } /* ~768px  */
  @media (max-width: 36em) { :root { font-size: 12px; } } /* ~576px  */

  .page-title{
    position: sticky; top: var(--navbar-height, 3.5rem); z-index: 40;
    background: var(--accent); color: #fff; font-weight: 800; letter-spacing: .2px;
    text-align: center; padding: 0.625rem 0.75rem; 
    box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,.35);
  }

  .rg{width:100%;max-width:73.75rem;margin:0 auto;padding:0 1.25rem}
  .rg-wrap{position:relative;margin-top:0.875rem}
  .rg-wrap::before{
    content:"";position:absolute;inset:-1.125rem -1.375rem;border-radius:1.125rem;
    background:
      radial-gradient(140% 160% at 10% 0%, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(135deg, rgba(22,22,24,.88) 0%, rgba(16,16,18,.86) 100%);
    border:1px solid rgba(255,255,255,.10); backdrop-filter: blur(0.375rem) saturate(115%);
    box-shadow:0 1.375rem 2.75rem rgba(0,0,0,.50); z-index:0;
  }

  .rg-inner{position:relative;z-index:1;padding:1.75rem 1.5rem 1.5rem}

  .rg-badge{
    width:23.125rem; max-width:90vw; margin:0 auto; margin-top:-1.375rem; background:#0c0c0c; border-radius:1rem;
    box-shadow:0 1rem 1.875rem rgba(0,0,0,.55), inset 0 -0.5rem 1.375rem rgba(0,0,0,.22);
    display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1.125rem 1rem 0.75rem;
  }
  .rg-badge i{font-size:5.125rem;color:#fff;filter:drop-shadow(0 0.625rem 1.875rem rgba(0,0,0,.6))}
  .rg-chip{margin-top:0.75rem;background:var(--accent);color:#fff;padding:0.375rem 1.125rem;border-radius:999rem;font-weight:800;letter-spacing:.2px}

  .rg-grid{margin-top:1.125rem;display:grid;grid-template-columns:1fr 1fr;gap:0.875rem 1.25rem;align-items:center}
  .rg-field{
    position:relative;display:flex;align-items:center;gap:0.875rem;
    padding:0.75rem 0.875rem 0.75rem 3rem;border-radius:0.75rem;background:#f3f3f3;
    border:1px solid rgba(0,0,0,.06);box-shadow:0 0.625rem 1.25rem rgba(0,0,0,.22);width:100%;
  }
  .rg-field select{appearance:none;width:100%;border:none;outline:none;background:transparent;color:#111;font-weight:600}
  .rg-ico{position:absolute;left:0.875rem;top:50%;transform:translateY(-50%);width:1.625rem;display:grid;place-items:center;color:#111;opacity:.95}
  .rg-caret{position:absolute;right:0.625rem;top:50%;transform:translateY(-50%);color:#111;opacity:.85}

  .rg-actions{margin-top:1.125rem;display:flex;gap:0.875rem;justify-content:center;flex-wrap:wrap}
  .rg-btn{
    height:3rem;min-width:11.25rem;border-radius:0.75rem;border:none;padding:0 1.125rem;
    color:#fff;font-weight:800;letter-spacing:.3px;cursor:pointer;
    transition:transform .15s ease, filter .15s ease;
  }
  .rg-btn:hover{transform:translateY(-0.0625rem);filter:saturate(110%)}
  .rg-btn--primary{background:var(--accent);box-shadow:0 0.75rem 1.375rem rgba(156,15,16,.38)}
  .rg-btn--ghost{background:#b51415}
  .disabled{opacity:.55;pointer-events:none}

  @media (max-width: 63.75em){ /* ~1020px */
    .rg-grid{ grid-template-columns:1fr; }
  }
</style>
{% endblock %}

{% block content %}
  <div class="page-title">Reportes académicos</div>

  <main class="main" role="main">
    <section class="rg" aria-label="Filtros por grupo">
      <div class="rg-wrap">
        <div class="rg-inner">
          <div class="rg-badge" aria-hidden="true">
            <i class="fa-solid fa-file-lines"></i>
            <div class="rg-chip">POR GRUPO</div>
          </div>

          <form id="form-reporte" class="rg-grid" onsubmit="return false" aria-describedby="ayuda-filtros">
            <p id="ayuda-filtros" class="sr-only">Seleccione sede, grado, grupo y periodo para consultar los reportes académicos por grupo.</p>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-school"></i></span>
              <select id="sede" name="sede_id" required aria-label="Sede">
                <option value="">Seleccione la sede</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-sitemap"></i></span>
              <select id="grado" name="grado_id" required disabled aria-label="Grado">
                <option value="">Seleccione el grado</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-people-roof"></i></span>
              <select id="grupo" name="grupo_id" required disabled aria-label="Grupo">
                <option value="">Seleccione el grupo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>

            <label class="rg-field">
              <span class="rg-ico"><i class="fa-solid fa-calendar-days"></i></span>
              <select id="periodo" name="periodo_id" required disabled aria-label="Periodo">
                <option value="">Seleccione periodo</option>
              </select>
              <span class="rg-caret"><i class="fa-solid fa-chevron-down"></i></span>
            </label>
          </form>

          <div class="rg-actions">
            <button id="btn-buscar" class="rg-btn rg-btn--primary disabled" type="button" aria-disabled="true">
              <i class="fa-solid fa-magnifying-glass"></i> Buscar
            </button>
            <button id="btn-limpiar" class="rg-btn rg-btn--ghost" type="button">
              <i class="fa-solid fa-eraser"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>
{% endblock %}

{% block extra_js %}
<script>
  // Helpers
  const $ = s => document.querySelector(s);
  const $sede = $('#sede');
  const $grado = $('#grado');
  const $grupo = $('#grupo');
  const $periodo = $('#periodo');
  const $buscar = $('#btn-buscar');

  const disable = ($el, yes = true) => { $el.disabled = yes; if (yes) $el.value = ''; };
  const enableBuscarIfReady = () => {
    const ok = $sede.value && $grado.value && $grupo.value && $periodo.value;
    $buscar.classList.toggle('disabled', !ok);
    $buscar.setAttribute('aria-disabled', String(!ok));
  };

  // Normaliza items que vienen como tuplas [id, nombre] o como objetos {id, nombre}
  const addOptions = (selectEl, items, placeholderText) => {
    if (placeholderText) {
      selectEl.innerHTML = `<option value="">${placeholderText}</option>`;
    }
    (items || []).forEach(it => {
      // it puede ser [id, nombre] o {id, nombre}
      const id  = Array.isArray(it) ? it[0] : (it.id ?? it.value ?? "");
      const nom = Array.isArray(it) ? it[1] : (it.nombre ?? it.text ?? "");
      if (id !== undefined && nom !== undefined) {
        const o = document.createElement('option');
        o.value = id;
        o.textContent = nom;
        selectEl.appendChild(o);
      }
    });
  };

  // sedes
  fetch("{% url 'api_admin_sedes' %}")
    .then(r => r.json())
    .then(({ sedes = [] }) => {
      addOptions($sede, sedes, "Seleccione la sede");
    })
    .catch(console.error);

  // sede -> grados + periodos
  $sede.addEventListener('change', async () => {
    disable($grado); disable($grupo); disable($periodo);
    addOptions($grado, [], "Seleccione el grado");
    addOptions($grupo, [], "Seleccione el grupo");
    addOptions($periodo, [], "Seleccione periodo");

    if (!$sede.value) { enableBuscarIfReady(); return; }

    try {
      const g = await fetch("{% url 'api_admin_grados_por_sede' %}?sede_id=" + encodeURIComponent($sede.value)).then(r => r.json());
      addOptions($grado, g.grados || [], "Seleccione el grado");
      disable($grado, false);

      const p = await fetch("{% url 'api_admin_periodos_abiertos' %}").then(r => r.json());
      // periodos ya vienen como objetos {id, nombre}
      addOptions($periodo, p.periodos || [], "Seleccione periodo");
      disable($periodo, false);
    } catch (e) {
      console.error(e);
    }
    enableBuscarIfReady();
  });

  // grado -> grupos
  $grado.addEventListener('change', async () => {
    disable($grupo);
    addOptions($grupo, [], "Seleccione el grupo");
    if (!$grado.value || !$sede.value) { enableBuscarIfReady(); return; }

    try {
      const url = "{% url 'api_admin_grupos_por_sede_grado' %}?sede_id=" + encodeURIComponent($sede.value) + "&grado_id=" + encodeURIComponent($grado.value);
      const r = await fetch(url).then(r => r.json());
      addOptions($grupo, r.grupos || [], "Seleccione el grupo");
      disable($grupo, false);
    } catch (e) {
      console.error(e);
    }
    enableBuscarIfReady();
  });

  $periodo.addEventListener('change', enableBuscarIfReady);
  $grupo.addEventListener('change', enableBuscarIfReady);

  // Buscar -> por_grupo
  $buscar.addEventListener('click', () => {
    if ($buscar.classList.contains('disabled')) return;
    const params = new URLSearchParams(new FormData(document.getElementById('form-reporte')));
    window.location.href = "{% url 'administrativo_reportes_academicos_por_grupo' %}?" + params.toString();
  });

  // Limpiar
  document.getElementById('btn-limpiar').addEventListener('click', () => {
    document.getElementById('form-reporte').reset();
    // Restablece opciones a solo placeholder y deshabilita
    addOptions($grado,  [], "Seleccione el grado");  disable($grado,  true);
    addOptions($grupo,  [], "Seleccione el grupo");  disable($grupo,  true);
    addOptions($periodo,[], "Seleccione periodo");   disable($periodo,true);
    enableBuscarIfReady();
  });
</script>
{% endblock %}
