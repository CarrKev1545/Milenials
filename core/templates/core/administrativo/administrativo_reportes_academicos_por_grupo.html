{% extends "core/base_dashboard_administrativo.html" %}
{% load static %}

{% block title %}Reportes académicos — Por grupo{% endblock %}

{% block extra_css %}
<style>
  /* ===== Escala base rem + ajustes fluidos ===== */
  :root { font-size: 16px; } /* 1rem = 16px */
  @media (max-width: 75em) { :root { font-size: 15px; } } /* ~1200px */
  @media (max-width: 62em) { :root { font-size: 14px; } } /* ~992px  */
  @media (max-width: 48em) { :root { font-size: 13px; } } /* ~768px  */
  @media (max-width: 36em) { :root { font-size: 12px; } } /* ~576px  */

  .page-title{
    position:sticky; top:var(--navbar-height); z-index:40;
    background:var(--accent); color:#fff; font-weight:800; letter-spacing:.0125em;
    text-align:center; padding:.625rem .75rem; box-shadow:0 .25rem .75rem rgba(0,0,0,.35);
  }

  .rg{width:100%; max-width:73.75rem; margin:0 auto; padding:0 1.25rem;} /* 1180px, 20px */
  .toolbar{
    display:flex; gap:.5rem; align-items:center; justify-content:space-between; margin-top:.875rem;
  }

  .btn{
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.625rem .875rem; border-radius:.75rem; border:1px solid #e5e9f2;
    background:#fff; box-shadow:0 .25rem .625rem rgba(0,0,0,.06);
    font-weight:700; letter-spacing:.0125em; cursor:pointer; text-decoration:none; color:#0f172a;
    transition: transform .12s ease;
  }
  .btn:hover{ transform: translateY(-.0625rem); }

  .table-card{
    background:#fff; border-radius:1rem; box-shadow:0 .75rem 1.875rem rgba(0,0,0,.18);
    border:1px solid #e5e9f2; overflow:hidden; margin-top:.75rem;
  }

  .table-responsive{ width:100%; overflow-x:auto; }
  table.tabla{ width:100%; border-collapse:separate; border-spacing:0; table-layout:auto; }

  .tabla thead th{
    background:#0f172a; color:#fff; font-weight:900; text-align:left;
    padding:.75rem .875rem; letter-spacing:.0125em; white-space:nowrap;
    position:sticky; top:0; z-index:10; /* encabezado siempre encima */
  }

  .tabla tbody td{
    padding:.75rem .875rem; border-top:1px solid #eef2f6; background:#fff;
    vertical-align:middle; overflow:visible;
  }
  .tabla tbody tr:nth-child(odd) td{ background:#fbfdff; }

  .alum{ font-weight:800; letter-spacing:.0125em; display:flex; gap:.5rem; flex-wrap:wrap; min-width:0; }
  .doc{ opacity:.85; font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .empty{ padding:1.125rem; color:#334155; }

  /* Responsive */
  @media (max-width: 45em){ /* ~720px */
    .btn{ padding:.5rem .75rem; }
    .alum{ display:block; }
  }

  /* ====== AJUSTES FINOS ADICIONALES ====== */

  /* 1) Quitar iniciales/avatares */
  .avatar{ display:none !important; }

  /* 2) Nombres completos sin cortes (wrap). */
  .alum .name{
    white-space: normal;
    word-break: break-word;
    overflow: visible;
    min-width: 0;
    display: inline;
  }

  /* 3) Mantener primera columna sticky y por debajo del thead (sin solapar) */
  .tabla tbody tr td:first-child{
    position: sticky;
    left: 0;
    z-index: 3 !important;   /* por debajo del thead (z=10) */
    background: inherit;     /* respeta zebra */
    box-shadow: .0625rem 0 0 #e6ebf3; /* divisor vertical */
  }

  /* Bordes redondeados suaves en el primer registro para que no 'asome' bajo el header */
  .tabla tbody tr:first-child td:first-child{ border-top-left-radius:.5rem; }
</style>
{% endblock %}

{% block content %}
  <div class="page-title">Reportes académicos</div>

  <main class="main" role="main">
    <section class="rg" aria-label="Reportes por grupo">
      <div class="rg-wrap">
        <div class="rg-inner">

          <!-- Badge -->
          <div class="toolbar" style="justify-content:center; gap:.75rem; flex-wrap:wrap;">
            <span class="btn" style="pointer-events:none;"><i class="fa-solid fa-calendar-days"></i> <span id="chip-periodo"></span></span>
            <span class="btn" style="pointer-events:none;"><i class="fa-solid fa-building-columns"></i> <span id="chip-sede"></span></span>
            <span class="btn" style="pointer-events:none;"><i class="fa-solid fa-sitemap"></i> <span id="chip-grado"></span></span>
            <span class="btn" style="pointer-events:none;"><i class="fa-solid fa-people-roof"></i> <span id="chip-grupo"></span></span>
          </div>

          <!-- Acciones -->
          <div class="toolbar">
            <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
              <button id="btn-grupo-pdf" class="btn" style="background:linear-gradient(180deg,#ef4444,#c81e1e); color:#fff; border-color:transparent;">
                <i class="fa-solid fa-file-pdf"></i> Boletín del grupo (PDF)
              </button>
              <button id="btn-grupo-xls" class="btn" style="background:linear-gradient(180deg,#16a34a,#0f7a33); color:#fff; border-color:transparent;">
                <i class="fa-solid fa-file-excel"></i> Boletín del grupo (Excel)
              </button>
            </div>
            <a class="btn" href="{% url 'administrativo_reportes_academicos_filtro' %}">
              <i class="fa-solid fa-arrow-left"></i> Volver a filtros
            </a>
          </div>

          <!-- Tabla -->
          <div class="table-card">
            <div class="table-responsive">
              <table class="tabla" aria-label="Alumnos del grupo">
                <thead>
                  <tr>
                    <th>Estudiante</th>
                    <th>Documento</th>
                    <th>Boletín individual</th>
                  </tr>
                </thead>
                <tbody id="tbody-alumnos">
                  <tr><td class="empty" colspan="3">Cargando…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  /* === Endpoints (misma lógica) === */
  const ENDPOINTS = {
    grupo_pdf:  "/reportes/boletin/grupo/pdf",
    grupo_xlsx: "/reportes/boletin/grupo/excel",
    alum_pdf:   "/reportes/boletin/estudiante/pdf",
    alum_xlsx:  "/reportes/boletin/estudiante/excel",
  };

  /* Params */
  const qs = new URLSearchParams(location.search);
  const sede_id    = qs.get("sede_id");
  const grado_id   = qs.get("grado_id");
  const grupo_id   = qs.get("grupo_id");
  const periodo_id = qs.get("periodo_id");

  const $tbody = document.getElementById('tbody-alumnos');

  async function j(url){
    try { const r = await fetch(url, { headers:{'Accept':'application/json'} }); return await r.json(); }
    catch { return {}; }
  }

  // Chips superiores (usan tu API existente)
  (async()=>{
    const pj = await j("{% url 'api_admin_periodos_abiertos' %}");
    const per = (pj.periodos||[]).find(x=>String(x.id)===String(periodo_id));
    document.getElementById('chip-periodo').textContent = "Periodo: " + (per?.nombre || periodo_id);

    const sj = await j("{% url 'api_admin_sedes' %}");
    const sede = (sj.sedes||[]).find(x=>String(x.id)===String(sede_id));
    document.getElementById('chip-sede').textContent = "Sede: " + (sede?.nombre || sede_id);

    const gj = await j("{% url 'api_admin_grados_por_sede' %}?sede_id="+encodeURIComponent(sede_id));
    const grado = (gj.grados||[]).find(x=>String(x.id)===String(grado_id));
    document.getElementById('chip-grado').textContent = "Grado: " + (grado?.nombre || grado_id);

    const grj = await j("{% url 'api_admin_grupos_por_sede_grado' %}?sede_id="+encodeURIComponent(sede_id)+"&grado_id="+encodeURIComponent(grado_id));
    const grupo = (grj.grupos||[]).find(x=>String(x.id)===String(grupo_id));
    document.getElementById('chip-grupo').textContent = "Grupo: " + (grupo?.nombre || grupo_id);
  })();

  (async()=>{
    // Alumnos
    const r = await j("{% url 'api_admin_estudiantes_por_grupo' %}?grupo_id="+encodeURIComponent(grupo_id));
    const alumnos = r.estudiantes || [];
    if (!alumnos.length){
      $tbody.innerHTML = '<tr><td class="empty" colspan="3">No hay estudiantes en este grupo.</td></tr>';
      return;
    }
    $tbody.innerHTML = "";
    for (const a of alumnos){
      const nombreCompleto = `${(a.apellidos||"").toUpperCase()}${a.apellidos?', ':''}${(a.nombre||"").toUpperCase()}`.trim();

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="alum">
          <span class="name">${nombreCompleto}</span>
        </td>
        <td class="doc">${a.documento || ''}</td>
        <td>
          <div class="mini" style="display:inline-flex; gap:.5rem; flex-wrap:wrap;">
            <a target="_blank" class="btn" style="background:linear-gradient(180deg,#ef4444,#c81e1e); color:#fff; border-color:transparent;">
              <i class="fa-solid fa-file-pdf"></i> PDF
            </a>
            <a target="_blank" class="btn" style="background:linear-gradient(180deg,#16a34a,#0f7a33); color:#fff; border-color:transparent;">
              <i class="fa-solid fa-file-excel"></i> Excel
            </a>
          </div>
        </td>`;

      const [btnPDF, btnXLS] = tr.querySelectorAll('a');
      const params = `?estudiante_id=${encodeURIComponent(a.id)}&grupo_id=${encodeURIComponent(grupo_id)}&periodo_id=${encodeURIComponent(periodo_id)}`;
      btnPDF.href = ENDPOINTS.alum_pdf  + params;
      btnXLS.href = ENDPOINTS.alum_xlsx + params;

      $tbody.appendChild(tr);
    }

    // Botones grupales
    document.getElementById('btn-grupo-pdf')
      .addEventListener('click', ()=>window.open(ENDPOINTS.grupo_pdf+`?grupo_id=${encodeURIComponent(grupo_id)}&periodo_id=${encodeURIComponent(periodo_id)}`,'_blank'));
    document.getElementById('btn-grupo-xls')
      .addEventListener('click', ()=>window.open(ENDPOINTS.grupo_xlsx+`?grupo_id=${encodeURIComponent(grupo_id)}&periodo_id=${encodeURIComponent(periodo_id)}`,'_blank'));
  })();
</script>
{% endblock %}
